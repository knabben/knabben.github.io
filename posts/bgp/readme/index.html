<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Border Gateway Protocol (BGP) and Kubernetes | OPSSEC.in</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.112.7">
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.1cb140d8ba31d5b2f1114537dd04802a.css" rel="stylesheet">
    

    
      <link rel="stylesheet" href="/css/custom.css">
    

    
      
    

    
    
    <meta property="og:title" content="Border Gateway Protocol (BGP) and Kubernetes" />
<meta property="og:description" content="Automatic routing with BIRD" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://opssec.in/posts/bgp/readme/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-10T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-06-10T00:00:00+00:00" />
<meta itemprop="name" content="Border Gateway Protocol (BGP) and Kubernetes">
<meta itemprop="description" content="Automatic routing with BIRD"><meta itemprop="datePublished" content="2022-06-10T00:00:00+00:00" />
<meta itemprop="dateModified" content="2022-06-10T00:00:00+00:00" />
<meta itemprop="wordCount" content="2454">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Border Gateway Protocol (BGP) and Kubernetes"/>
<meta name="twitter:description" content="Automatic routing with BIRD"/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://opssec.in/" class="f3 fw2 hover-white no-underline white-90 dib">
       OPSSEC.in ☿
    </a>
    <div class="flex-l items-center">
      

      

      <ul class="pl0 mr3" style="color: white">
          <a style="text-decoration: none; color: white" href="https://md.opssec.in/winapi/init.html">win32 api</a>
      </ul >
      




<a href="https://twitter.com/ak_ndb" target="_blank" class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel="noopener" aria-label="follow on Twitter——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>




<a href="https://www.linkedin.com/in/amim/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


<a href="https://github.com/knabben/" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel="noopener" aria-label="follow on Github——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>







    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=https://opssec.in/posts/bgp/readme/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=https://opssec.in/posts/bgp/readme/&amp;text=Border%20Gateway%20Protocol%20%28BGP%29%20and%20Kubernetes" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://opssec.in/posts/bgp/readme/&amp;title=Border%20Gateway%20Protocol%20%28BGP%29%20and%20Kubernetes" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>


      <h1 class="f1 athelas mt3 mb1">Border Gateway Protocol (BGP) and Kubernetes</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2022-06-10T00:00:00Z">June 10, 2022</time>

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray w-l" style="width: 100%;"><h2 id="introduction">Introduction</h2>
<p>On this post I want to write a bit about Border Gateway Protocol, Calico and Kubernetes, in the examples
we are going to see an use case  with OpenBSD/openbgp and after Project Calico with BGP mode to illustrate
how this protocol can be used in the CNI to provide automatic routing across nodes.</p>
<p>After reading leave comments in the end and share the post. Nuff said.</p>
<h2 id="bgp-protocol">BGP protocol</h2>
<p>The RFC of BGP-4 is pretty clear in the abstract about the primary function of BGP [1] being
is to exchange network reachability information with other BGP systems.  This network reachability
information includes information on the list of Autonomous Systems (ASes) that reachability information traverses.</p>
<p>This information is sufficient for constructing a graph of AS connectivity for this reachability from which routing
loops may be pruned, and, at the AS level, some policy decisions may be enforced.</p>
<p>BGP-4 provides a set of mechanisms for supporting Classless Inter-Domain Routing (CIDR).  These mechanisms include
support for advertising a set of destinations as an IP prefix, and eliminating the concept of network &ldquo;class&rdquo; within BGP.
BGP-4 also introduces mechanisms that allow aggregation of routes, including aggregation of AS paths.</p>
<p>Meaning we can create automated routing across routers that can communicate with each other.</p>
<p>From the Wikipedia: An autonomous system (AS) is a collection of connected Internet Protocol routing prefixes under the control
of one or more network operators on behalf of a single administrative entity or domain, that presents a common and
clearly defined routing policy to the Internet.</p>
<p>The reason for this separation is the lack of scalability and routing policies if one entity only was created, for
this reason routers inside an AS can have their own protocol specifications. IGP route between routes, EGP route between
AS and BGP route among/between AS. ASN (numbers) are unique identifiers with 1-64511 being public ones.</p>
<p>There is no requirement for networks running BGP to have an IGP as well. Simple multihomed networks with two routers
run just fine without an IGP: a few static routes are all that’s needed, because all traffic goes to a
directly connected network, to the rest of the world, or to the other router. For larger networks, IGPs
are a fact of life. Your only choice for an EGP is BGP-4, but IGPs let you use any interior routing protocol
you desire. On a Cisco router, you have the following choices: RIP, IGRP, EIGRP, OSPF, and IS-IS.</p>
<p>About the procotol and accordingly with [2] BGP uses TCP on port 179 for communication between neighbors. This is unusual:
all other routing protocols either run directly on top of IP or use UDP.</p>
<p>This makes it possible to send broadcasts or multicasts to discover neighboring routers. When BGP neighbors establish
a TCP session, they start exchanging BGP information in the form of &ldquo;messages.&rdquo;</p>
<p>These messages can have a few formats, that we will analyze better later:</p>
<ul>
<li>Open - After a TCP connection is established, the first message sent by each side is an OPEN message, if the Open message is acceptable, a KEEPALICE message confirming the OPEn is sent back.</li>
<li>Update -  Are used to transfer routing information between BGP peers.  The information in the UPDATE message can be used to construct a graph that describes the relationships of the various Autonomous Systems.</li>
<li>Keepalive -  BGP does not use any TCP-based, keep-alive mechanism to determine if peers are reachable.  Instead, KEEPALIVE messages are exchanged between peers often enough not to cause the Hold Timer to expire.</li>
<li>Notification - A message is sent when an error condition is detected. The BGP connection is closed immediately after it is sent.</li>
</ul>
<p>Besides that BGP has Finite State Machine with Idle, Connect, Active, OpenSent, OpenConfirm, Established.</p>
<h2 id="openbgp-and-openbsd">OpenBGP and OpenBSD</h2>
<p>Enough theory, bootup your <code>install71.iso</code>, for this lab you will need 2 machines that can at least ping each other.</p>
<img src="/posts/bgp/images/diagram1.jpg" alt="" class="" style="width: 70%; ">

<table>
<thead>
<tr>
<th>Machine</th>
<th>IP address</th>
<th>ASN</th>
</tr>
</thead>
<tbody>
<tr>
<td>r1</td>
<td>10.191.254.108/16</td>
<td>65001</td>
</tr>
<tr>
<td>r2</td>
<td>10.191.254.203/16</td>
<td>65002</td>
</tr>
</tbody>
</table>
<p>The following <code>/etc/bgpd.conf</code> files from both OpenBSD routers</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># r1</span>
</span></span><span style="display:flex;"><span>ASN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;65001&#34;</span>
</span></span><span style="display:flex;"><span>AS $ASN
</span></span><span style="display:flex;"><span>router-id 10.191.245.108
</span></span><span style="display:flex;"><span>prefix-set networks <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        172.15.0.0/16
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>include <span style="color:#e6db74">&#34;/var/db/rpki-client/openbgpd&#34;</span>
</span></span><span style="display:flex;"><span>network prefix-set networks set large-community $ASN:1:1
</span></span><span style="display:flex;"><span>group <span style="color:#e6db74">&#34;upstreams&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        neighbor 10.191.254.203 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                remote-as <span style="color:#ae81ff">65002</span>
</span></span><span style="display:flex;"><span>                descr <span style="color:#e6db74">&#34;r2&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># r2</span>
</span></span><span style="display:flex;"><span>ASN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;65002&#34;</span>
</span></span><span style="display:flex;"><span>AS $ASN
</span></span><span style="display:flex;"><span>router-id 10.191.254.203
</span></span><span style="display:flex;"><span>prefix-set networks <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>prefix-set network <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    172.16.0.0/16
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>network prefix-set network set large-community $ASN:1:1
</span></span><span style="display:flex;"><span>group <span style="color:#e6db74">&#34;upstreams&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        neighbor 10.191.245.108 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                remote-as <span style="color:#ae81ff">65001</span>
</span></span><span style="display:flex;"><span>                descr <span style="color:#e6db74">&#34;r1&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Respectively we have as outside networks from the AS, 172.15.0.0/16 connected on R1 and 172.16.0.0/16 on R2,
as you can see there&rsquo;s the need to create groups and add neighbors, the protocol won&rsquo;t multicast to find the peers.</p>
<p>Start the services <code>/etc/rc.d/bgpd start</code> and check the routes added, you need to add the route to the outside network
on each end. 10.191.249.1 and 10.191.249.2 are the gateways for each network.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>r1&gt; route add -inet 172.15.0.0/16 10.191.249.1
</span></span><span style="display:flex;"><span>add net 172.15.0.0/16: gateway 10.191.249.1
</span></span><span style="display:flex;"><span>r1&gt; route -n show
</span></span><span style="display:flex;"><span>Routing tables
</span></span><span style="display:flex;"><span>Internet:
</span></span><span style="display:flex;"><span>Destination        Gateway            Flags   Refs      Use   Mtu  Prio Iface
</span></span><span style="display:flex;"><span>default            10.191.255.254     UGS        <span style="color:#ae81ff">6</span>    <span style="color:#ae81ff">18731</span>     -     <span style="color:#ae81ff">8</span> em0
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>172.16/16          10.191.254.203     UG         <span style="color:#ae81ff">0</span>        <span style="color:#ae81ff">0</span>     -    <span style="color:#ae81ff">48</span> em0
</span></span><span style="display:flex;"><span>172.15/16          10.191.249.1       UG         <span style="color:#ae81ff">0</span>        <span style="color:#ae81ff">0</span>     -    <span style="color:#ae81ff">48</span> em0
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>r2&gt; route add -inet 172.16.0.0/16 10.191.249.2
</span></span><span style="display:flex;"><span>add net 172.16.0.0/16: gateway 10.191.249.2
</span></span><span style="display:flex;"><span>r2&gt; route -n show
</span></span><span style="display:flex;"><span>Routing tables
</span></span><span style="display:flex;"><span>Destination        Gateway            Flags   Refs      Use   Mtu  Prio Iface
</span></span><span style="display:flex;"><span>default            10.191.255.254     UGS        <span style="color:#ae81ff">5</span>   <span style="color:#ae81ff">125326</span>     -     <span style="color:#ae81ff">8</span> em0
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>172.15/16          10.191.245.108     UG         <span style="color:#ae81ff">0</span>        <span style="color:#ae81ff">0</span>     -    <span style="color:#ae81ff">48</span> em0
</span></span><span style="display:flex;"><span>172.16/16          10.191.249.2      UGS        <span style="color:#ae81ff">0</span>        <span style="color:#ae81ff">0</span>     -     <span style="color:#ae81ff">8</span> em0
</span></span><span style="display:flex;"><span>r2&gt; bgpctl show rib neighbor <span style="color:#e6db74">&#34;r1&#34;</span> in
</span></span><span style="display:flex;"><span>flags: * <span style="color:#f92672">=</span> Valid, &gt; <span style="color:#f92672">=</span> Selected, I <span style="color:#f92672">=</span> via IBGP, A <span style="color:#f92672">=</span> Announced,
</span></span><span style="display:flex;"><span>       S <span style="color:#f92672">=</span> Stale, E <span style="color:#f92672">=</span> Error
</span></span><span style="display:flex;"><span>origin validation state: N <span style="color:#f92672">=</span> not-found, V <span style="color:#f92672">=</span> valid, ! <span style="color:#f92672">=</span> invalid
</span></span><span style="display:flex;"><span>origin: i <span style="color:#f92672">=</span> IGP, e <span style="color:#f92672">=</span> EGP, ? <span style="color:#f92672">=</span> Incomplete
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flags ovs destination          gateway          lpref   med aspath origin
</span></span><span style="display:flex;"><span>*       N 172.15.0.0/16        10.191.245.108    <span style="color:#ae81ff">100</span>     <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">65001</span> i
</span></span></code></pre></div><p>That&rsquo;s great both hosts added the routes, and you can see the messages been exchanged from this wireshark diagram, basically
r2 started a connection and the daemon on r1 wasn&rsquo;t running (that&rsquo;s why it receive a RST/ACK), a few seconds later r1
started the daemon after fixing the configuration file, the first PSH is an Open message from r1, the message is
acked and a keep alive was received.</p>
<img src="/posts/bgp/images/wireshark1.png" alt="" class="" style="width: 100%; ">

<p>The UPDATES are for route exchange, you can see the second UPDATE decoded here, r2 exchange with AS_PATH attribute 65002,
NEXT_HOP being it&rsquo;s IP. The RFC has more details of these properties:</p>
<img src="/posts/bgp/images/wireshark2.png" alt="" class="" style="width: 60%; ">

<h2 id="calico-cni-and-bgp-mode">Calico CNI and BGP mode</h2>
<p>What about Kubernetes? Where does BGP is used? Well, it&rsquo;s possible to configure BGP (Border Gateway Protocol) between
Calico nodes or peering with network infrastructure to distribute routing information. When BGP is enabled, Calico’s
default behavior is to create a full-mesh of internal BGP (iBGP) connections where each node peers with each other.</p>
<p>This allows Calico to operate over any L2 network, whether public cloud or private cloud, or, if IPIP is configured,
to operate as an overlay over any network that does not block IPIP traffic. Calico does not use BGP for VXLAN overlays.
[4] And for this propose no encapsulation will be used.</p>
<p>Too much? not yet&hellip; Josh explains [5] on this video the modes and encapsulation of Calico. Some other good resources
includes [6], the entire series <code>Understanding Kubernetes Networking</code> is worth. More than 4 hours of free content in the
Internet move your lazy ass!</p>
<p>How the routing normally works for non BGP CNIs? Nodes have a podCIDR and the CNI can use <code>github.com/vishvananda/netlink</code>
libraries like this to manage the routing based on these CRDs fields. What is normally achieved in an agent running on
a daemonset.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Node</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podCIDR</span>: <span style="color:#ae81ff">100.10.1.0</span><span style="color:#ae81ff">/24</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podCIDRs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">100.10.1.0</span><span style="color:#ae81ff">/24</span>
</span></span></code></pre></div><p>A lot of other projects allow you to do these connections including FRRouting and BIRD, being the second used
by Calico in the agent. Make sure you are configuring bgp and BIRD connection, in the example we are using IP in IP
as an encapsulation.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#e6db74">`</span>curl https://projectcalico.docs.tigera.io/manifests/calico.yaml -O<span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Use Kubernetes API as the backing datastore.</span>
</span></span><span style="display:flex;"><span>- name: DATASTORE_TYPE
</span></span><span style="display:flex;"><span>  value: <span style="color:#e6db74">&#34;kubernetes&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Choose the backend to use.</span>
</span></span><span style="display:flex;"><span>- name: CALICO_NETWORKING_BACKEND
</span></span><span style="display:flex;"><span>  value: <span style="color:#e6db74">&#34;bird&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Cluster type to identify the deployment type</span>
</span></span><span style="display:flex;"><span>- name: CLUSTER_TYPE
</span></span><span style="display:flex;"><span>  value: <span style="color:#e6db74">&#34;k8s,bgp&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Enable IPIP</span>
</span></span><span style="display:flex;"><span>- name: CALICO_IPV4POOL_IPIP
</span></span><span style="display:flex;"><span>  value: <span style="color:#e6db74">&#34;Always&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Enable or Disable VXLAN on the default IP pool.</span>
</span></span><span style="display:flex;"><span>- name: CALICO_IPV4POOL_VXLAN
</span></span><span style="display:flex;"><span>  value: <span style="color:#e6db74">&#34;Never&#34;</span>
</span></span></code></pre></div><h3 id="debugging-routes">Debugging routes</h3>
<p>On this new scenario we have 3 nodes, in the IPPool range of 10.244.0.0/16 split as follow:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>❯ calicoctl ipam check
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Found <span style="color:#ae81ff">4</span> IPAM blocks.
</span></span><span style="display:flex;"><span> IPAM block 10.244.110.128/26 affinity<span style="color:#f92672">=</span>host:kind-worker2:
</span></span><span style="display:flex;"><span> IPAM block 10.244.162.128/26 affinity<span style="color:#f92672">=</span>host:kind-worker:
</span></span><span style="display:flex;"><span> IPAM block 10.244.195.192/26 affinity<span style="color:#f92672">=</span>host:kind-worker3:
</span></span><span style="display:flex;"><span> IPAM block 10.244.82.0/26 affinity<span style="color:#f92672">=</span>host:kind-control-plane:
</span></span><span style="display:flex;"><span>IPAM blocks record <span style="color:#ae81ff">8</span> allocations.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Loading all IPAM pools...
</span></span><span style="display:flex;"><span>  10.244.0.0/16
</span></span><span style="display:flex;"><span>Found <span style="color:#ae81ff">1</span> active IP pools.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>❯ calicoctl ipam show
</span></span><span style="display:flex;"><span>+----------+---------------+-----------+------------+--------------+
</span></span><span style="display:flex;"><span>| GROUPING |     CIDR      | IPS TOTAL | IPS IN USE |   IPS FREE   |
</span></span><span style="display:flex;"><span>+----------+---------------+-----------+------------+--------------+
</span></span><span style="display:flex;"><span>| IP Pool  | 10.244.0.0/16 |     <span style="color:#ae81ff">65536</span> | <span style="color:#ae81ff">8</span> <span style="color:#f92672">(</span>0%<span style="color:#f92672">)</span>     | <span style="color:#ae81ff">65528</span> <span style="color:#f92672">(</span>100%<span style="color:#f92672">)</span> |
</span></span><span style="display:flex;"><span>+----------+---------------+-----------+------------+--------------+
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>❯ kubectl get nodes -o wide
</span></span><span style="display:flex;"><span>NAME                 STATUS   ROLES           AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE       KERNEL-VERSION                       CONTAINER-RUNTIME
</span></span><span style="display:flex;"><span>kind-control-plane   Ready    control-plane   8m15s   v1.24.0   172.18.0.5    &lt;none&gt;        Ubuntu 21.10   5.10.102.1-microsoft-standard-WSL2   containerd://1.6.4
</span></span><span style="display:flex;"><span>kind-worker          Ready    &lt;none&gt;          7m41s   v1.24.0   172.18.0.3    &lt;none&gt;        Ubuntu 21.10   5.10.102.1-microsoft-standard-WSL2   containerd://1.6.4
</span></span><span style="display:flex;"><span>kind-worker2         Ready    &lt;none&gt;          7m41s   v1.24.0   172.18.0.2    &lt;none&gt;        Ubuntu 21.10   5.10.102.1-microsoft-standard-WSL2   containerd://1.6.4
</span></span><span style="display:flex;"><span>kind-worker3         Ready    &lt;none&gt;          7m41s   v1.24.0   172.18.0.4    &lt;none&gt;        Ubuntu 21.10   5.10.102.1-microsoft-standard-WSL2   containerd://1.6.4
</span></span></code></pre></div><p>If we get the status of the node <code>kind-worker</code> 172.18.0.3, we can see the neighbors, listing the routes
we can get 10.244.82.0/16 via 172.18.0.5, that&rsquo;s the controlplane host as we see the tunl0 interface is used
meaning the traffic is being encapsulated, when l2bridge is active it would go via eth0 in the physical
interface. The same is true for the other ranges.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@kind-worker:/# calicoctl node status
</span></span><span style="display:flex;"><span>Calico process is running.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>IPv4 BGP status
</span></span><span style="display:flex;"><span>+--------------+-------------------+-------+----------+-------------+
</span></span><span style="display:flex;"><span>| PEER ADDRESS |     PEER TYPE     | STATE |  SINCE   |    INFO     |
</span></span><span style="display:flex;"><span>+--------------+-------------------+-------+----------+-------------+
</span></span><span style="display:flex;"><span>| 172.18.0.5   | node-to-node mesh | up    | 23:52:12 | Established |
</span></span><span style="display:flex;"><span>| 172.18.0.2   | node-to-node mesh | up    | 23:52:12 | Established |
</span></span><span style="display:flex;"><span>| 172.18.0.4   | node-to-node mesh | up    | 23:52:11 | Established |
</span></span><span style="display:flex;"><span>+--------------+-------------------+-------+----------+-------------+
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>IPv6 BGP status
</span></span><span style="display:flex;"><span>No IPv6 peers found.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@kind-worker:/# ip route
</span></span><span style="display:flex;"><span>default via 172.18.0.1 dev eth0
</span></span><span style="display:flex;"><span>10.244.82.0/26 via 172.18.0.5 dev tunl0 proto bird onlink
</span></span><span style="display:flex;"><span>10.244.110.128/26 via 172.18.0.2 dev tunl0 proto bird onlink
</span></span><span style="display:flex;"><span>blackhole 10.244.162.128/26 proto bird
</span></span><span style="display:flex;"><span>10.244.195.192/26 via 172.18.0.4 dev tunl0 proto bird onlink
</span></span><span style="display:flex;"><span>172.18.0.0/16 dev eth0 proto kernel scope link src 172.18.0.3
</span></span></code></pre></div><p>Running a pod on <code>kind-worker3</code> on 10.244.195.194, what is in (195.192) range and is given by the IPAM plugin,
will redirect the traffic to the node as the next hop, remember this is a container running in the node
(on another IP in the network namespace), as soon the node receives the packet it forward to the Pod
via <code>caliba2160f804b</code> interface.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt; kubectl get pods -o wide
</span></span><span style="display:flex;"><span>default              nginx3                                       1/1     Running   <span style="color:#ae81ff">0</span>          11s   10.244.195.194   kind-worker3         &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@kind-worker3:/# ip route
</span></span><span style="display:flex;"><span>10.244.82.0/26 via 172.18.0.5 dev tunl0 proto bird onlink
</span></span><span style="display:flex;"><span>10.244.110.128/26 via 172.18.0.2 dev tunl0 proto bird onlink
</span></span><span style="display:flex;"><span>10.244.162.128/26 via 172.18.0.3 dev tunl0 proto bird onlink
</span></span><span style="display:flex;"><span>10.244.195.194 dev <span style="color:#e6db74">`</span>caliba2160f804b<span style="color:#e6db74">`</span> scope link
</span></span></code></pre></div><p>If we check the agent BIRDipv4 configuration on <code>cat /etc/calico/confd/config/bird.cfg</code>, we can find the peers</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>router id 172.18.0.3;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># For peer /host/kind-control-plane/ip_addr_v4</span>
</span></span><span style="display:flex;"><span>protocol bgp Mesh_172_18_0_5 from bgp_template <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  neighbor 172.18.0.5 as 64512;
</span></span><span style="display:flex;"><span>  source address 172.18.0.3;  <span style="color:#75715e"># The local address we use for the TCP connection</span>
</span></span><span style="display:flex;"><span>  passive on; <span style="color:#75715e"># Mesh is unidirectional, peer will connect to us.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># For peer /host/kind-worker/ip_addr_v4</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Skipping ourselves (172.18.0.3)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># For peer /host/kind-worker2/ip_addr_v4</span>
</span></span><span style="display:flex;"><span>protocol bgp Mesh_172_18_0_2 from bgp_template <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  neighbor 172.18.0.2 as 64512;
</span></span><span style="display:flex;"><span>  source address 172.18.0.3;  <span style="color:#75715e"># The local address we use for the TCP connection</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># For peer /host/kind-worker3/ip_addr_v4</span>
</span></span><span style="display:flex;"><span>protocol bgp Mesh_172_18_0_4 from bgp_template <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  neighbor 172.18.0.4 as 64512;
</span></span><span style="display:flex;"><span>  source address 172.18.0.3;  <span style="color:#75715e"># The local address we use for the TCP connection</span>
</span></span><span style="display:flex;"><span>  passive on; <span style="color:#75715e"># Mesh is unidirectional, peer will connect to us.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>One last try, listening tshark from the <code>kind-worker3</code> we will delete the calico-node agent in the control-plane
node 172.18.0.5. A connection is kept across all nodes with the bird daemon on this port, and as soon the connection is closed
a new retry happens with the protocol OPEN and UPDATE messages.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@kind-worker3:/# lsof -i :179
</span></span><span style="display:flex;"><span>COMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
</span></span><span style="display:flex;"><span>bird    <span style="color:#ae81ff">12294</span> root    7u  IPv4 <span style="color:#ae81ff">351376</span>      0t0  TCP *:bgp <span style="color:#f92672">(</span>LISTEN<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>bird    <span style="color:#ae81ff">12294</span> root    8u  IPv4 <span style="color:#ae81ff">366653</span>      0t0  TCP kind-worker3:bgp-&gt;kind-control-plane.kind:58325 <span style="color:#f92672">(</span>ESTABLISHED<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>bird    <span style="color:#ae81ff">12294</span> root    9u  IPv4 <span style="color:#ae81ff">351408</span>      0t0  TCP kind-worker3:52953-&gt;kind-worker.kind:bgp <span style="color:#f92672">(</span>ESTABLISHED<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>bird    <span style="color:#ae81ff">12294</span> root   10u  IPv4 <span style="color:#ae81ff">351409</span>      0t0  TCP kind-worker3:35655-&gt;kind-worker2.kind:bgp <span style="color:#f92672">(</span>ESTABLISHED<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@kind-worker3:/# tshark -i any <span style="color:#e6db74">&#34;port 179&#34;</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">1</span> 0.000000000   172.18.0.5 ? 172.18.0.4   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">58325</span> ? <span style="color:#ae81ff">179</span> <span style="color:#f92672">[</span>FIN, ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">502</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">820590145</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">888352057</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">2</span> 0.000126600   172.18.0.4 ? 172.18.0.5   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">179</span> ? <span style="color:#ae81ff">58325</span> <span style="color:#f92672">[</span>FIN, ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">510</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">888379111</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">820590145</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">3</span> 0.000155500   172.18.0.5 ? 172.18.0.4   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">58325</span> ? <span style="color:#ae81ff">179</span> <span style="color:#f92672">[</span>ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">502</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">820590145</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">888379111</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">4</span> 7.368669600   172.18.0.5 ? 172.18.0.4   TCP <span style="color:#ae81ff">76</span> <span style="color:#ae81ff">48333</span> ? <span style="color:#ae81ff">179</span> <span style="color:#f92672">[</span>SYN<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">64240</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> MSS<span style="color:#f92672">=</span><span style="color:#ae81ff">1460</span> SACK_PERM<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">820597513</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> WS<span style="color:#f92672">=</span><span style="color:#ae81ff">128</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">5</span> 7.368690500   172.18.0.4 ? 172.18.0.5   TCP <span style="color:#ae81ff">76</span> <span style="color:#ae81ff">179</span> ? <span style="color:#ae81ff">48333</span> <span style="color:#f92672">[</span>SYN, ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">65160</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> MSS<span style="color:#f92672">=</span><span style="color:#ae81ff">1460</span> SACK_PERM<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">888386479</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">820597513</span> WS<span style="color:#f92672">=</span><span style="color:#ae81ff">128</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">6</span> 7.368718300   172.18.0.5 ? 172.18.0.4   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">48333</span> ? <span style="color:#ae81ff">179</span> <span style="color:#f92672">[</span>ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">64256</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">820597513</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">888386479</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">7</span> 7.368810900   172.18.0.4 ? 172.18.0.5   BGP <span style="color:#ae81ff">131</span> OPEN Message
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">8</span> 7.368830600   172.18.0.5 ? 172.18.0.4   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">48333</span> ? <span style="color:#ae81ff">179</span> <span style="color:#f92672">[</span>ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">64256</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">820597513</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">888386479</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">9</span> 7.368979900   172.18.0.5 ? 172.18.0.4   BGP <span style="color:#ae81ff">131</span> OPEN Message
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">10</span> 7.368987300   172.18.0.4 ? 172.18.0.5   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">179</span> ? <span style="color:#ae81ff">48333</span> <span style="color:#f92672">[</span>ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">65280</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">888386480</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">820597514</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">11</span> 7.369079500   172.18.0.4 ? 172.18.0.5   BGP <span style="color:#ae81ff">87</span> KEEPALIVE Message
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">12</span> 7.369096000   172.18.0.5 ? 172.18.0.4   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">48333</span> ? <span style="color:#ae81ff">179</span> <span style="color:#f92672">[</span>ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">83</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">64256</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">820597514</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">888386480</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">13</span> 7.369186800   172.18.0.5 ? 172.18.0.4   BGP <span style="color:#ae81ff">87</span> KEEPALIVE Message
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">14</span> 7.369193000   172.18.0.4 ? 172.18.0.5   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">179</span> ? <span style="color:#ae81ff">48333</span> <span style="color:#f92672">[</span>ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">83</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">83</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">65280</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">888386480</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">820597514</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">15</span> 7.369343300   172.18.0.4 ? 172.18.0.5   BGP <span style="color:#ae81ff">121</span> UPDATE Message
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">16</span> 7.369366400   172.18.0.5 ? 172.18.0.4   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">48333</span> ? <span style="color:#ae81ff">179</span> <span style="color:#f92672">[</span>ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">83</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">136</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">64256</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">820597514</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">888386480</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">17</span> 7.369381600   172.18.0.4 ? 172.18.0.5   BGP <span style="color:#ae81ff">91</span> UPDATE Message
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">18</span> 7.369393900   172.18.0.5 ? 172.18.0.4   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">48333</span> ? <span style="color:#ae81ff">179</span> <span style="color:#f92672">[</span>ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">83</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">159</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">64256</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">820597514</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">888386480</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">19</span> 8.370730900   172.18.0.5 ? 172.18.0.4   BGP <span style="color:#ae81ff">121</span> UPDATE Message
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">20</span> 8.370766100   172.18.0.4 ? 172.18.0.5   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">179</span> ? <span style="color:#ae81ff">48333</span> <span style="color:#f92672">[</span>ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">159</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">136</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">65280</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">888387481</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">820598515</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">21</span> 8.370781900   172.18.0.5 ? 172.18.0.4   BGP <span style="color:#ae81ff">91</span> UPDATE Message
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">22</span> 8.370785500   172.18.0.4 ? 172.18.0.5   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">179</span> ? <span style="color:#ae81ff">48333</span> <span style="color:#f92672">[</span>ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">159</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">159</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">65280</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">888387481</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">820598515</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">23</span> 30.522048400   172.18.0.2 ? 172.18.0.4   BGP <span style="color:#ae81ff">87</span> KEEPALIVE Message
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">24</span> 30.522091300   172.18.0.4 ? 172.18.0.2   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">35655</span> ? <span style="color:#ae81ff">179</span> <span style="color:#f92672">[</span>ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">502</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">2977307332</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">3831078776</span>
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>And why should I care? Routing is fun and the next time another social media site [7] is shutdown by route
withdraws you can at least understand the post-mortem. Go get it!</p>
<h2 id="listening">Listening</h2>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/RT-1DU33xIk" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<h2 id="references">References</h2>
<p>[1] <a href="https://www.rfc-editor.org/rfc/rfc4271">https://www.rfc-editor.org/rfc/rfc4271</a></p>
<p>[2] <a href="https://www.amazon.com/BGP-Iljitsch-Van-Beijnum/dp/0596002548">https://www.amazon.com/BGP-Iljitsch-Van-Beijnum/dp/0596002548</a></p>
<p>[3] <a href="https://man.openbsd.org/bgpctl">https://man.openbsd.org/bgpctl</a></p>
<p>[4] <a href="https://projectcalico.docs.tigera.io/networking/bgp">https://projectcalico.docs.tigera.io/networking/bgp</a></p>
<p>[5] <a href="https://www.youtube.com/watch?v=MpbIZ1SmEkU">https://www.youtube.com/watch?v=MpbIZ1SmEkU</a></p>
<p>[6] <a href="https://www.youtube.com/watch?v=vOo__3GqyxM">https://www.youtube.com/watch?v=vOo__3GqyxM</a></p>
<p>[7] <a href="https://blog.cloudflare.com/october-2021-facebook-outage/">https://blog.cloudflare.com/october-2021-facebook-outage/</a></p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
        <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "blog-ak" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <script type="text/javascript" async
        src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
 MathJax.Hub.Config({
   tex2jax: {
     inlineMath: [['$','$'], ['\\(','\\)']],
     displayMath: [['$$','$$']],
     processEscapes: true,
     processEnvironments: true,
     skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
     TeX: { equationNumbers: { autoNumber: "AMS" },
            extensions: ["AMSmath.js", "AMSsymbols.js"] }
   }
 });
 MathJax.Hub.Queue(function() {
   
   
   
   var all = MathJax.Hub.getAllJax(), i;
   for(i = 0; i < all.length; i += 1) {
     all[i].SourceElement().parentNode.className += ' has-jax';
   }
 });

 MathJax.Hub.Config({
   
   TeX: { equationNumbers: { autoNumber: "AMS" } }
 });
</script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-46699622-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<footer class="bg-near-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://opssec.in/" >
    &copy; 2023 - Amim Knabben
  </a>
    <div>




<a href="https://twitter.com/ak_ndb" target="_blank" class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel="noopener" aria-label="follow on Twitter——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>




<a href="https://www.linkedin.com/in/amim/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


<a href="https://github.com/knabben/" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel="noopener" aria-label="follow on Github——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>






</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
