<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>AK  | Gossip networks</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.54.0" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.e08a958ae3e530145318b6373195c765.css" rel="stylesheet">
    

    

    
      
    

    

    <meta property="og:title" content="Gossip networks" />
<meta property="og:description" content="Introduction This is based on Sawtooth 1.0.5 source code for Gossip and static peering.
%load_ext autoreload %autoreload 2 import logging logger = logging.getLogger() logger.setLevel(logging.DEBUG) logging.info(&#34;Starting&#34;) from sawtooth_validator.networking.handlers import PingHandler from sawtooth_validator.journal.responder import ResponderBlockResponseHandler from sawtooth_validator.journal.responder import BlockResponderHandler from sawtooth_validator.state.settings_cache import SettingsCache from sawtooth_validator.gossip.gossip_handlers import PeerRegisterHandler from sawtooth_validator.networking.handlers import ConnectHandler from sawtooth_validator.server.keys import load_identity_signer from sawtooth_validator.concurrent.threadpool import InstrumentedThreadPoolExecutor from sawtooth_validator.networking.handlers import AuthorizationTrustRequestHandler from sawtooth_validator.gossip.permission_verifier import PermissionVerifier from sawtooth_validator.journal.block_store import BlockStore from sawtooth_validator." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://knabben.github.io/posts/gossip/" />
<meta property="article:published_time" content="2019-11-11T02:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2019-11-11T02:00:00&#43;00:00"/>

<meta itemprop="name" content="Gossip networks">
<meta itemprop="description" content="Introduction This is based on Sawtooth 1.0.5 source code for Gossip and static peering.
%load_ext autoreload %autoreload 2 import logging logger = logging.getLogger() logger.setLevel(logging.DEBUG) logging.info(&#34;Starting&#34;) from sawtooth_validator.networking.handlers import PingHandler from sawtooth_validator.journal.responder import ResponderBlockResponseHandler from sawtooth_validator.journal.responder import BlockResponderHandler from sawtooth_validator.state.settings_cache import SettingsCache from sawtooth_validator.gossip.gossip_handlers import PeerRegisterHandler from sawtooth_validator.networking.handlers import ConnectHandler from sawtooth_validator.server.keys import load_identity_signer from sawtooth_validator.concurrent.threadpool import InstrumentedThreadPoolExecutor from sawtooth_validator.networking.handlers import AuthorizationTrustRequestHandler from sawtooth_validator.gossip.permission_verifier import PermissionVerifier from sawtooth_validator.journal.block_store import BlockStore from sawtooth_validator.">


<meta itemprop="datePublished" content="2019-11-11T02:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-11-11T02:00:00&#43;00:00" />
<meta itemprop="wordCount" content="296">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Gossip networks"/>
<meta name="twitter:description" content="Introduction This is based on Sawtooth 1.0.5 source code for Gossip and static peering.
%load_ext autoreload %autoreload 2 import logging logger = logging.getLogger() logger.setLevel(logging.DEBUG) logging.info(&#34;Starting&#34;) from sawtooth_validator.networking.handlers import PingHandler from sawtooth_validator.journal.responder import ResponderBlockResponseHandler from sawtooth_validator.journal.responder import BlockResponderHandler from sawtooth_validator.state.settings_cache import SettingsCache from sawtooth_validator.gossip.gossip_handlers import PeerRegisterHandler from sawtooth_validator.networking.handlers import ConnectHandler from sawtooth_validator.server.keys import load_identity_signer from sawtooth_validator.concurrent.threadpool import InstrumentedThreadPoolExecutor from sawtooth_validator.networking.handlers import AuthorizationTrustRequestHandler from sawtooth_validator.gossip.permission_verifier import PermissionVerifier from sawtooth_validator.journal.block_store import BlockStore from sawtooth_validator."/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="http://knabben.github.io/" class="f3 fw2 hover-white no-underline white-90 dib">
      AK
    </a>
    <div class="flex-l items-center">
      
      









    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  <article class="flex-l flex-wrap justify-between mw8 center ph3 ph0-l">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        POSTS
      </p>
      <h1 class="f1 athelas mb1">Gossip networks</h1>
      
      <time class="f6 mv4 dib tracked" datetime="2019-11-11T02:00:00Z">November 11, 2019</time>
    </header>

    <main class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><h2 id="introduction">Introduction</h2>

<p>This is based on Sawtooth 1.0.5 source code for Gossip and static peering.</p>

<img src="/posts/gossip/arch.png" alt="" class="" style="width: 70%; ">


<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">%</span>load_ext autoreload
<span style="color:#f92672">%</span>autoreload <span style="color:#ae81ff">2</span>

<span style="color:#f92672">import</span> logging
logger <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>getLogger()
logger<span style="color:#f92672">.</span>setLevel(logging<span style="color:#f92672">.</span>DEBUG)
logging<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;Starting&#34;</span>)

<span style="color:#f92672">from</span> sawtooth_validator.networking.handlers <span style="color:#f92672">import</span> PingHandler
<span style="color:#f92672">from</span> sawtooth_validator.journal.responder <span style="color:#f92672">import</span> ResponderBlockResponseHandler
<span style="color:#f92672">from</span> sawtooth_validator.journal.responder <span style="color:#f92672">import</span> BlockResponderHandler
<span style="color:#f92672">from</span> sawtooth_validator.state.settings_cache <span style="color:#f92672">import</span> SettingsCache
<span style="color:#f92672">from</span> sawtooth_validator.gossip.gossip_handlers <span style="color:#f92672">import</span> PeerRegisterHandler
<span style="color:#f92672">from</span> sawtooth_validator.networking.handlers <span style="color:#f92672">import</span> ConnectHandler
<span style="color:#f92672">from</span> sawtooth_validator.server.keys <span style="color:#f92672">import</span> load_identity_signer
<span style="color:#f92672">from</span> sawtooth_validator.concurrent.threadpool <span style="color:#f92672">import</span> InstrumentedThreadPoolExecutor
<span style="color:#f92672">from</span> sawtooth_validator.networking.handlers <span style="color:#f92672">import</span> AuthorizationTrustRequestHandler
<span style="color:#f92672">from</span> sawtooth_validator.gossip.permission_verifier <span style="color:#f92672">import</span> PermissionVerifier
<span style="color:#f92672">from</span> sawtooth_validator.journal.block_store <span style="color:#f92672">import</span> BlockStore

<span style="color:#f92672">from</span> sawtooth_validator.journal.completer <span style="color:#f92672">import</span> Completer
<span style="color:#f92672">from</span> sawtooth_validator.database.indexed_database <span style="color:#f92672">import</span> IndexedDatabase
<span style="color:#f92672">from</span> sawtooth_validator.journal.responder <span style="color:#f92672">import</span> Responder

<span style="color:#f92672">from</span> sawtooth_validator.protobuf <span style="color:#f92672">import</span> block_pb2
<span style="color:#f92672">from</span> sawtooth_validator.protobuf <span style="color:#f92672">import</span> validator_pb2
<span style="color:#f92672">from</span> sawtooth_validator.networking.dispatch <span style="color:#f92672">import</span> Dispatcher
<span style="color:#f92672">from</span> sawtooth_validator.networking.interconnect <span style="color:#f92672">import</span> Interconnect
<span style="color:#f92672">from</span> sawtooth_validator.gossip.gossip <span style="color:#f92672">import</span> Gossip


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MockSettingsViewFactory</span>(object):
    <span style="color:#66d9ef">def</span> __init__(self):
        self<span style="color:#f92672">.</span>settings <span style="color:#f92672">=</span> {}

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_settings_view</span>(self, root):
        <span style="color:#66d9ef">return</span> MockSettingsView(self<span style="color:#f92672">.</span>settings)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_setting</span>(self, setting, value):
        self<span style="color:#f92672">.</span>settings[setting] <span style="color:#f92672">=</span> value


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MockSettingsView</span>(object):
    <span style="color:#66d9ef">def</span> __init__(self, settings):
        self<span style="color:#f92672">.</span>settings <span style="color:#f92672">=</span> settings

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_setting</span>(self, setting):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>settings<span style="color:#f92672">.</span>get(setting)

    
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Responder</span>():
    <span style="color:#66d9ef">def</span> __init__(self, completer):
        <span style="color:#66d9ef">pass</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_request</span>(self, block_id):
        <span style="color:#66d9ef">return</span> None

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_for_block</span>(self, block_id):
        <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Block</span>():
            <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_block</span>(self):
                <span style="color:#66d9ef">return</span> block_pb2<span style="color:#f92672">.</span>Block()
        <span style="color:#66d9ef">return</span> Block()

    
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validator_factory</span>(endpoint<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;tcp://127.0.0.1:8800&#34;</span>, initial_peer_endpoints<span style="color:#f92672">=</span>[]):
    <span style="color:#e6db74">&#34;&#34;&#34; Start a new validator and requests for Gossip entering &#34;&#34;&#34;</span>

    signer <span style="color:#f92672">=</span> load_identity_signer(
        key_dir<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/Users/amimknabben/.projects/sawtooth-core/keys&#34;</span>, 
        key_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;validator&#39;</span>
    )
    
    network_dispatcher <span style="color:#f92672">=</span> Dispatcher()
    network_service <span style="color:#f92672">=</span> Interconnect(
        endpoint,
        public_endpoint<span style="color:#f92672">=</span>endpoint, 
        dispatcher<span style="color:#f92672">=</span>network_dispatcher,
        signer<span style="color:#f92672">=</span>signer,
        authorize<span style="color:#f92672">=</span>True
    )
    gossip <span style="color:#f92672">=</span> Gossip(
        network_service, 
        SettingsCache(MockSettingsViewFactory()), 
        <span style="color:#66d9ef">lambda</span>: None,
        <span style="color:#66d9ef">lambda</span>: <span style="color:#e6db74">&#34;&#34;</span>,
        endpoint<span style="color:#f92672">=</span>endpoint, 
        initial_peer_endpoints<span style="color:#f92672">=</span>initial_peer_endpoints
    )
    gossip<span style="color:#f92672">.</span>start()
    
    network_thread_pool <span style="color:#f92672">=</span> InstrumentedThreadPoolExecutor(max_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Network&#39;</span>)
    
    <span style="color:#75715e"># Add handlers - threads incoming messages</span>
    network_dispatcher<span style="color:#f92672">.</span>add_handler(
        validator_pb2<span style="color:#f92672">.</span>Message<span style="color:#f92672">.</span>PING_REQUEST,
        PingHandler(network<span style="color:#f92672">=</span>network_service),
        network_thread_pool)

    network_dispatcher<span style="color:#f92672">.</span>add_handler(
        validator_pb2<span style="color:#f92672">.</span>Message<span style="color:#f92672">.</span>NETWORK_CONNECT,
        ConnectHandler(network<span style="color:#f92672">=</span>network_service),
        network_thread_pool)

    network_dispatcher<span style="color:#f92672">.</span>add_handler(
        validator_pb2<span style="color:#f92672">.</span>Message<span style="color:#f92672">.</span>AUTHORIZATION_TRUST_REQUEST,
        AuthorizationTrustRequestHandler(
            network<span style="color:#f92672">=</span>network_service,
            permission_verifier<span style="color:#f92672">=</span>PermissionVerifier(None, <span style="color:#66d9ef">lambda</span>: <span style="color:#e6db74">&#39;&#39;</span>,None),
            gossip<span style="color:#f92672">=</span>gossip),
        network_thread_pool)

    network_dispatcher<span style="color:#f92672">.</span>add_handler(
        validator_pb2<span style="color:#f92672">.</span>Message<span style="color:#f92672">.</span>GOSSIP_REGISTER,
        PeerRegisterHandler(gossip<span style="color:#f92672">=</span>gossip),
        network_thread_pool)

    <span style="color:#75715e"># Fake BlockResponderHandler</span>
    responder <span style="color:#f92672">=</span> Responder(None)
    
    network_dispatcher<span style="color:#f92672">.</span>add_handler(
        validator_pb2<span style="color:#f92672">.</span>Message<span style="color:#f92672">.</span>GOSSIP_BLOCK_REQUEST,
        BlockResponderHandler(responder, gossip),
        network_thread_pool)

    network_dispatcher<span style="color:#f92672">.</span>add_handler(
        validator_pb2<span style="color:#f92672">.</span>Message<span style="color:#f92672">.</span>GOSSIP_BLOCK_RESPONSE,
        ResponderBlockResponseHandler(responder, gossip),
        network_thread_pool)

    <span style="color:#75715e"># Start services</span>
    network_dispatcher<span style="color:#f92672">.</span>start()
    network_service<span style="color:#f92672">.</span>start()</code></pre></div>

<h2 id="gossip-network">Gossip network</h2>

<p>To start the gossip network we have two nodes 8800 without any peer and the second 8801 using 8800 as peer,</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Gossip Peer 1 - ROUTER &#34;server&#34; - 8800</span>
validator_factory(<span style="color:#e6db74">&#34;tcp://127.0.0.1:8800&#34;</span>,initial_peer_endpoints<span style="color:#f92672">=</span>[])</code></pre></div>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Gossip Peer 2 - DEALER &#34;client&#34; - 8801</span>
validator_factory(<span style="color:#e6db74">&#34;tcp://127.0.0.1:8801&#34;</span>,initial_peer_endpoints<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;tcp://127.0.0.1:8800&#34;</span>])</code></pre></div>
<ul class="pa0">
  
</ul>
<div class="mt6">
        
      </div>
    </main>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <script type="text/javascript" async
        src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
 MathJax.Hub.Config({
   tex2jax: {
     inlineMath: [['$','$'], ['\\(','\\)']],
     displayMath: [['$$','$$']],
     processEscapes: true,
     processEnvironments: true,
     skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
     TeX: { equationNumbers: { autoNumber: "AMS" },
            extensions: ["AMSmath.js", "AMSsymbols.js"] }
   }
 });
 MathJax.Hub.Queue(function() {
   
   
   
   var all = MathJax.Hub.getAllJax(), i;
   for(i = 0; i < all.length; i += 1) {
     all[i].SourceElement().parentNode.className += ' has-jax';
   }
 });

 MathJax.Hub.Config({
   
   TeX: { equationNumbers: { autoNumber: "AMS" } }
 });
</script>

<footer class="bg-near-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://knabben.github.io/" >
    &copy; 2019 AK
  </a>
    <div>








</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
