<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>AK  | From Dev to PoET</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.54.0" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.e08a958ae3e530145318b6373195c765.css" rel="stylesheet">
    

    
      <link rel="stylesheet" href="/css/custom.css">
    

    
      
    

    

    <meta property="og:title" content="From Dev to PoET" />
<meta property="og:description" content="Introduction DevMode is very cool for development of transaction processors, but when you go to production it don&#39;t grant a correct fork resolution of your chain, and you can end up with different HEAD in the nodes.
Some Byzantine Fault Tolerant protocols were created to fix this problem, in version 1.0.5 we have the famous PoET, when used with SGX (intel protection) it can guarantee the BFT characteristic.
But without it this algorithm becomes Crash Fault Tolerant only, for our proposes it&#39;s enough." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://knabben.github.io/posts/dev-poet/" />
<meta property="article:published_time" content="2019-11-16T01:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2019-11-16T01:00:00&#43;00:00"/>

<meta itemprop="name" content="From Dev to PoET">
<meta itemprop="description" content="Introduction DevMode is very cool for development of transaction processors, but when you go to production it don&#39;t grant a correct fork resolution of your chain, and you can end up with different HEAD in the nodes.
Some Byzantine Fault Tolerant protocols were created to fix this problem, in version 1.0.5 we have the famous PoET, when used with SGX (intel protection) it can guarantee the BFT characteristic.
But without it this algorithm becomes Crash Fault Tolerant only, for our proposes it&#39;s enough.">


<meta itemprop="datePublished" content="2019-11-16T01:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-11-16T01:00:00&#43;00:00" />
<meta itemprop="wordCount" content="797">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="From Dev to PoET"/>
<meta name="twitter:description" content="Introduction DevMode is very cool for development of transaction processors, but when you go to production it don&#39;t grant a correct fork resolution of your chain, and you can end up with different HEAD in the nodes.
Some Byzantine Fault Tolerant protocols were created to fix this problem, in version 1.0.5 we have the famous PoET, when used with SGX (intel protection) it can guarantee the BFT characteristic.
But without it this algorithm becomes Crash Fault Tolerant only, for our proposes it&#39;s enough."/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="http://knabben.github.io/" class="f3 fw2 hover-white no-underline white-90 dib">
      AK
    </a>
    <div class="flex-l items-center">
      
      









    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  <article class="flex-l flex-wrap justify-between mw8 center ph3 ph0-l">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        POSTS
      </p>
      <h1 class="f1 athelas mb1">From Dev to PoET</h1>
      
      <time class="f6 mv4 dib tracked" datetime="2019-11-16T01:00:00Z">November 16, 2019</time>
    </header>

    <main class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><h2 id="introduction">Introduction</h2>

<p>DevMode is very cool for development of transaction processors, but when you go to production
it don't grant a correct fork resolution of your chain, and you can end up with different 
HEAD in the nodes.</p>

<p>Some Byzantine Fault Tolerant protocols were created to fix this problem, in version 1.0.5 we
have the famous PoET, when used with SGX (intel protection) it can guarantee the BFT characteristic.</p>

<p>But without it this algorithm becomes Crash Fault Tolerant only, for our proposes
it's enough. The idea here is to spin up a network with 3 nodes, being the first the node who
will generate the genesis block and the other peers will sync up with it.</p>

<h2 id="a-sawtooth-1-0-5-testnet">A Sawtooth 1.0.5 Testnet</h2>

<p>Get this Gist with the Kubernetes description:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">wget https://gist.githubusercontent.com/knabben/f84c0e4088868d7f9000a21d42412952/raw/10a71bdb8f0cce67234c4465360868c02174b305/poet.yaml</code></pre></div>

<p>The main containers are the sawtooth-validator, sawtooth-settings-tp and the poet-validator-tp.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">sawadm keygen --force <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    
sawset genesis -k /etc/sawtooth/keys/validator.priv -o config-genesis.batch <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>
sawset proposal create <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>      -k /etc/sawtooth/keys/validator.priv <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>      sawtooth.consensus.algorithm<span style="color:#f92672">=</span>poet <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>      sawtooth.poet.report_public_key_pem<span style="color:#f92672">=</span><span style="color:#ae81ff">\&#34;</span><span style="color:#66d9ef">$(</span>cat /etc/sawtooth/simulator_rk_pub.pem<span style="color:#66d9ef">)</span><span style="color:#ae81ff">\&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>      sawtooth.poet.valid_enclave_measurements<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>poet enclave measurement<span style="color:#66d9ef">)</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>      sawtooth.poet.valid_enclave_basenames<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>poet enclave basename<span style="color:#66d9ef">)</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>      -o config.batch <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>
poet registration create -k /etc/sawtooth/keys/validator.priv -o poet.batch <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>
sawset proposal create <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -k /etc/sawtooth/keys/validator.priv <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  sawtooth.poet.target_wait_time<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  sawtooth.poet.initial_wait_time<span style="color:#f92672">=</span><span style="color:#ae81ff">25</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  sawtooth.publisher.max_batches_per_block<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -o poet-settings.batch <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>
sawadm genesis config-genesis.batch config.batch poet.batch poet-settings.batch <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>sawtooth-validator -vvvv <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --endpoint tcp://$SAWTOOTH_0_SERVICE_HOST:8800 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --peering dynamic <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --bind component:tcp://eth0:4004 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --bind network:tcp://eth0:8800<span style="color:#e6db74">&#34;</span></code></pre></div>

<p>The difference here is starting the genesis block with sawtooth.consensus.algorithm=poet proposal 
in settings + the configuration attributes, pay attention in the poet registration command
that uses --enclave-module simulator by default.</p>

<p>Our peering is dynamic, and the other nodes are discovered in auto mode.</p>

<h2 id="other-containers">Other containers</h2>

<p>Besides the validator we need a rest-api, the intkey TP and shell to test the network.</p>

<p>The default way to do this is bring everything in the same Pod with multiple containers</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  - name: sawtooth-rest-api
    image: hyperledger/sawtooth-rest-api:<span style="color:#ae81ff">1.0</span>.<span style="color:#ae81ff">5</span>
    ports:
      - name: api
        containerPort: <span style="color:#ae81ff">8008</span>
    command:
      - bash
    args:
      - -c
      - <span style="color:#e6db74">&#34;sawtooth-rest-api -C tcp://$HOSTNAME:4004&#34;</span>}</code></pre></div>

<p>These services connect in the same Pod validator node. So we have 1 Deployment/Pod for each node.
To create our network just run:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kubectl create -f poet.yaml
$ kubectl get pods

NAME                          READY   STATUS    RESTARTS   AGE
sawtooth-0-647cff948-ckzkf    <span style="color:#ae81ff">7</span>/7     Running   <span style="color:#ae81ff">0</span>          56m
sawtooth-1-8598d7f975-jjv86   <span style="color:#ae81ff">6</span>/6     Running   <span style="color:#ae81ff">0</span>          56m
sawtooth-2-cb4966b64-429zg    <span style="color:#ae81ff">6</span>/6     Running   <span style="color:#ae81ff">0</span>          56m</code></pre></div>

<h2 id="some-important-highlights">Some important highlights</h2>

<p>Lets create some alias to facilitate our life:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">func kex<span style="color:#f92672">()</span> <span style="color:#f92672">{</span> 
   kubectl exec -it <span style="color:#66d9ef">$(</span>kubectl get pods --namespace default -l <span style="color:#e6db74">&#34;name=sawtooth-</span>$1<span style="color:#e6db74">&#34;</span> -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.items[0].metadata.name}&#34;</span><span style="color:#66d9ef">)</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       -c sawtooth-shell bash 
<span style="color:#f92672">}</span>

func klg<span style="color:#f92672">()</span> <span style="color:#f92672">{</span> 
   kubectl logs <span style="color:#66d9ef">$(</span>kubectl get pods --namespace default -l <span style="color:#e6db74">&#34;name=sawtooth-</span>$1<span style="color:#e6db74">&#34;</span> -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.items[0].metadata.name}&#34;</span><span style="color:#66d9ef">)</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        -c sawtooth-validator 
<span style="color:#f92672">}</span></code></pre></div>

<p>In the validator-0 or the host who have the Genesis block we can see:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#75715e"># Started the genesis block</span>
genesis<span style="color:#f92672">]</span> Producing genesis block from /var/lib/sawtooth/genesis.batch

<span style="color:#75715e"># Listening on 8800 for the gossip networking</span>
interconnect<span style="color:#f92672">]</span> Listening on tcp://eth0:8800

<span style="color:#75715e"># The PoET simulator started internally, in this version we don&#39;t need a poet-engine running externally.</span>

publisher<span style="color:#f92672">]</span> Now building on top of block: 05fd696ccb58faba4f7c5760b9ca57fb824b09c39450ca97679fc037723bd680601c6ca42635c6edac7cf66249405f8b4ea1ab4188e4d932d639f918b438c343
<span style="color:#f92672">(</span>block_num:0, state:6819ad7540c2f6d8f5cb25f367de8648cd956163aa3b857ecb074517bee33b62, previous_block_id:0000000000000000<span style="color:#f92672">)</span>
consensus_state_store<span style="color:#f92672">]</span> Create consensus store: /var/lib/sawtooth/poet_consensus_state-02ae8605.lmdb
poet_key_state_store<span style="color:#f92672">]</span> Create PoET key state store: /var/lib/sawtooth/poet-key-state-02ae8605.lmdb
poet_enclave_factory<span style="color:#f92672">]</span> Load PoET enclave module: sawtooth_poet_simulator.poet_enclave_simulator.poet_enclave_simulator; Target wait time: <span style="color:#ae81ff">5</span>.000000; Initial wait time: <span style="color:#ae81ff">25</span>.0
<span style="color:#ae81ff">00000</span>; Population estimate sample size: <span style="color:#ae81ff">50</span>;</code></pre></div>

<p>For the validator-1 and validator-2 you can see similar initialization:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">publisher<span style="color:#f92672">]</span> Now building on top of block: 05fd696ccb58faba4f7c5760b9ca57fb824b09c39450ca97679fc037723bd680601c6ca42635c6edac7cf66249405f8b4ea1ab4188e4d932d639f918b438c343
consensus_state_store<span style="color:#f92672">]</span> Create consensus store: /var/lib/sawtooth/poet_consensus_state-03829c84.lmdb
poet_key_state_store<span style="color:#f92672">]</span> Create PoET key state store: /var/lib/sawtooth/poet-key-state-03829c84.lmdb
poet_enclave_factory<span style="color:#f92672">]</span> Load PoET enclave module: sawtooth_poet_simulator.poet_enclave_simulator.poet_enclave_simulator; Target wait time: <span style="color:#ae81ff">5</span>.000000; Initial wait time: <span style="color:#ae81ff">25</span>.000000; Population estimate sample size: <span style="color:#ae81ff">50</span>;
poet_enclave_simulator<span style="color:#f92672">]</span> PoET enclave simulator creating anti-Sybil ID from: <span style="color:#ae81ff">2019</span>-11-17T01:05:43.820014                                                                   
poet_block_publisher<span style="color:#f92672">]</span> No public key found, so going to register new signup information
poet_block_publisher<span style="color:#f92672">]</span> Register Validator Name<span style="color:#f92672">=</span>validator-03829c84, ID<span style="color:#f92672">=</span>03829c84...e6e897ef, PoET public key<span style="color:#f92672">=</span>0264eb69...6eb3df13, Nonce<span style="color:#f92672">=</span>4ea1ab4188e4d932d639f918b438c343    
poet_block_publisher<span style="color:#f92672">]</span> Save key state PPK<span style="color:#f92672">=</span>0264eb69...6eb3df13 <span style="color:#f92672">=</span>&gt; SSD<span style="color:#f92672">=</span>eyJjb3Vu...ZjEzIn0<span style="color:#f92672">=</span></code></pre></div>

<p>This gensis block from validator-0 was sync on other nodes via peering mode. The chain arrives after GOSSIP_BLOCK_REQUEST HEAD is made.</p>

<h2 id="testing-our-network-with-intkey">Testing our network with Intkey</h2>

<p>Find a box with a intkey installed, you can use one of the rest-apis to insert
a new key on it:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kex <span style="color:#ae81ff">0</span>
root@ac7b765563e0:/# intkey set abc <span style="color:#ae81ff">100</span>
root@ac7b765563e0:/# <span style="color:#66d9ef">while</span> true; <span style="color:#66d9ef">do</span> intkey inc abc <span style="color:#ae81ff">1</span>; sleep <span style="color:#ae81ff">5</span>; <span style="color:#66d9ef">done</span>

<span style="color:#75715e"># After some time check the HEAD of each node:</span>

$ kex <span style="color:#ae81ff">1</span>
root@sawtooth-1-8598d7f975-kxc4v:/# sawtooth block list
NUM  BLOCK_ID                                                                                                                          BATS  TXNS  SIGNER
<span style="color:#ae81ff">6</span>    1c2d4d23fd20d7412aa764ee0be13b44aae6e942b0da5b321e7092244012bb92641f76b32eacff6bee7b7da41e789f0c10706d8860bf7eca97f781176aba8c79  <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">1</span>     028c7b9084dbe585f0bff105711487489a8fb5feda406a33cf5e24

$ kex <span style="color:#ae81ff">0</span>
root@sawtooth-0-647cff948-bs4p5:/# sawtooth block list
NUM  BLOCK_ID                                                                                                                          BATS  TXNS  SIGNER
<span style="color:#ae81ff">10</span>   3a1fbae4391d1fd2109751b241cc836188ee8dc262c4c9be53fc68c181650f474f950967d0cc6a4f587635aaf1d9d3ab1cc8179c47da6690e946d592049bb8e8  <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">1</span>     028c7b9084dbe585f0bff105711487489a8fb5feda406a33cf5e24

$ kex <span style="color:#ae81ff">2</span>
root@sawtooth-2-cb4966b64-9wfxs:/# sawtooth block list
NUM  BLOCK_ID                                                                                                                          BATS  TXNS  SIGNER
<span style="color:#ae81ff">10</span>   3a1fbae4391d1fd2109751b241cc836188ee8dc262c4c9be53fc68c181650f474f950967d0cc6a4f587635aaf1d9d3ab1cc8179c47da6690e946d592049bb8e8  <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">1</span>     028c7b9084dbe585f0bff105711487489a8fb5feda406a33cf5e24</code></pre></div>

<h2 id="conclusion">Conclusion</h2>

<p>The version 1.0.5 still have the consensus mechanism coupled in sawtooth-core, this only changed after 1.1, but for sure the recommended version is latest 1.2.3. 
The other trick part here (if you get the Kubernetes/Docker from newer versions) is the change from sawtooth.consensus.algorithm=poet to sawtooth.consensus.algorithm.name=poet
settings in newer version, since the system gives you no hints from this problem, and only rolls back to DevMode.</p>
<ul class="pa0">
  
</ul>
<div class="mt6">
        
      </div>
    </main>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <script type="text/javascript" async
        src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
 MathJax.Hub.Config({
   tex2jax: {
     inlineMath: [['$','$'], ['\\(','\\)']],
     displayMath: [['$$','$$']],
     processEscapes: true,
     processEnvironments: true,
     skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
     TeX: { equationNumbers: { autoNumber: "AMS" },
            extensions: ["AMSmath.js", "AMSsymbols.js"] }
   }
 });
 MathJax.Hub.Queue(function() {
   
   
   
   var all = MathJax.Hub.getAllJax(), i;
   for(i = 0; i < all.length; i += 1) {
     all[i].SourceElement().parentNode.className += ' has-jax';
   }
 });

 MathJax.Hub.Config({
   
   TeX: { equationNumbers: { autoNumber: "AMS" } }
 });
</script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-46699622-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<footer class="bg-near-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://knabben.github.io/" >
    &copy; 2019 AK
  </a>
    <div>








</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
