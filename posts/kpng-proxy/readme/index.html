<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>KPNG Windows Userspace | OPSSEC.in</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.80.0" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.1cb140d8ba31d5b2f1114537dd04802a.css" rel="stylesheet">
    

    
      <link rel="stylesheet" href="/css/custom.css">
    

    
      
    

    
    
    <meta property="og:title" content="KPNG Windows Userspace" />
<meta property="og:description" content="KPNG windows userspace backend support" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://opssec.in/posts/kpng-proxy/readme/" />
<meta property="article:published_time" content="2022-01-22T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-01-22T00:00:00+00:00" />
<meta itemprop="name" content="KPNG Windows Userspace">
<meta itemprop="description" content="KPNG windows userspace backend support">
<meta itemprop="datePublished" content="2022-01-22T00:00:00+00:00" />
<meta itemprop="dateModified" content="2022-01-22T00:00:00+00:00" />
<meta itemprop="wordCount" content="1001">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="KPNG Windows Userspace"/>
<meta name="twitter:description" content="KPNG windows userspace backend support"/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://opssec.in/" class="f3 fw2 hover-white no-underline white-90 dib">
       OPSSEC.in ☿
    </a>
    <div class="flex-l items-center">
      

      

      <ul class="pl0 mr3" style="color: white">
          <a style="text-decoration: none; color: white" href="https://md.opssec.in/winapi/init.html">win32 api</a>
      </ul >
      




<a href="https://twitter.com/ak_ndb" target="_blank" class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel="noopener" aria-label="follow on Twitter——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>




<a href="https://www.linkedin.com/in/amim/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


<a href="https://github.com/knabben/" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel="noopener" aria-label="follow on Github——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>







    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=https://opssec.in/posts/kpng-proxy/readme/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=https://opssec.in/posts/kpng-proxy/readme/&amp;text=KPNG%20Windows%20Userspace" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://opssec.in/posts/kpng-proxy/readme/&amp;title=KPNG%20Windows%20Userspace" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>

      <h1 class="f1 athelas mt3 mb1">KPNG Windows Userspace</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2022-01-22T00:00:00Z">January 22, 2022</time>

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray w-l" style="width: 100%;"><h2 id="introduction">Introduction</h2>

<p>KPNG (KubeProxy Next Generation, kproxy v2) has as a goal provide a more scalable version of service proxies
on Kubernetes, the idea is provide a <em>core</em> system that comunicates with the API server and provides an SHIM
interface for the backends. Backends are specialized code that implement the required steps to provide the
load balancing for the endpoints based on the data plane technology of choice (iptables, ipvs, HCN, etc.)</p>

<p>In this post there will an integration walkthough on the first Windows backend (userspace) port to KPNG
and will be provided a few ways to use it on <a href="#link-1">SIG-Windows Development Tooling</a>.</p>

<p>Read more about the motivations and ideas behind KPNG in the <a href="#link-2">KEP</a>.</p>

<h2 id="compiling-kpng">Compiling KPNG</h2>

<p>First thing is to compile kpng executable and the backend as a standalone process. Clone
the repository on your GOPATH.</p>

<h3 id="kpng-core">kPNG core</h3>

<p>On kpng folder, enter the cmd folder and install the windows OS version, on your <strong>GOPATH/bin</strong>
you will find the <strong>kpng.exe</strong> binary.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kpng$ cd cmd/
kpng/cmd$ GOOS<span style="color:#f92672">=</span>windows go install ./kpng

~/go/bin$ tree
└── windows_amd64
    └── kpng.exe</code></pre></div>
<h3 id="kpng-windows-backend">kPNG windows backend</h3>

<p>The windows userspace is in-tree but the compilation happens as a standalone binary.
It connects to the core kpng via gRPC server.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kpng$ cd backend/windows/userspace
kpng/backend/windows/userspace$ GOOS<span style="color:#f92672">=</span>windows go build -o winuserspace.exe ./...</code></pre></div>
<h3 id="building-a-dockerfile">Building a Dockerfile</h3>

<p>At this point you have 2 binaries, you can run this directly in the cluster as
a process or as a daemonset, for the later lets create the Dockerfile first.</p>

<p>Use a Windows machine to build the image, a working version can be find on <strong><code>knabben/kpng:latest</code></strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-dockerfile" data-lang="dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> mcr.microsoft.com/windows/nanoserver:1809</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> PATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;C:\Program Files\PowerShell;C:\utils;C:\Windows\system32;C:\Windows;&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> ./kpng.exe /kpng/kpng.exe<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> ./winuserspace.exe /kpng/winuserspace.exe<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;PowerShell&#34;</span>]</code></pre></div>
<p>Move both binaries to a folder and add this Dockerfile. You can compile with:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">docker build --isolation<span style="color:#f92672">=</span>hyperv --pull -t <span style="color:#e6db74">&#34;knabben/kpng:latest&#34;</span> -f .<span style="color:#ae81ff">\D</span>ockerfile .</code></pre></div>
<h2 id="replacing-kubeproxy">Replacing Kube-proxy</h2>

<p>At this point there're two ways to run it, first is adding the binaries as a service
the second is directly on your node using <code>hostProcess</code>.</p>

<h3 id="nssm-nonsucking-service-manager">NSSM (Non-Sucking Service Manager)</h3>

<p>In this example we are reusing the kube-proxy configuration from the Antrea CNI installation
in the dev environment.</p>

<p>First we stop the Kube-proxy service (removing the dependency from Antrea-Agent), we add a new
service called kpng with the core binary, and another service with the backend.</p>

<p>Don't forget to add the log parameters.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># Remove kube-proxy dependency from antrea Agent</span>
nssm.exe set antrea-agent DependOnService -kube-proxy
nssm.exe stop kube-proxy

$KubeProxyConfig=<span style="color:#e6db74">&#34;C:/k/antrea/etc/kube-proxy.conf&#34;</span>

$nssm = (Get-Command nssm).Source

<span style="color:#75715e"># Install kpng.exe as a service</span>
&amp; nssm install kpng <span style="color:#e6db74">&#34;C:/forked/kpng.exe&#34;</span> <span style="color:#e6db74">&#34;kube to-api --kubeconfig=$KubeProxyConfig&#34;</span>
&amp; nssm set kpng Start SERVICE_DELAYED_AUTO_START
&amp; nssm set kpng AppStdout C:\var\log\kpng\kpng.INFO.log
&amp; nssm set kpng AppStderr C:\var\log\kpng\kpng.ERR.log

<span style="color:#75715e"># Install winuserspace.exe backend as a service</span>
&amp; nssm install winuserspace <span style="color:#e6db74">&#34;C:/forked/winuserspace.exe&#34;</span> <span style="color:#e6db74">&#34;-v=4&#34;</span>
&amp; nssm set winuserspace DependOnService kpng
&amp; nssm set winuserspace Start SERVICE_DELAYED_AUTO_START
&amp; nssm set winuserspace AppStdout C:\var\log\kpng\winuserspace.INFO.log
&amp; nssm set winuserspace AppStderr C:\var\log\kpng\winuserspace.ERR.log

<span style="color:#75715e"># Starting both services</span>
nssm start kpng
nssm start winuserspace</code></pre></div>
<h3 id="hostprocesslink3"><a href="#link-3">HostProcess</a></h3>

<p>For hostProcess you need at least containerd 1.6+ and Kubernetes&gt;=1.23 to have the feature as beta on Windows.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">NAME           STATUS   ROLES                  AGE     VERSION                         INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                                  KERNEL-VERSION     CONTAINER-RUNTIME
controlplane   Ready    control-plane,master   5h46m   v1.23.3-rc.0.5+eb8a499627d33c   10.20.30.10   &lt;none&gt;        Ubuntu 20.04.3 LTS                        5.4.0-81-generic   containerd://1.5.5
winw1          Ready    &lt;none&gt;                 5h36m   v1.23.3-rc.0.5+eb8a499627d33c   10.20.30.11   &lt;none&gt;        Windows Server <span style="color:#ae81ff">2019</span> Standard Evaluation   10.0.17763.2452    containerd://1.6.0-rc.1</code></pre></div>
<p>The following is the specification of a daemonset used in the experiment:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DaemonSet</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">kpng</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kpng-windows</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">kube-system</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">matchLabels</span>:
      <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">kpng</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">k8s-app</span>: <span style="color:#ae81ff">kpng</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">securityContext</span>:
        <span style="color:#f92672">windowsOptions</span>:
          <span style="color:#f92672">hostProcess</span>: <span style="color:#66d9ef">true</span>
          <span style="color:#f92672">runAsUserName</span>: <span style="color:#e6db74">&#34;NT AUTHORITY\\system&#34;</span>
      <span style="color:#f92672">hostNetwork</span>: <span style="color:#66d9ef">true</span>
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">knabben/kpng:latest</span>
        <span style="color:#f92672">args</span>: [<span style="color:#e6db74">&#34;$env:CONTAINER_SANDBOX_MOUNT_POINT/kpng/winuserspace.exe&#34;</span>, <span style="color:#e6db74">&#34;-v=4&#34;</span>]
        <span style="color:#f92672">workingDir</span>: <span style="color:#e6db74">&#34;$env:CONTAINER_SANDBOX_MOUNT_POINT/kpng/&#34;</span>
        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kpng-backend</span>
        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">Always</span>
        <span style="color:#f92672">env</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">NODE_NAME</span>
          <span style="color:#f92672">valueFrom</span>:
            <span style="color:#f92672">fieldRef</span>:
              <span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
              <span style="color:#f92672">fieldPath</span>: <span style="color:#ae81ff">spec.nodeName</span>
      - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">knabben/kpng:latest</span>
        <span style="color:#f92672">args</span>: [<span style="color:#e6db74">&#34;$env:CONTAINER_SANDBOX_MOUNT_POINT/kpng/kpng.exe&#34;</span>, <span style="color:#e6db74">&#34;kube to-api --kubeconfig=$env:CONTAINER_SANDBOX_MOUNT_POINT/kpng/etc/kube-proxy.conf&#34;</span>]
        <span style="color:#f92672">workingDir</span>: <span style="color:#e6db74">&#34;$env:CONTAINER_SANDBOX_MOUNT_POINT/kpng/&#34;</span>
        <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kpng</span>
        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">Always</span>
        <span style="color:#f92672">env</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">NODE_NAME</span>
          <span style="color:#f92672">valueFrom</span>:
            <span style="color:#f92672">fieldRef</span>:
              <span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
              <span style="color:#f92672">fieldPath</span>: <span style="color:#ae81ff">spec.nodeName</span>
        <span style="color:#f92672">volumeMounts</span>:
        - <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">c:\\kpng\\etc\\</span>
          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kube-proxy</span>
      <span style="color:#f92672">volumes</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kube-proxy</span>
        <span style="color:#f92672">hostPath</span>:
          <span style="color:#f92672">path</span>: <span style="color:#ae81ff">C:\\k\\antrea\\etc</span>
          <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Directory</span>
      <span style="color:#f92672">nodeSelector</span>:
        <span style="color:#f92672">kubernetes.io/os</span>: <span style="color:#ae81ff">windows</span></code></pre></div>
<p>A few notes in the spec, securityContext as hostProcess and runAsUserName are required. The kpng container needs access to the kube-proxy.conf (to watch cluster objects).
Mounting the hostPath volume from the actual kube-proxy.</p>

<h3 id="smoke-testing">Smoke testing</h3>

<p>The version of Antrea used on sig-windows-dev-tools is 1.4, and Kube-proxy is used for NodePort only, more details on <a href="#link-4">Antrea live</a>.</p>

<p>In the example we are testing only the last hostProcess step. Showing the pods, note the IP of the pod is the same as
the windows node and two containers are running inside of it (kpng core and kpng backend).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kubectl -n kube-system get daemonset
NAMESPACE     NAME           DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR              AGE
kube-system   antrea-agent   <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>       <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           kubernetes.io/os<span style="color:#f92672">=</span>linux     5h56m
kube-system   kpng-windows   <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">1</span>       <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           kubernetes.io/os<span style="color:#f92672">=</span>windows   3h21m

$ kubectl get pods -A -o wide
NAMESPACE     NAME                                   READY   STATUS    RESTARTS   AGE     IP            NODE           NOMINATED NODE   READINESS GATES
default       netshoot                               1/1     Running   <span style="color:#ae81ff">0</span>          3h27m   100.244.0.9   controlplane   &lt;none&gt;           &lt;none&gt;
default       whoami-windows-6cf6f67f56-7npz9        1/1     Running   <span style="color:#ae81ff">0</span>          3h27m   100.244.1.4   winw1          &lt;none&gt;           &lt;none&gt;
kube-system   kpng-windows-pd2bs                     2/2     Running   <span style="color:#ae81ff">0</span>          3h26m   10.20.30.11   winw1          &lt;none&gt;           &lt;none&gt;</code></pre></div>
<p>To test it lets create a new service of type NodePort, pointing to the pod <code>whoami-windows-6cf6f67f56-7npz9</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kubectl get svc
NAME             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>        AGE
whoami-windows   NodePort    10.108.182.129   &lt;none&gt;        80:31134/TCP   3h2</code></pre></div>
<p>Access from another node (10.20.30.10) -&gt; 10.20.30.11:31134:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">vagrant@controlplane$ curl 10.20.30.11:31134
I<span style="color:#960050;background-color:#1e0010">&#39;</span>m whoami-windows-6cf6f67f56-l24gf running on windows/amd64

IP: fe80::b1ea:1b62:be2e:6fc8
IP: 100.244.1.5
IP: ::1
IP: 127.0.0.1
ENV: ALLUSERSPROFILE<span style="color:#f92672">=</span>C:<span style="color:#ae81ff">\P</span>rogramData
ENV: APPDATA<span style="color:#f92672">=</span>C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\C</span>ontainerUser<span style="color:#ae81ff">\A</span>ppData<span style="color:#ae81ff">\R</span>oaming</code></pre></div>
<p>Finally, inspect the logs from the backend as follow, you will see new connections in the service being forwarded to the endpoint.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kubectl -n kube-system logs kpng-windows-pd2bs -c kpng-backend -f
I0123 12:09:23.591710    <span style="color:#ae81ff">3260</span> roundrobin.go:114<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;NextEndpoint for service&#34;</span> servicePortName<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;default/whoami-windows&#34;</span> address<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;10.20.30.10:36898&#34;</span> endpoints<span style="color:#f92672">=[</span>100.244.1.5:8080<span style="color:#f92672">]</span>
I0123 12:09:23.591710    <span style="color:#ae81ff">3260</span> proxysocket.go:92<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;Mapped service to endpoint&#34;</span> service<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;default/whoami-windows&#34;</span> endpoint<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;100.244.1.5:8080&#34;</span>
I0123 12:09:23.592550    <span style="color:#ae81ff">3260</span> proxysocket.go:148<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;Creating proxy between remote and local addresses&#34;</span> inRemoteAddress<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;10.20.30.10:36898&#34;</span> inLocalAddress<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;10.20.30.11:31134&#34;</span> outLocalAddress<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;100.244.1.1:49560&#34;</span> outRemoteAddress<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;100.244.1.5:8080&#34;</span>
I0123 12:09:23.593028    <span style="color:#ae81ff">3260</span> proxysocket.go:157<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;Copying remote address bytes&#34;</span> direction<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;to backend&#34;</span> sourceRemoteAddress<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;10.20.30.10:36898&#34;</span> destinationRemoteAddress<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;100.244.1.5:8080&#34;</span>
I0123 12:09:23.593028    <span style="color:#ae81ff">3260</span> proxysocket.go:157<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;Copying remote address bytes&#34;</span> direction<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;from backend&#34;</span> sourceRemoteAddress<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;100.244.1.5:8080&#34;</span> destinationRemoteAddress<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;10.20.30.10:36898&#34;</span>
I0123 12:09:23.598971    <span style="color:#ae81ff">3260</span> proxysocket.go:164<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;Copied remote address bytes&#34;</span> bytes<span style="color:#f92672">=</span><span style="color:#ae81ff">81</span> direction<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;to backend&#34;</span> sourceRemoteAddress<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;10.20.30.10:36898&#34;</span> destinationRemoteAddress<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;100.244.1.5:8080&#34;</span>
I0123 12:09:23.598971    <span style="color:#ae81ff">3260</span> proxysocket.go:164<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;Copied remote address bytes&#34;</span> bytes<span style="color:#f92672">=</span><span style="color:#ae81ff">2385</span> direction<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;from backend&#34;</span> sourceRemoteAddress<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;100.244.1.5:8080&#34;</span> destinationRemoteAddress<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;10.20.30.10:36898&#34;</span></code></pre></div>
<h3 id="listening">Listening</h3>


<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/rHFlEkaBZIQ" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>


<h2 id="references">References</h2>

<p><span id="link-1">[1]</span> <a href="https://github.com/kubernetes-sigs/sig-windows-dev-tools/">https://github.com/kubernetes-sigs/sig-windows-dev-tools/</a></p>

<p><span id="link-2">[2]</span> <a href="https://github.com/kubernetes/enhancements/pull/2094/">https://github.com/kubernetes/enhancements/pull/2094/</a></p>

<p><span id="link-3">[3]</span> <a href="https://github.com/kubernetes-sigs/sig-windows-tools/blob/master/hostprocess/calico/kube-proxy/kube-proxy.yml">https://github.com/kubernetes-sigs/sig-windows-tools/blob/master/hostprocess/calico/kube-proxy/kube-proxy.yml</a></p>

<p><span id="link-4">[4]</span> <a href="https://www.youtube.com/watch?v=3Z0NOrETjxY">https://www.youtube.com/watch?v=3Z0NOrETjxY</a></p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "blog-ak" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <script type="text/javascript" async
        src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
 MathJax.Hub.Config({
   tex2jax: {
     inlineMath: [['$','$'], ['\\(','\\)']],
     displayMath: [['$$','$$']],
     processEscapes: true,
     processEnvironments: true,
     skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
     TeX: { equationNumbers: { autoNumber: "AMS" },
            extensions: ["AMSmath.js", "AMSsymbols.js"] }
   }
 });
 MathJax.Hub.Queue(function() {
   
   
   
   var all = MathJax.Hub.getAllJax(), i;
   for(i = 0; i < all.length; i += 1) {
     all[i].SourceElement().parentNode.className += ' has-jax';
   }
 });

 MathJax.Hub.Config({
   
   TeX: { equationNumbers: { autoNumber: "AMS" } }
 });
</script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-46699622-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<footer class="bg-near-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://opssec.in/" >
    &copy; 2023 - Amim Knabben
  </a>
    <div>




<a href="https://twitter.com/ak_ndb" target="_blank" class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel="noopener" aria-label="follow on Twitter——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>




<a href="https://www.linkedin.com/in/amim/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


<a href="https://github.com/knabben/" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel="noopener" aria-label="follow on Github——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>






</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
