<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Kube-proxy Linux Userspace Mode | OPSSEC.in</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.80.0" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.1cb140d8ba31d5b2f1114537dd04802a.css" rel="stylesheet">
    

    
      <link rel="stylesheet" href="/css/custom.css">
    

    
      
    

    
    
    <meta property="og:title" content="Kube-proxy Linux Userspace Mode" />
<meta property="og:description" content="kube-proxy userspace mode observability" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://opssec.in/posts/kproxy-modes/readme/" />
<meta property="article:published_time" content="2021-11-27T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-11-27T00:00:00+00:00" />
<meta itemprop="name" content="Kube-proxy Linux Userspace Mode">
<meta itemprop="description" content="kube-proxy userspace mode observability">
<meta itemprop="datePublished" content="2021-11-27T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-11-27T00:00:00+00:00" />
<meta itemprop="wordCount" content="1873">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kube-proxy Linux Userspace Mode"/>
<meta name="twitter:description" content="kube-proxy userspace mode observability"/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://opssec.in/" class="f3 fw2 hover-white no-underline white-90 dib">
      OPSSEC.in
    </a>
    <div class="flex-l items-center">
      

      

      <ul class="pl0 mr3" style="color: white">
          <a style="text-decoration: none; color: white" href="https://md.opssec.in/winapi/init.html">win32 api</a>
      </ul >
      




<a href="https://twitter.com/ak_ndb" target="_blank" class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel="noopener" aria-label="follow on Twitter——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>




<a href="https://www.linkedin.com/in/amim/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


<a href="https://github.com/knabben/" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel="noopener" aria-label="follow on Github——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>







    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=https://opssec.in/posts/kproxy-modes/readme/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=https://opssec.in/posts/kproxy-modes/readme/&amp;text=Kube-proxy%20Linux%20Userspace%20Mode" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://opssec.in/posts/kproxy-modes/readme/&amp;title=Kube-proxy%20Linux%20Userspace%20Mode" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>

      <h1 class="f1 athelas mt3 mb1">Kube-proxy Linux Userspace Mode</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2021-11-27T00:00:00Z">November 27, 2021</time>

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray w-l" style="width: 100%;"><h2 id="introduction">Introduction</h2>

<p>The following post continues a deep dive into kube-proxy modes, taking another approach to tackle the complexity
that lies on this kind of system, loop diagrams are an interesting one, and we have used this to analyze
the information flow in the Windows userspace mode. To have another holistic view of the entire mode and
understand how these parts are interconnected can be a hard task in distributed systems, this is true
not only for systems running on different machines, but for ones with parallel and concurrent mechanisms
as well.</p>

<p>Let's use the observability in our favor and trace all methods and functions related to the main path of
creating an ClusterIP and deleting it later. Analyzing the tracing on Jaeger [1] can give us the understanding
of the stack trace with the complement of important metadata added to span. As more support to document
and explain it, we can supplement with time-based graphs like sequence diagrams.</p>

<p>I recommend give a read in the other Windows userspace mode, the idea is pretty similar, and the flow
graph present there provides a nice big picture of what is going on. All the code is under <code>pkg/proxy/userspace</code>.</p>

<h3 id="services">Services</h3>

<p>Starting with some notes in the informers and caches for both services and endpoints. These are the most
important Kubernetes objects that kube-proxy reacts to when actions like Add/Delete/Update happens.
The informer provides a reflector and caches to any object on kubernetes, the signature for these methods
are under <code>pkg/proxy/config/config</code>, and each mode implements a Service handler called by these <code>handle*Service</code>
functions.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#75715e">// NewServiceConfig creates a new ServiceConfig.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewServiceConfig</span>(<span style="color:#a6e22e">serviceInformer</span> <span style="color:#a6e22e">coreinformers</span>.<span style="color:#a6e22e">ServiceInformer</span>, <span style="color:#a6e22e">resyncPeriod</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ServiceConfig</span> {
	<span style="color:#a6e22e">result</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ServiceConfig</span>{
		<span style="color:#a6e22e">listerSynced</span>: <span style="color:#a6e22e">serviceInformer</span>.<span style="color:#a6e22e">Informer</span>().<span style="color:#a6e22e">HasSynced</span>,
	}

	<span style="color:#a6e22e">serviceInformer</span>.<span style="color:#a6e22e">Informer</span>().<span style="color:#a6e22e">AddEventHandlerWithResyncPeriod</span>(
		<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">ResourceEventHandlerFuncs</span>{
			<span style="color:#a6e22e">AddFunc</span>:    <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">handleAddService</span>,
			<span style="color:#a6e22e">UpdateFunc</span>: <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">handleUpdateService</span>,
			<span style="color:#a6e22e">DeleteFunc</span>: <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">handleDeleteService</span>,
		},
		<span style="color:#a6e22e">resyncPeriod</span>,
	)

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>
}
</code></pre></div>
<p>This is the <code>glue</code> of Kubernetes API and the business logic implemented on each mode. Taking a look closer
on how them react to each event.</p>

<h4 id="winkernel-iptables-ipvs">Winkernel, Iptables, IPVS</h4>

<p>These modes use the internal cache for tracking changes in both endpoints and services, and the
signature is the same. It will not be detailed right now.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">proxier</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Proxier</span>) <span style="color:#a6e22e">OnServiceAdd</span>(<span style="color:#a6e22e">service</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Service</span>) {
	<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">OnServiceUpdate</span>(<span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">service</span>)
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">proxier</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Proxier</span>) <span style="color:#a6e22e">OnServiceUpdate</span>(<span style="color:#a6e22e">oldService</span>, <span style="color:#a6e22e">service</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Service</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">serviceChanges</span>.<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">oldService</span>, <span style="color:#a6e22e">service</span>) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">isInitialized</span>() {
		<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">Sync</span>()
	}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">proxier</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Proxier</span>) <span style="color:#a6e22e">OnServiceDelete</span>(<span style="color:#a6e22e">service</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Service</span>) {
	<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">OnServiceUpdate</span>(<span style="color:#a6e22e">service</span>, <span style="color:#66d9ef">nil</span>)
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">proxier</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Proxier</span>) <span style="color:#a6e22e">OnServiceSynced</span>() {
	<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">servicesSynced</span> = <span style="color:#66d9ef">true</span>
	<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">setInitialized</span>(<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">endpointSlicesSynced</span>)
	<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">mu</span>.<span style="color:#a6e22e">Unlock</span>()

	<span style="color:#75715e">// Sync unconditionally - this is called once per lifetime.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">syncProxyRules</span>()
}
</code></pre></div>
<h4 id="userspace">Userspace</h4>

<p>This mode instead uses a parallel tracking struct and implements the <code>serviceChange</code> method in the proxy
to save data on them.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">serviceChange</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">current</span>  <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Service</span>
	<span style="color:#a6e22e">previous</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Service</span>
}

<span style="color:#a6e22e">serviceChanges</span>:  make(<span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">NamespacedName</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">serviceChange</span>), <span style="color:#75715e">// datastruct to keep a serviceChangeTracker
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">proxier</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Proxier</span>) <span style="color:#a6e22e">OnServiceAdd</span>(<span style="color:#a6e22e">service</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Service</span>) {
	<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">serviceChange</span>(<span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">service</span>, <span style="color:#e6db74">&#34;OnServiceAdd&#34;</span>)
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">proxier</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Proxier</span>) <span style="color:#a6e22e">OnServiceUpdate</span>(<span style="color:#a6e22e">oldService</span>, <span style="color:#a6e22e">service</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Service</span>) {
	<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">serviceChange</span>(<span style="color:#a6e22e">oldService</span>, <span style="color:#a6e22e">service</span>, <span style="color:#e6db74">&#34;OnServiceUpdate&#34;</span>)
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">proxier</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Proxier</span>) <span style="color:#a6e22e">OnServiceDelete</span>(<span style="color:#a6e22e">service</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Service</span>) {
	<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">serviceChange</span>(<span style="color:#a6e22e">service</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#e6db74">&#34;OnServiceDelete&#34;</span>)
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">proxier</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Proxier</span>) <span style="color:#a6e22e">OnServiceSynced</span>() {
	<span style="color:#f92672">...</span>
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">syncProxyRules</span>()
}
</code></pre></div>
<h4 id="winuserspace">Winuserspace</h4>

<p>Curiously windows userspace is simpler than the other methods, basically it does not guarantee the sync of
services via a background goroutine, instead it only cleans up the UDP stale connection on this
loop as was documented in the last post. The other difference is the mergeService and unmergeService
call made directly, other modes use the serviceChange data structure and keep an internal cache of
changes with ServiceChangeTracker and EndpointChangeTracker.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">proxier</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Proxier</span>) <span style="color:#a6e22e">OnServiceAdd</span>(<span style="color:#a6e22e">service</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Service</span>) {
	<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">mergeService</span>(<span style="color:#a6e22e">service</span>)
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">proxier</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Proxier</span>) <span style="color:#a6e22e">OnServiceUpdate</span>(<span style="color:#a6e22e">oldService</span>, <span style="color:#a6e22e">service</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Service</span>) {
	<span style="color:#a6e22e">existingPortPortals</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">mergeService</span>(<span style="color:#a6e22e">service</span>)
	<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">unmergeService</span>(<span style="color:#a6e22e">oldService</span>, <span style="color:#a6e22e">existingPortPortals</span>)
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">proxier</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Proxier</span>) <span style="color:#a6e22e">OnServiceDelete</span>(<span style="color:#a6e22e">service</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Service</span>) {
	<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">unmergeService</span>(<span style="color:#a6e22e">service</span>, <span style="color:#66d9ef">map</span>[<span style="color:#a6e22e">ServicePortPortalName</span>]<span style="color:#66d9ef">bool</span>{})
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">proxier</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Proxier</span>) <span style="color:#a6e22e">OnServiceSynced</span>() {
}
</code></pre></div>
<p>The cool thing here is to see how them got evolved during time, and the emergence of the design across the
modes. Services running the cluster test:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">❯ kubectl get services -A                                                                                                                                                                                                           <span style="color:#f92672">[</span>21:36:29<span style="color:#f92672">]</span>
NAMESPACE     NAME               TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>                  AGE
default       kubernetes         ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP                  4d3h
default       nginx-deployment   ClusterIP   10.96.232.82   &lt;none&gt;        80/TCP                   83m
kube-system   kube-dns           ClusterIP   10.96.0.10     &lt;none&gt;        53/UDP,53/TCP,9153/TCP   4d3h</code></pre></div>
<h2 id="endpoints">Endpoints</h2>

<p>Giving a quick overview in the endpoint signatures, Windows kernel, IPtables and IPVS listen for
endpointslices [2] instead of endpoints.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">proxier</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Proxier</span>) <span style="color:#a6e22e">OnEndpointSliceAdd</span>(<span style="color:#a6e22e">endpointSlice</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">discovery</span>.<span style="color:#a6e22e">EndpointSlice</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">endpointsChanges</span>.<span style="color:#a6e22e">EndpointSliceUpdate</span>(<span style="color:#a6e22e">endpointSlice</span>, <span style="color:#66d9ef">false</span>) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">isInitialized</span>() {
		<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">Sync</span>()
	}
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">proxier</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Proxier</span>) <span style="color:#a6e22e">OnEndpointSliceUpdate</span>(<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">endpointSlice</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">discovery</span>.<span style="color:#a6e22e">EndpointSlice</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">endpointsChanges</span>.<span style="color:#a6e22e">EndpointSliceUpdate</span>(<span style="color:#a6e22e">endpointSlice</span>, <span style="color:#66d9ef">false</span>) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">isInitialized</span>() {
		<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">Sync</span>()
	}
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">proxier</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Proxier</span>) <span style="color:#a6e22e">OnEndpointSliceDelete</span>(<span style="color:#a6e22e">endpointSlice</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">discovery</span>.<span style="color:#a6e22e">EndpointSlice</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">endpointsChanges</span>.<span style="color:#a6e22e">EndpointSliceUpdate</span>(<span style="color:#a6e22e">endpointSlice</span>, <span style="color:#66d9ef">true</span>) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">isInitialized</span>() {
		<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">Sync</span>()
	}
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">proxier</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Proxier</span>) <span style="color:#a6e22e">OnEndpointSlicesSynced</span>() {
    <span style="color:#f92672">...</span>
	<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">syncProxyRules</span>()
}
</code></pre></div>
<h3 id="usermode-linux-and-windows">Usermode Linux and Windows</h3>

<p>As detailed before the round-robing interface gives us a Load balancer for endpoints
binded to a service on both cases this is implemented as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">proxier</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Proxier</span>) <span style="color:#a6e22e">OnEndpointsAdd</span>(<span style="color:#a6e22e">endpoints</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Endpoints</span>) {
	<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">loadBalancer</span>.<span style="color:#a6e22e">OnEndpointsAdd</span>(<span style="color:#a6e22e">endpoints</span>)
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">proxier</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Proxier</span>) <span style="color:#a6e22e">OnEndpointsUpdate</span>(<span style="color:#a6e22e">oldEndpoints</span>, <span style="color:#a6e22e">endpoints</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Endpoints</span>) {
	<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">loadBalancer</span>.<span style="color:#a6e22e">OnEndpointsUpdate</span>(<span style="color:#a6e22e">oldEndpoints</span>, <span style="color:#a6e22e">endpoints</span>)
}
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">proxier</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Proxier</span>) <span style="color:#a6e22e">OnEndpointsDelete</span>(<span style="color:#a6e22e">endpoints</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Endpoints</span>) {
	<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">loadBalancer</span>.<span style="color:#a6e22e">OnEndpointsDelete</span>(<span style="color:#a6e22e">endpoints</span>)
}
</code></pre></div>
<p>Endpoints existent in the test cluster:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">❯ kubectl get endpoints -A                                                                                                                                                                                                          <span style="color:#f92672">[</span>21:43:55<span style="color:#f92672">]</span>
NAMESPACE            NAME                    ENDPOINTS                                               AGE
default              kubernetes              172.18.0.2:6443                                         4d3h
default              nginx-deployment        10.244.0.24:80,10.244.0.3:80                            84m
kube-system          kube-dns                10.244.0.4:53,10.244.0.5:53,10.244.0.4:53 + <span style="color:#ae81ff">3</span> more...   4d3h
local-path-storage   rancher.io-local-path   &lt;none&gt;                                                  4d3h</code></pre></div>
<p>Userspace modes DO NOT support Dual stack.</p>

<h2 id="tracing-userspace">Tracing userspace</h2>

<p>It's clear they are different as this point, the spans were inserted across the mais functions on <code>pkg/proxy/userspace</code>,
starting in the main method of proxier = <code>syncProxyRules</code>. You can consider these <code>OnService*</code> and <code>OnEndpoints*</code> methods
entry points that will change the internal tracking data struct with the values sent via the API. The real
deal happens when the user CONNECTS to the ClusterIP (the ones on 10.96.0.0/12), this will be clear later.</p>

<h3 id="custom-kubeproxy">Custom kube-proxy</h3>

<p>After having a local binary compiled with <code>make WHAT=cmd/kube-proxy</code>, I overwrite this binary
in the default image on kproxy like:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">FROM k8s.gcr.io/kube-proxy:v1.21.1
COPY ./kube-proxy /usr/local/bin/kube-proxy</code></pre></div>
<p>Compile and push...</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">docker build -t kube-proxy . --no-cache
docker tag kube-proxy:latest knabben/kube-proxy:latest
docker push <span style="color:#75715e"># knabben/kube-proxy...</span></code></pre></div>
<p>On your Kind cluster you can first edit the configuration and change <code>mode: userspace</code> in the configmap,
there's a bug where flags are being ignored when the config file exists, so change the config file only.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">kubectl edit -n kube-system configmap kube-proxy
kubectl edit -n kube-system daemonset kube-proxy

image: knabben/kube-proxy</code></pre></div>
<p>This will restart kube-proxy with the new image, just make sure you can access your Jaeger server, in my
case the report server is accessible on Kind via docker network (172.17.0.1:6831).</p>

<h3 id="first-plot-on-jaeger">First plot on Jaeger</h3>

<img src="/posts/kproxy-modes/screen1.png" alt="" class="" style="width: 90%; ">


<p>The Y is the duration in ms of each method call, the span was created in the beginning of the method and closed in
the end, attributes were added in the middle and when there's a span hierarchy a parent span is propagated down the
stack. The X axis the time passing. Two continuous events are happening in different frequencies, there's something
to be investigated here. there's an uncommon event on Endpoints update going on each 2 seconds, this can be seen
on endpoint watcher, since it can require some debugging of the controller, lets ignore for now and continue
with the kube-proxy analysis in this post, yeah I know. If you went to this path send me an email, and I will
put your updates here.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">I1129 00:27:12.940632       <span style="color:#ae81ff">1</span> config.go:171<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;Calling handler.OnEndpointsUpdate&#34;</span>
I1129 00:27:12.940712       <span style="color:#ae81ff">1</span> log.go:184<span style="color:#f92672">]</span> Reporting span 3f6423af672e92fc:3f6423af672e92fc:0000000000000000:1
I1129 00:27:12.940729       <span style="color:#ae81ff">1</span> log.go:184<span style="color:#f92672">]</span> Reporting span 10b4c5990e470261:10b4c5990e470261:0000000000000000:1
I1129 00:27:14.946938       <span style="color:#ae81ff">1</span> config.go:171<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;Calling handler.OnEndpointsUpdate&#34;</span>
I1129 00:27:14.947036       <span style="color:#ae81ff">1</span> log.go:184<span style="color:#f92672">]</span> Reporting span 61893aa75f27cb1f:61893aa75f27cb1f:0000000000000000:1
I1129 00:27:14.947051       <span style="color:#ae81ff">1</span> log.go:184<span style="color:#f92672">]</span> Reporting span 608f53a74cd73869:608f53a74cd73869:0000000000000000:1

❯ kubectl get endpoints -A -w -o wide                                                                                                                                                                                               <span style="color:#f92672">[</span>21:27:47<span style="color:#f92672">]</span>
NAMESPACE            NAME                    ENDPOINTS                                               AGE
default              kubernetes              172.18.0.2:6443                                         4d3h
default              nginx-deployment        10.244.0.24:80,10.244.0.3:80                            67m
kube-system          kube-dns                10.244.0.4:53,10.244.0.5:53,10.244.0.4:53 + <span style="color:#ae81ff">3</span> more...   4d3h
local-path-storage   rancher.io-local-path   &lt;none&gt;                                                  4d3h
local-path-storage   rancher.io-local-path   &lt;none&gt;                                                  4d3h
local-path-storage   rancher.io-local-path   &lt;none&gt;                                                  4d3h
local-path-storage   rancher.io-local-path   &lt;none&gt;                                                  4d3h</code></pre></div>
<p>UPDATE: @jayunit100 had filled an issue - <code>https://github.com/kubernetes-sigs/kind/issues/2453</code></p>

<p>The big upper circle is the <code>syncProxyRules</code>, and it is what matters for this post.</p>

<h3 id="starting-the-proxy">Starting the proxy</h3>

<img src="/posts/kproxy-modes/screen3.png" alt="" class="" style="width: 100%; ">


<p><code>createProxier</code> returns the main Proxier object and starts the <code>initIptables</code> before, this method ensure
the principal iptables chains exists and the infrastructure we use is set up. From the
comments, this method is idempotent and can be called multiple times (it happens in the sync).</p>
<pre><code>	// We match portal rules first, then NodePort rules.  For NodePort rules, we filter primarily on --dst-type LOCAL,
	// because we want to listen on all local addresses, but don&#39;t match internet traffic with the same dst port number.</code></pre>
<img src="/posts/kproxy-modes/screen5.png" alt="" class="" style="width: 100%; ">


<p>Following, can be noted <code>serviceAdd</code> and <code>EndpointsAdd</code> events. The informers do not only react to new changes but for
things that already exist in the cluster, so the current state is reflected in the controller when they
bootstrap.</p>

<img src="/posts/kproxy-modes/screen6.png" alt="" class="" style="width: 100%; ">


<p>At this point we can confirm the OnServiceAdd using OnServiceUpdate for the service <code>default/nginx-deployment</code>.
Simple but still useful to track these events in real time.</p>

<h3 id="syncproxyrules-the-first-run">syncProxyRules the first run</h3>

<img src="/posts/kproxy-modes/screen2.png" alt="" class="" style="width: 100%; ">


<p>Lets cheat here and go to the first <code>syncProxyRules</code> call, the first run will provide details we are interested,
since all others are just reconciling existent things. There are three services added in the <code>proxy.serviceChanges</code>
by the <code>OnServiceAdd</code> calls.</p>

<p>Looks a lot of different things but they are just marking similar events in the loop,
to simplify lets focus in the nginx-deployment.</p>

<img src="/posts/kproxy-modes/screen7.png" alt="" class="" style="width: 100%; ">

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">proxier</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Proxier</span>) <span style="color:#a6e22e">syncProxyRules</span>() {
    <span style="color:#a6e22e">iptablesInit</span>()
	
	<span style="color:#75715e">// iterate and merge/unmerge them
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">change</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">proxer</span>.<span style="color:#a6e22e">serviceChange</span> {
		<span style="color:#a6e22e">existingPorts</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">mergeService</span>(<span style="color:#a6e22e">change</span>.<span style="color:#a6e22e">current</span>)
		<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">unmergeService</span>(<span style="color:#a6e22e">change</span>.<span style="color:#a6e22e">previous</span>, <span style="color:#a6e22e">existingPorts</span>)
	}
	
	<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">ensurePortals</span>()
	<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">cleanupStaleStickySessions</span>()
}
</code></pre></div>
<p>As noted the current has the service object and previous is nil for <code>nginx-deployment</code> service:</p>

<img src="/posts/kproxy-modes/screen8.png" alt="" class="" style="width: 100%; ">


<p>Getting into the <code>mergeService</code> a lot of things are happening, the main span is still <code>createProxier</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">proxier</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Proxier</span>) <span style="color:#a6e22e">mergeService</span>(<span style="color:#a6e22e">service</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Service</span>) <span style="color:#a6e22e">sets</span>.<span style="color:#a6e22e">String</span> {
	<span style="color:#a6e22e">svcName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">NamespacedName</span>{<span style="color:#a6e22e">Namespace</span>: <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">Namespace</span>, <span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">Name</span>}
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Ports</span> {
		<span style="color:#a6e22e">servicePort</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">Ports</span>[<span style="color:#a6e22e">i</span>]
		<span style="color:#a6e22e">serviceName</span> = <span style="color:#a6e22e">proxy</span>.<span style="color:#a6e22e">ServicePortName</span>{<span style="color:#a6e22e">NamespacedName</span>: <span style="color:#a6e22e">svcName</span>, <span style="color:#a6e22e">Port</span>: <span style="color:#a6e22e">servicePort</span>.<span style="color:#a6e22e">Name</span>}

		<span style="color:#a6e22e">proxyPort</span> = <span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">proxyPorts</span>.<span style="color:#a6e22e">AllocateNext</span>()
		<span style="color:#a6e22e">serviceIP</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">netutils</span>.<span style="color:#a6e22e">ParseIPSloppy</span>(<span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">Spec</span>.<span style="color:#a6e22e">ClusterIP</span>)
		
		<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">addServiceOnPortInternal</span>(<span style="color:#a6e22e">serviceName</span>, <span style="color:#a6e22e">servicePort</span>.<span style="color:#a6e22e">Protocol</span>, <span style="color:#a6e22e">proxyPort</span>, <span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">udpIdleTimeout</span>)
		<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">openPortal</span>(<span style="color:#a6e22e">serviceName</span>, <span style="color:#a6e22e">info</span>)
		
		<span style="color:#75715e">// creates a new load balancer -&gt; service
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">proxier</span>.<span style="color:#a6e22e">loadBalancer</span>.<span style="color:#a6e22e">NewService</span>(<span style="color:#a6e22e">serviceName</span>, <span style="color:#a6e22e">info</span>.<span style="color:#a6e22e">sessionAffinityType</span>, <span style="color:#a6e22e">info</span>.<span style="color:#a6e22e">stickyMaxAgeSeconds</span>)
	}
</code></pre></div>
<p>The <code>addServiceOnPortInternal</code> method starts listening on an internal port (33059 on this random example), dispatching a goroutine to handle
the real connections in the service IP.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang">	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">HandleCrash</span>()
		<span style="color:#a6e22e">sock</span>.<span style="color:#a6e22e">ProxyLoop</span>(<span style="color:#a6e22e">service</span>, <span style="color:#a6e22e">si</span>, <span style="color:#a6e22e">proxier</span>)
	}()
</code></pre></div>
<p>For the <code>openPortal</code> -&gt; <code>openOnePortal</code>:</p>

<img src="/posts/kproxy-modes/screen9.png" alt="" class="" style="width: 100%; ">


<p>The one can see iptables rules redirecting the service to the internal port in the node IP. Allowing traffic
coming from nodes and from containers with these rules. The last functions are not relevant here, they are
ensuring the portals are open and cleaning up the stale connections from the cache.</p>

<h3 id="connecting-to-the-service">Connecting to the service</h3>

<p>At this point we should have in the node a listen socket for kube-proxy, forwarding the request to the clusterIP
and being load balanced to the endpoint list (pods IPs).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">root@kind-control-plane:/# lsof -nP -iTCP:33059 -sTCP:LISTEN <span style="color:#f92672">&amp;&amp;</span> iptables-save | grep nginx-deployment <span style="color:#f92672">&amp;&amp;</span>  curl 10.96.232.82
COMMAND       PID USER   FD   TYPE   DEVICE SIZE/OFF NODE NAME
kube-prox <span style="color:#ae81ff">2060619</span> root   20u  IPv6 <span style="color:#ae81ff">38627113</span>      0t0  TCP *:33059 <span style="color:#f92672">(</span>LISTEN<span style="color:#f92672">)</span>
-A KUBE-PORTALS-CONTAINER -d 10.96.232.82/32 -p tcp -m comment --comment <span style="color:#e6db74">&#34;default/nginx-deployment&#34;</span> -m tcp --dport <span style="color:#ae81ff">80</span> -j REDIRECT --to-ports <span style="color:#ae81ff">33059</span>
-A KUBE-PORTALS-HOST -d 10.96.232.82/32 -p tcp -m comment --comment <span style="color:#e6db74">&#34;default/nginx-deployment&#34;</span> -m tcp --dport <span style="color:#ae81ff">80</span> -j DNAT --to-destination 172.18.0.2:33059
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
    body <span style="color:#f92672">{</span>
        width: 35em;
        margin: <span style="color:#ae81ff">0</span> auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    <span style="color:#f92672">}</span>
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://nginx.org/&#34;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://nginx.com/&#34;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you <span style="color:#66d9ef">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre></div>
<p>Not cool enough? Hitting the service from <code>10.244.0.25/24</code> pod ip, gives us the byte copy tracing...</p>

<img src="/posts/kproxy-modes/screen10.png" alt="" class="" style="width: 100%; ">


<h3 id="listening">Listening</h3>


<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/BdCV1tD4CRQ" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>


<h3 id="reference">Reference</h3>

<p>[1] <a href="https://www.jaegertracing.io/">https://www.jaegertracing.io/</a></p>

<p>[2] <a href="https://kubernetes.io/blog/2020/09/02/scaling-kubernetes-networking-with-endpointslices/">https://kubernetes.io/blog/2020/09/02/scaling-kubernetes-networking-with-endpointslices/</a></p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "blog-ak" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <script type="text/javascript" async
        src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
 MathJax.Hub.Config({
   tex2jax: {
     inlineMath: [['$','$'], ['\\(','\\)']],
     displayMath: [['$$','$$']],
     processEscapes: true,
     processEnvironments: true,
     skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
     TeX: { equationNumbers: { autoNumber: "AMS" },
            extensions: ["AMSmath.js", "AMSsymbols.js"] }
   }
 });
 MathJax.Hub.Queue(function() {
   
   
   
   var all = MathJax.Hub.getAllJax(), i;
   for(i = 0; i < all.length; i += 1) {
     all[i].SourceElement().parentNode.className += ' has-jax';
   }
 });

 MathJax.Hub.Config({
   
   TeX: { equationNumbers: { autoNumber: "AMS" } }
 });
</script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-46699622-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<footer class="bg-near-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://opssec.in/" >
    &copy; 2023 - Amim Knabben
  </a>
    <div>




<a href="https://twitter.com/ak_ndb" target="_blank" class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel="noopener" aria-label="follow on Twitter——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>




<a href="https://www.linkedin.com/in/amim/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


<a href="https://github.com/knabben/" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel="noopener" aria-label="follow on Github——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>






</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
