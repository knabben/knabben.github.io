<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>CPython Debugging | AK</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.70.0" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.1cb140d8ba31d5b2f1114537dd04802a.css" rel="stylesheet">
    

    
      <link rel="stylesheet" href="/css/custom.css">
    

    
      
    

    
    
    <meta property="og:title" content="CPython Debugging" />
<meta property="og:description" content="Introduction   Python Weekly this week bring a very cool article [1] about GDB and Python, so I thought it was a great opportunity to get into Python internals, the idea here is to understand (in more details) how Python executes your scripts and how it calls code functions.  The code is very simple, and uses the random module with two built-in functions (range and sorted), the question is: Can we via GDB see the stack of it?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://knabben.github.io/posts/cpython/" />
<meta property="article:published_time" content="2016-04-16T00:00:00+00:00" />
<meta property="article:modified_time" content="2016-04-16T00:00:00+00:00" />
<meta itemprop="name" content="CPython Debugging">
<meta itemprop="description" content="Introduction   Python Weekly this week bring a very cool article [1] about GDB and Python, so I thought it was a great opportunity to get into Python internals, the idea here is to understand (in more details) how Python executes your scripts and how it calls code functions.  The code is very simple, and uses the random module with two built-in functions (range and sorted), the question is: Can we via GDB see the stack of it?">
<meta itemprop="datePublished" content="2016-04-16T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2016-04-16T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="1108">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CPython Debugging"/>
<meta name="twitter:description" content="Introduction   Python Weekly this week bring a very cool article [1] about GDB and Python, so I thought it was a great opportunity to get into Python internals, the idea here is to understand (in more details) how Python executes your scripts and how it calls code functions.  The code is very simple, and uses the random module with two built-in functions (range and sorted), the question is: Can we via GDB see the stack of it?"/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="http://knabben.github.io/" class="f3 fw2 hover-white no-underline white-90 dib">
      AK
    </a>
    <div class="flex-l items-center">
      

      
      














    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=http://knabben.github.io/posts/cpython/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=http://knabben.github.io/posts/cpython/&amp;text=CPython%20Debugging" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http://knabben.github.io/posts/cpython/&amp;title=CPython%20Debugging" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>

      <h1 class="f1 athelas mt3 mb1">CPython Debugging</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2016-04-16T00:00:00Z">April 16, 2016</time>

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l">
<h3 id="headline-1">
Introduction 
</h3>
<p>
Python Weekly this week bring a very cool article [1] about GDB and Python, so I thought it was a great opportunity to get into Python internals, the idea here is to understand (in more details) how Python executes your scripts and how it calls code functions.
</p>
<p>
The code is very simple, and uses the random module with two built-in functions (range and sorted), the question is: Can we via GDB see the stack of it? Check it out!
</p>
<h3 id="headline-2">
The bytecode
</h3>
<p>
From the Python glossary:
</p>
<p>
Python source code is compiled into bytecode, the internal representation of a Python program in the CPython interpreter. The bytecode is also cached in .pyc and .pyo files so that executing the same file is faster the second time (recompilation from source to bytecode can be avoided). This “intermediate language” is said to run on a virtual machine that executes the machine code corresponding to each bytecode.
</p>
<p>
We can get the bytecode from Python with the dis module:
</p>
<p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> dis
<span style="color:#f92672">import</span> random

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">gen_random</span>():
    <span style="color:#66d9ef">return</span> sorted([random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">10</span>) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">10</span>)])

dis<span style="color:#f92672">.</span>dis(gen_random)


<span style="color:#ae81ff">6</span>	      <span style="color:#ae81ff">0</span> LOAD_GLOBAL              <span style="color:#ae81ff">0</span> (sorted)
		  <span style="color:#ae81ff">3</span> BUILD_LIST               <span style="color:#ae81ff">0</span>
		  <span style="color:#ae81ff">6</span> LOAD_GLOBAL              <span style="color:#ae81ff">1</span> (range)
		  <span style="color:#ae81ff">9</span> LOAD_CONST               <span style="color:#ae81ff">1</span> (<span style="color:#ae81ff">1</span>)
		 <span style="color:#ae81ff">12</span> LOAD_CONST               <span style="color:#ae81ff">2</span> (<span style="color:#ae81ff">10</span>)
		 <span style="color:#ae81ff">15</span> CALL_FUNCTION            <span style="color:#ae81ff">2</span>
		 <span style="color:#ae81ff">18</span> GET_ITER
 		 <span style="color:#ae81ff">19</span> FOR_ITER                <span style="color:#ae81ff">24</span> (to <span style="color:#ae81ff">46</span>)
		 <span style="color:#ae81ff">22</span> STORE_FAST               <span style="color:#ae81ff">0</span> (i)
		 <span style="color:#ae81ff">25</span> LOAD_GLOBAL              <span style="color:#ae81ff">2</span> (random)
		 <span style="color:#ae81ff">28</span> LOAD_ATTR                <span style="color:#ae81ff">3</span> (randint)
		 <span style="color:#ae81ff">31</span> LOAD_CONST               <span style="color:#ae81ff">1</span> (<span style="color:#ae81ff">1</span>)
		 <span style="color:#ae81ff">34</span> LOAD_CONST               <span style="color:#ae81ff">3</span> (<span style="color:#ae81ff">10</span>)
		 <span style="color:#ae81ff">37</span> CALL_FUNCTION            <span style="color:#ae81ff">2</span>
		 <span style="color:#ae81ff">40</span> LIST_APPEND              <span style="color:#ae81ff">2</span>
		 <span style="color:#ae81ff">43</span> JUMP_ABSOLUTE           <span style="color:#ae81ff">19</span>
		 <span style="color:#ae81ff">46</span> CALL_FUNCTION            <span style="color:#ae81ff">1</span>
		 <span style="color:#ae81ff">49</span> RETURN_VALUE</code></pre></div>
</p>
<p>
Here we have the bytecode that will be translated to our frame. LOAD_GLOBAL starts the function, BUILD_LIST creates a new list for the comprehension with 0 len, LOAD_CONST starts the args, it starts with the range function, storing the value of the iterator on i, after that random.randint is called CALL_FUNCTION, we are going to debug and focus on the call_function method.
</p>
<h3 id="headline-3">
Python Main
</h3>
<p>
I am using the Python 2.7.9, on Misc folder you can get the ~/.gdbinit file to give you some shortcuts on gdb, you can set a breakpoint on the main.c
</p>
<p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gdb --args python gen_random.py

gdb&gt; b Py_Main
gdb&gt; r</code></pre></div>
</p>
<p>
We are running stuff from the command line so we hit the flow PyRun_AnyFileExFlags -&gt; PyRun_SimpleFileExFlags (pythonrun.c), We can see something interesting like CPython trying to open the bytecode file first:
</p>
<p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">pythonrun.c:<span style="color:#ae81ff">936</span>

 <span style="color:#66d9ef">if</span> (maybe_pyc_file(fp, filename, ext, closeit)) {
   <span style="color:#75715e">/* Try to run a pyc file. First, re-open in binary */</span></code></pre></div>
</p>
<p>
We dont have the pyc yet, so the interpreter goes to PyRun_FileExFlags, do a (bt) command, and see that if you do a py-bt, you have nothing yet.
</p>
<p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#ae81ff">0</span>  PyRun_FileExFlags () at ..<span style="color:#f92672">/</span>Python<span style="color:#f92672">/</span>pythonrun.c:<span style="color:#ae81ff">1349</span>
<span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0x081302f5</span> in PyRun_SimpleFileExFlags () at ..<span style="color:#f92672">/</span>Python<span style="color:#f92672">/</span>pythonrun.c:<span style="color:#ae81ff">949</span>
<span style="color:#ae81ff">2</span>  <span style="color:#ae81ff">0x080daa21</span> in Py_Main () at ..<span style="color:#f92672">/</span>Modules<span style="color:#f92672">/</span>main.c:<span style="color:#ae81ff">640</span>
<span style="color:#ae81ff">3</span>  <span style="color:#ae81ff">0x080da48b</span> in main (argc<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, argv<span style="color:#f92672">=</span><span style="color:#ae81ff">0xbffff994</span>) at ..<span style="color:#f92672">/</span>Modules<span style="color:#f92672">/</span>python.c:<span style="color:#ae81ff">23</span></code></pre></div>
</p>
<p>
Cool, looks like we are almost running it, on PyParser_ASTFromFile, the interpreter is parsing the tree structure on Python syntax, it is called AST (Abstract Syntax Tree). Next, we hit the run_mod function:
</p>
<p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">static</span> PyObject <span style="color:#f92672">*</span>
<span style="color:#a6e22e">run_mod</span>(mod_ty mod, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>filename, PyObject <span style="color:#f92672">*</span>globals, PyObject <span style="color:#f92672">*</span>locals,
         PyCompilerFlags <span style="color:#f92672">*</span>flags, PyArena <span style="color:#f92672">*</span>arena)
{
    PyCodeObject <span style="color:#f92672">*</span>co;
    PyObject <span style="color:#f92672">*</span>v;
    co <span style="color:#f92672">=</span> PyAST_Compile(mod, filename, flags, arena);
    <span style="color:#66d9ef">if</span> (co <span style="color:#f92672">==</span> NULL)
        <span style="color:#66d9ef">return</span> NULL;
    v <span style="color:#f92672">=</span> PyEval_EvalCode(co, globals, locals);
    Py_DECREF(co);
    <span style="color:#66d9ef">return</span> v;
}</code></pre></div>
</p>
<h3 id="headline-4">
Python Frame
</h3>
<p>
Besides the PyAST_Compile we have the frame execution here: PyEval_EvalCode -&gt; PyEval_EvalCodeEx -&gt; PyEval_EvalFrameEx, here the magic happens, it gets all opcodes and creates a StackFrame from it, inside the EvalFrameEx we have a for(;;) loop and a switch(opcode) that iterates on all opcodes:
</p>
<p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">(gdb) bt
<span style="color:#ae81ff">0</span>  PyEval_EvalFrameEx () at ..<span style="color:#f92672">/</span>Python<span style="color:#f92672">/</span>ceval.c:<span style="color:#ae81ff">1100</span>
<span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0x08105f95</span> in PyEval_EvalCodeEx () at ..<span style="color:#f92672">/</span>Python<span style="color:#f92672">/</span>ceval.c:<span style="color:#ae81ff">3265</span>
<span style="color:#ae81ff">2</span>  <span style="color:#ae81ff">0x0813a3ec</span> in PyEval_EvalCode (
    locals<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;__builtins__&#34;</span><span style="color:#f92672">:</span>  ,<span style="color:#e6db74">&#34;__file__&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;teste.py&#34;</span>, ...
    globals<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;__builtins__&#34;</span><span style="color:#f92672">:</span> ,<span style="color:#e6db74">&#34;__file__&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;teste.py&#34;</span>, ...
<span style="color:#ae81ff">3</span>  run_mod.lto_priv () at ..<span style="color:#f92672">/</span>Python<span style="color:#f92672">/</span>pythonrun.c:<span style="color:#ae81ff">1371</span>
<span style="color:#ae81ff">4</span>  <span style="color:#ae81ff">0x08131148</span> in PyRun_FileExFlags () at ..<span style="color:#f92672">/</span>Python<span style="color:#f92672">/</span>pythonrun.c:<span style="color:#ae81ff">1357</span>
<span style="color:#ae81ff">5</span>  <span style="color:#ae81ff">0x081302f5</span> in PyRun_SimpleFileExFlags () at ..<span style="color:#f92672">/</span>Python<span style="color:#f92672">/</span>pythonrun.c:<span style="color:#ae81ff">949</span>
<span style="color:#ae81ff">6</span>  <span style="color:#ae81ff">0x080daa21</span> in Py_Main () at ..<span style="color:#f92672">/</span>Modules<span style="color:#f92672">/</span>main.c:<span style="color:#ae81ff">640</span>
<span style="color:#ae81ff">7</span>  <span style="color:#ae81ff">0x080da48b</span> in main (argc<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, argv<span style="color:#f92672">=</span><span style="color:#ae81ff">0xbffff994</span>) at ..<span style="color:#f92672">/</span>Modules<span style="color:#f92672">/</span>python.c:<span style="color:#ae81ff">23</span></code></pre></div>
</p>
<p>
On a CALL_FUNCTION opcode we have the call_function method, it have two branches a &#34;PyCFunction_Check&#34; for C functions and for Python methods &#34;PyMethod_GET_FUNCTION&#34;.
</p>
<p>
You can put a breakpoint on call_function after PyCFunction_Check. the first thing to be loaded on our code is the import random, and all the submodules like openssl, nothing very interesting here.
</p>
<p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">breakpoint <span style="color:#ae81ff">2</span>, call_function (oparg<span style="color:#f92672">=</span>, pp_stack<span style="color:#f92672">=</span>) at ..<span style="color:#f92672">/</span>Python<span style="color:#f92672">/</span>ceval.c:<span style="color:#ae81ff">4010</span>
<span style="color:#ae81ff">4010</span>            PyThreadState <span style="color:#f92672">*</span>tstate <span style="color:#f92672">=</span> PyThreadState_GET();
(gdb) py<span style="color:#f92672">-</span>bt
<span style="color:#75715e">### -- Garbage from submodules dependencies
</span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span> Frame <span style="color:#ae81ff">0xb7c93194</span>, <span style="color:#66d9ef">for</span> file <span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>python2<span style="color:#ae81ff">.7</span><span style="color:#f92672">/</span>hashlib.py, line <span style="color:#ae81ff">102</span>, ...
    f <span style="color:#f92672">=</span> getattr(_hashlib, <span style="color:#e6db74">&#34;openssl_&#34;</span> <span style="color:#f92672">+</span> name)
<span style="color:#ae81ff">4</span> Frame <span style="color:#ae81ff">0xb7cfa5ac</span>, <span style="color:#66d9ef">for</span> file <span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>python2<span style="color:#ae81ff">.7</span><span style="color:#f92672">/</span>hashlib.py, line <span style="color:#ae81ff">147</span>, in <span style="color:#f92672">&lt;</span>module<span style="color:#f92672">&gt;</span> ()
    globals()[__func_name] <span style="color:#f92672">=</span> __get_hash(__func_name)
<span style="color:#ae81ff">16</span> Frame <span style="color:#ae81ff">0xb7cd253c</span>, <span style="color:#66d9ef">for</span> file <span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>python2<span style="color:#ae81ff">.7</span><span style="color:#f92672">/</span>random.py, line <span style="color:#ae81ff">49</span>, in <span style="color:#f92672">&lt;</span>module<span style="color:#f92672">&gt;</span> ()
    import hashlib as _hashlib
<span style="color:#ae81ff">28</span> Frame <span style="color:#ae81ff">0xb7d10d4c</span>, <span style="color:#66d9ef">for</span> file teste.py, line <span style="color:#ae81ff">1</span>, in <span style="color:#f92672">&lt;</span>module<span style="color:#f92672">&gt;</span> ()
    import random

(gdb) bt
<span style="color:#75715e">### -- Top of the call_function, here it will choose what to run based on the AST code
</span><span style="color:#75715e"></span><span style="color:#ae81ff">0</span>  call_function (oparg<span style="color:#f92672">=&lt;&gt;</span>, pp_stack<span style="color:#f92672">=&lt;&gt;</span>) at ..<span style="color:#f92672">/</span>Python<span style="color:#f92672">/</span>ceval.c:<span style="color:#ae81ff">4010</span>
<span style="color:#ae81ff">1</span>  PyEval_EvalFrameEx () at ..<span style="color:#f92672">/</span>Python<span style="color:#f92672">/</span>ceval.c:<span style="color:#ae81ff">2679</span>
<span style="color:#ae81ff">2</span>  <span style="color:#ae81ff">0x081078bb</span> in fast_function (nk<span style="color:#f92672">=&lt;&gt;</span>, na<span style="color:#f92672">=</span>...
    func<span style="color:#f92672">=&lt;</span>optimized out<span style="color:#f92672">&gt;</span>) at ..<span style="color:#f92672">/</span>Python<span style="color:#f92672">/</span>ceval.c:<span style="color:#ae81ff">4119</span>
<span style="color:#ae81ff">3</span>  call_function (oparg<span style="color:#f92672">=&lt;</span>optimized out<span style="color:#f92672">&gt;</span>, ...
<span style="color:#ae81ff">4</span>  PyEval_EvalFrameEx () at ..<span style="color:#f92672">/</span>Python<span style="color:#f92672">/</span>ceval.c:<span style="color:#ae81ff">2679</span>
<span style="color:#ae81ff">5</span>  <span style="color:#ae81ff">0x08105f95</span> in PyEval_EvalCodeEx () at ..<span style="color:#f92672">/</span>Python<span style="color:#f92672">/</span>ceval.c:<span style="color:#ae81ff">3265</span>
<span style="color:#ae81ff">6</span>  <span style="color:#ae81ff">0x08105952</span> in PyEval_EvalCode (co<span style="color:#f92672">=</span><span style="color:#ae81ff">0xb7ca4410</span>,</code></pre></div>
</p>
<h3 id="headline-5">
Modules and built-in
</h3>
<p>
Hit some continue gdb commands, you can see the <span style="text-decoration: underline;"><span style="text-decoration: underline;">init</span></span> seeding the random module.
</p>
<p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">(gdb) py<span style="color:#f92672">-</span>bt
<span style="color:#ae81ff">1</span> Frame <span style="color:#ae81ff">0xb7c93194</span>, <span style="color:#66d9ef">for</span> file <span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>python2<span style="color:#ae81ff">.7</span><span style="color:#f92672">/</span>random.py, line <span style="color:#ae81ff">118</span>, in seed
    super(Random, self).seed(a)
<span style="color:#ae81ff">5</span> Frame <span style="color:#ae81ff">0xb7cf258c</span>, <span style="color:#66d9ef">for</span> file <span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>python2<span style="color:#ae81ff">.7</span><span style="color:#f92672">/</span>random.py, line <span style="color:#ae81ff">97</span>, in __init__
    self.seed(x)
<span style="color:#ae81ff">16</span> Frame <span style="color:#ae81ff">0xb7cd253c</span>, <span style="color:#66d9ef">for</span> file <span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>python2<span style="color:#ae81ff">.7</span><span style="color:#f92672">/</span>random.py, line <span style="color:#ae81ff">885</span>, in <span style="color:#f92672">&lt;</span>module<span style="color:#f92672">&gt;</span> ()
    _inst <span style="color:#f92672">=</span> Random()</code></pre></div>
</p>
<p>
Keep digging! We are going to get some built-in functions, lets say: sorted.
</p>
<p>
It is a built-in method so the bt-py keeps on the oneline frame, but C backtrace hits the bltinmodule.c via a call_function.
</p>
<p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">(gdb) py<span style="color:#f92672">-</span>bt
<span style="color:#ae81ff">2</span> Frame <span style="color:#ae81ff">0xb7c93464</span>, <span style="color:#66d9ef">for</span> file teste.py, line <span style="color:#ae81ff">4</span>, in gen_random (i<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
    <span style="color:#66d9ef">return</span> sorted([random.randint(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">10</span>) <span style="color:#66d9ef">for</span> i in range(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>)])
<span style="color:#ae81ff">5</span> Frame <span style="color:#ae81ff">0xb7d10d4c</span>, <span style="color:#66d9ef">for</span> file teste.py, line <span style="color:#ae81ff">6</span>, in <span style="color:#f92672">&lt;</span>module<span style="color:#f92672">&gt;</span> ()
    print(gen_random())

(gdb) bt
<span style="color:#ae81ff">0</span>  builtin_sorted.lto_priv () at ..<span style="color:#f92672">/</span>Python<span style="color:#f92672">/</span>bltinmodule.c:<span style="color:#ae81ff">2217</span>
<span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0x0810739d</span> in call_function (oparg<span style="color:#f92672">=&lt;&gt;</span>, pp_stack<span style="color:#f92672">=&lt;&gt;</span>) at ..<span style="color:#f92672">/</span>Python<span style="color:#f92672">/</span>ceval.c:<span style="color:#ae81ff">4033</span>
<span style="color:#ae81ff">2</span>  PyEval_EvalFrameEx () at ..<span style="color:#f92672">/</span>Python<span style="color:#f92672">/</span>ceval.c:<span style="color:#ae81ff">2679</span></code></pre></div>
</p>
<p>
Thats very interesting, this buildin_sorted comes from:
</p>
<p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">Python<span style="color:#f92672">/</span>ceval.c <span style="color:#f92672">-</span> call_function

C_TRACE(x, PyCFunction_Call(func,callargs,NULL))

On Objects<span style="color:#f92672">/</span>methodobject.c <span style="color:#f92672">-</span> PyCFunction_call

PyCFunction meth <span style="color:#f92672">=</span> PyCFunction_GET_FUNCTION(func);
<span style="color:#66d9ef">case</span> METH_OLDARGS <span style="color:#f92672">|</span> METH_KEYWORDS:
	<span style="color:#66d9ef">return</span> (<span style="color:#f92672">*</span>(PyCFunctionWithKeywords)meth)(self, arg, kw);</code></pre></div>
</p>
<p>
The bltinmodule.c:buildin_sorted:2245 function now calls a PyObject_Call with our list as a parameter for the method listsort.
</p>
<p>
After more walkthrough, we can get the algorithm that Python uses to order lists: Objects/listobject.c (listsort)
</p>
<p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">/* An adaptive, stable, natural mergesort.  See listsort.txt.
</span><span style="color:#75715e"> * Returns Py_None on success, NULL on error.  Even in case of error, the
</span><span style="color:#75715e"> * list will be some permutation of its input state (nothing is lost or
</span><span style="color:#75715e"> * duplicated).
</span><span style="color:#75715e"> */</span>

<span style="color:#ae81ff">0</span>  listsort.lto_priv () at ..<span style="color:#f92672">/</span>Objects<span style="color:#f92672">/</span>listobject.c:<span style="color:#ae81ff">2069</span>
<span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">0x0816f4d1</span> in PyObject_Call (kw<span style="color:#f92672">=</span><span style="color:#ae81ff">0x0</span>, arg<span style="color:#f92672">=</span>(), func<span style="color:#f92672">=&lt;&gt;</span>) at ..<span style="color:#f92672">/</span>Objects<span style="color:#f92672">/</span>abstract.c:<span style="color:#ae81ff">2529</span>
<span style="color:#ae81ff">2</span>  builtin_sorted.lto_priv () at ..<span style="color:#f92672">/</span>Python<span style="color:#f92672">/</span>bltinmodule.c:<span style="color:#ae81ff">2245</span>
<span style="color:#ae81ff">3</span>  <span style="color:#ae81ff">0x0810739d</span> in call_function (oparg<span style="color:#f92672">=&lt;</span>optimized out<span style="color:#f92672">&gt;</span>, pp_stack<span style="color:#f92672">=&lt;</span>optimized out<span style="color:#f92672">&gt;</span>) at ..<span style="color:#f92672">/</span>Python<span style="color:#f92672">/</span>ceval.c:<span style="color:#ae81ff">4033</span></code></pre></div>
</p>
<h3 id="headline-6">
Listening
</h3>
<p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/XsB0HDBsNbI" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

</p>
<h3 id="headline-7">
Reference
</h3>
<h6 id="headline-8">
[1] <a href="http://podoliaka.org/2016/04/10/debugging-cpython-gdb/">http://podoliaka.org/2016/04/10/debugging-cpython-gdb/</a>
</h6>
<h6 id="headline-9">
[2] <a href="https://wiki.python.org/moin/DebuggingWithGdb">https://wiki.python.org/moin/DebuggingWithGdb</a>
</h6>
<h6 id="headline-10">
[3] <a href="http://fedoraproject.org/wiki/Features/EasierPythonDebugging">http://fedoraproject.org/wiki/Features/EasierPythonDebugging</a>
</h6>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <script type="text/javascript" async
        src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
 MathJax.Hub.Config({
   tex2jax: {
     inlineMath: [['$','$'], ['\\(','\\)']],
     displayMath: [['$$','$$']],
     processEscapes: true,
     processEnvironments: true,
     skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
     TeX: { equationNumbers: { autoNumber: "AMS" },
            extensions: ["AMSmath.js", "AMSsymbols.js"] }
   }
 });
 MathJax.Hub.Queue(function() {
   
   
   
   var all = MathJax.Hub.getAllJax(), i;
   for(i = 0; i < all.length; i += 1) {
     all[i].SourceElement().parentNode.className += ' has-jax';
   }
 });

 MathJax.Hub.Config({
   
   TeX: { equationNumbers: { autoNumber: "AMS" } }
 });
</script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-46699622-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<footer class="bg-near-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://knabben.github.io/" >
    &copy; 2020 AK
  </a>
    <div>













</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
