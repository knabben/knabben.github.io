<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>AK  | Kubernetes Audit Sink</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.54.0" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.e08a958ae3e530145318b6373195c765.css" rel="stylesheet">
    

    
      <link rel="stylesheet" href="/css/custom.css">
    

    
      
    

    

    <meta property="og:title" content="Kubernetes Audit Sink" />
<meta property="og:description" content="Introduction The idea of this post is to test the Audit dynamic backend with a KIND cluster.
Kubernetes has 4 stages:
RequestReceived - The stage for events generated as soon as the audit handler receives the request, and before it is delegated down the handler chain. ResponseStarted - Once the response headers are sent, but before the response body is sent. This stage is only generated for long-running requests (e.g. watch)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://knabben.github.io/posts/kube-audit/" />
<meta property="article:published_time" content="2019-11-27T10:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2019-11-27T10:00:00&#43;00:00"/>

<meta itemprop="name" content="Kubernetes Audit Sink">
<meta itemprop="description" content="Introduction The idea of this post is to test the Audit dynamic backend with a KIND cluster.
Kubernetes has 4 stages:
RequestReceived - The stage for events generated as soon as the audit handler receives the request, and before it is delegated down the handler chain. ResponseStarted - Once the response headers are sent, but before the response body is sent. This stage is only generated for long-running requests (e.g. watch).">


<meta itemprop="datePublished" content="2019-11-27T10:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-11-27T10:00:00&#43;00:00" />
<meta itemprop="wordCount" content="388">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kubernetes Audit Sink"/>
<meta name="twitter:description" content="Introduction The idea of this post is to test the Audit dynamic backend with a KIND cluster.
Kubernetes has 4 stages:
RequestReceived - The stage for events generated as soon as the audit handler receives the request, and before it is delegated down the handler chain. ResponseStarted - Once the response headers are sent, but before the response body is sent. This stage is only generated for long-running requests (e.g. watch)."/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="http://knabben.github.io/" class="f3 fw2 hover-white no-underline white-90 dib">
      AK
    </a>
    <div class="flex-l items-center">
      
      









    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  <article class="flex-l flex-wrap justify-between mw8 center ph3 ph0-l">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        POSTS
      </p>
      <h1 class="f1 athelas mb1">Kubernetes Audit Sink</h1>
      
      <time class="f6 mv4 dib tracked" datetime="2019-11-27T10:00:00Z">November 27, 2019</time>
    </header>

    <main class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><h3 id="introduction">Introduction</h3>

<p>The idea of this post is to test the Audit dynamic backend with a KIND cluster.</p>

<p>Kubernetes has 4 stages:</p>

<h5 id="requestreceived-the-stage-for-events-generated-as-soon-as-the-audit-handler-receives-the-request-and-before-it-is-delegated-down-the-handler-chain">RequestReceived - The stage for events generated as soon as the audit handler receives the request, and before it is delegated down the handler chain.</h5>

<h5 id="responsestarted-once-the-response-headers-are-sent-but-before-the-response-body-is-sent-this-stage-is-only-generated-for-long-running-requests-e-g-watch">ResponseStarted - Once the response headers are sent, but before the response body is sent. This stage is only generated for long-running requests (e.g. watch).</h5>

<h5 id="responsecomplete-the-response-body-has-been-completed-and-no-more-bytes-will-be-sent">ResponseComplete - The response body has been completed and no more bytes will be sent.</h5>

<h5 id="panic-events-generated-when-a-panic-occurred">Panic - Events generated when a panic occurred.</h5>

<p>And 4 levels:</p>

<h5 id="none-don-t-log-events-that-match-this-rule">None - donâ€™t log events that match this rule.</h5>

<h5 id="metadata-log-request-metadata-requesting-user-timestamp-resource-verb-etc-but-not-request-or-response-body">Metadata - log request metadata (requesting user, timestamp, resource, verb, etc.) but not request or response body.</h5>

<h5 id="request-log-event-metadata-and-request-body-but-not-response-body-this-does-not-apply-for-non-resource-requests">Request - log event metadata and request body but not response body. This does not apply for non-resource requests.</h5>

<h5 id="requestresponse-log-event-metadata-request-and-response-bodies-this-does-not-apply-for-non-resource-requests">RequestResponse - log event metadata, request and response bodies. This does not apply for non-resource requests.</h5>

<h3 id="configuring-kind">Configuring Kind</h3>

<p>It is possible to overwrite the kubeadm configuration passing multiple extra args for the REST API server,
to enable this it is necessary to create the following flags:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#75715e"># config.yaml</span>

kind: Cluster
apiVersion: kind.sigs.k8s.io/v1alpha3
kubeadmConfigPatches:
- <span style="color:#e6db74">|
</span><span style="color:#e6db74">  apiVersion: kubeadm.k8s.io/v1beta2</span>
  kind: ClusterConfiguration
  metadata:
    name: config
  apiServer:
    extraArgs:
      feature-gates: <span style="color:#e6db74">&#34;DynamicAuditing=true&#34;</span>
      audit-dynamic-configuration: <span style="color:#e6db74">&#34;true&#34;</span>
      runtime-config: <span style="color:#e6db74">&#34;auditregistration.k8s.io/v1alpha1=true&#34;</span></code></pre></div>

<h3 id="configuring-the-audit-sink">Configuring the Audit Sink</h3>

<p>It's possible to set the level and stage per URL configuration setting the host these filtered events go,
for filtering rules the parameter --audit-policy-file must be set with Policy file.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#75715e"># audit.yaml</span>

apiVersion: auditregistration.k8s.io/v1alpha1
kind: AuditSink
metadata:
  name: mysink
spec:
  policy:
    level: Metadata
    stages:
    - ResponseComplete
  webhook:
    throttle:
      qps: <span style="color:#ae81ff">10</span>
      burst: <span style="color:#ae81ff">15</span>
    clientConfig:
      url: <span style="color:#e6db74">&#34;https://generic-web-site/hook&#34;</span></code></pre></div>

<h3 id="starting-kind">Starting kind</h3>

<p>To start the KIND with the configuration file and setup the Audit Sink:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ kind create cluster --config config.yaml
$ kubectl create -f audit.yaml</code></pre></div>

<p>This is an example from the KIND cluster:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">{
  <span style="color:#e6db74">&#34;kind&#34;</span>: <span style="color:#e6db74">&#34;EventList&#34;</span>,
  <span style="color:#e6db74">&#34;apiVersion&#34;</span>: <span style="color:#e6db74">&#34;audit.k8s.io/v1&#34;</span>,
  <span style="color:#e6db74">&#34;metadata&#34;</span>: {},
  <span style="color:#e6db74">&#34;items&#34;</span>: [
    {
      <span style="color:#e6db74">&#34;level&#34;</span>: <span style="color:#e6db74">&#34;Metadata&#34;</span>,
      <span style="color:#e6db74">&#34;auditID&#34;</span>: <span style="color:#e6db74">&#34;73e1e2e3-5a68-460e-8aa8-aece72ffacb3&#34;</span>,
      <span style="color:#e6db74">&#34;stage&#34;</span>: <span style="color:#e6db74">&#34;ResponseComplete&#34;</span>,
      <span style="color:#e6db74">&#34;requestURI&#34;</span>: <span style="color:#e6db74">&#34;/api/v1/namespaces/kube-system/endpoints/kube-scheduler?timeout=10s&#34;</span>,
      <span style="color:#e6db74">&#34;verb&#34;</span>: <span style="color:#e6db74">&#34;update&#34;</span>,
      <span style="color:#e6db74">&#34;user&#34;</span>: {
        <span style="color:#e6db74">&#34;username&#34;</span>: <span style="color:#e6db74">&#34;system:kube-scheduler&#34;</span>,
        <span style="color:#e6db74">&#34;groups&#34;</span>: [
          <span style="color:#e6db74">&#34;system:authenticated&#34;</span>
        ]
      },
      <span style="color:#e6db74">&#34;sourceIPs&#34;</span>: [
        <span style="color:#e6db74">&#34;172.17.0.3&#34;</span>
      ],
      <span style="color:#e6db74">&#34;userAgent&#34;</span>: <span style="color:#e6db74">&#34;kube-scheduler/v1.16.3 (linux/amd64) kubernetes/b3cbbae/leader-election&#34;</span>,
      <span style="color:#e6db74">&#34;objectRef&#34;</span>: {
        <span style="color:#e6db74">&#34;resource&#34;</span>: <span style="color:#e6db74">&#34;endpoints&#34;</span>,
        <span style="color:#e6db74">&#34;namespace&#34;</span>: <span style="color:#e6db74">&#34;kube-system&#34;</span>,
        <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;kube-scheduler&#34;</span>,
        <span style="color:#e6db74">&#34;uid&#34;</span>: <span style="color:#e6db74">&#34;5bfc44f4-b62f-4395-99d0-9c24e1ee1b83&#34;</span>,
        <span style="color:#e6db74">&#34;apiVersion&#34;</span>: <span style="color:#e6db74">&#34;v1&#34;</span>,
        <span style="color:#e6db74">&#34;resourceVersion&#34;</span>: <span style="color:#e6db74">&#34;460&#34;</span>
      },
      <span style="color:#e6db74">&#34;responseStatus&#34;</span>: {
        <span style="color:#e6db74">&#34;metadata&#34;</span>: {},
        <span style="color:#e6db74">&#34;code&#34;</span>: <span style="color:#ae81ff">200</span>
      },
      <span style="color:#e6db74">&#34;requestReceivedTimestamp&#34;</span>: <span style="color:#e6db74">&#34;2019-11-28T02:32:01.690713Z&#34;</span>,
      <span style="color:#e6db74">&#34;stageTimestamp&#34;</span>: <span style="color:#e6db74">&#34;2019-11-28T02:32:01.693278Z&#34;</span>,
      <span style="color:#e6db74">&#34;annotations&#34;</span>: {
        <span style="color:#e6db74">&#34;authorization.k8s.io/decision&#34;</span>: <span style="color:#e6db74">&#34;allow&#34;</span>,
        <span style="color:#e6db74">&#34;authorization.k8s.io/reason&#34;</span>: <span style="color:#e6db74">&#34;RBAC: allowed by ClusterRoleBinding \&#34;system:kube-scheduler\&#34; of ClusterRole \&#34;system:kube-scheduler\&#34; to User \&#34;system:kube-scheduler\&#34;&#34;</span>
      }
    }
  ]
}</code></pre></div>
<ul class="pa0">
  
</ul>
<div class="mt6">
        
      </div>
    </main>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <script type="text/javascript" async
        src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
 MathJax.Hub.Config({
   tex2jax: {
     inlineMath: [['$','$'], ['\\(','\\)']],
     displayMath: [['$$','$$']],
     processEscapes: true,
     processEnvironments: true,
     skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
     TeX: { equationNumbers: { autoNumber: "AMS" },
            extensions: ["AMSmath.js", "AMSsymbols.js"] }
   }
 });
 MathJax.Hub.Queue(function() {
   
   
   
   var all = MathJax.Hub.getAllJax(), i;
   for(i = 0; i < all.length; i += 1) {
     all[i].SourceElement().parentNode.className += ' has-jax';
   }
 });

 MathJax.Hub.Config({
   
   TeX: { equationNumbers: { autoNumber: "AMS" } }
 });
</script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-46699622-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<footer class="bg-near-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://knabben.github.io/" >
    &copy; 2019 AK
  </a>
    <div>








</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
