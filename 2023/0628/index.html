<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.113.0">
    <meta name="description" content="Debugging Istio CNI on Ambient mesh">


    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Istio CNI on Ambient Mesh :: compulsory thinking</title>

    
    <link href="/css/nucleus.css?1755000526" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1755000526" rel="stylesheet">
    <link href="/css/hybrid.css?1755000526" rel="stylesheet">
    <link href="/css/featherlight.min.css?1755000526" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1755000526" rel="stylesheet">
    <link href="/css/auto-complete.css?1755000526" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1755000526" rel="stylesheet">
    <link href="/css/theme.css?1755000526" rel="stylesheet">
    <link href="/css/tabs.css?1755000526" rel="stylesheet">
    <link href="/css/hugo-theme.css?1755000526" rel="stylesheet">
    
    <link href="/css/theme-blue.css?1755000526" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1755000526"></script>
      
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SXHZPRXGDZ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-SXHZPRXGDZ');
    </script>
    <script>
    if (location.host.indexOf("localhost") < 0 && location.protocol !== "https:") {
      location.protocol = "https:";
    }
    </script>
    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/2023/0628/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href='/'>
  עֹז
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1755000526"></script>
<script type="text/javascript" src="/js/auto-complete.js?1755000526"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/opssec.in\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1755000526"></script>

    
  </div>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/2025/" title="2025" class="dd-item
        
        
        
        ">
      <a href="/2025/">
          2025
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/2025/0812/" title="Embracing Vibe Ops: AI-Driven Troubleshooting for ClusterAPI" class="dd-item
        
        
        
        ">
      <a href="/2025/0812/">
          Embracing Vibe Ops: AI-Driven Troubleshooting for ClusterAPI
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2024/" title="2024" class="dd-item
        
        
        
        ">
      <a href="/2024/">
          2024
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/2024/0201/" title="Kubernetes vSphere CSI on Windows" class="dd-item
        
        
        
        ">
      <a href="/2024/0201/">
          Kubernetes vSphere CSI on Windows
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2024/0104/" title="Kubernetes Windows Nodes" class="dd-item
        
        
        
        ">
      <a href="/2024/0104/">
          Kubernetes Windows Nodes
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2023/" title="2023" class="dd-item
        parent
        
        
        ">
      <a href="/2023/">
          2023
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/2023/1230/" title="Running Windows cluster locally" class="dd-item
        
        
        
        ">
      <a href="/2023/1230/">
          Running Windows cluster locally
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0801/" title="sigstore policy-controller validation" class="dd-item
        
        
        
        ">
      <a href="/2023/0801/">
          sigstore policy-controller validation
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0721/" title="Ztunnel SPIRE implementation" class="dd-item
        
        
        
        ">
      <a href="/2023/0721/">
          Ztunnel SPIRE implementation
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0702/" title="Waypoint Proxy for the app layer" class="dd-item
        
        
        
        ">
      <a href="/2023/0702/">
          Waypoint Proxy for the app layer
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0630/" title="Ztunnel on Ambient Mesh" class="dd-item
        
        
        
        ">
      <a href="/2023/0630/">
          Ztunnel on Ambient Mesh
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0628/" title="Istio CNI on Ambient Mesh" class="dd-item
        
        active
        
        ">
      <a href="/2023/0628/">
          Istio CNI on Ambient Mesh
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0622/" title="Istio Ambient Service Mesh Demo" class="dd-item
        
        
        
        ">
      <a href="/2023/0622/">
          Istio Ambient Service Mesh Demo
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0611/" title="SPIFFE/SPIRE for gRPC authz" class="dd-item
        
        
        
        ">
      <a href="/2023/0611/">
          SPIFFE/SPIRE for gRPC authz
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0608/" title="Secure gRPC services with mTLS" class="dd-item
        
        
        
        ">
      <a href="/2023/0608/">
          Secure gRPC services with mTLS
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0406/" title="Windows CNI tracing and deep dive" class="dd-item
        
        
        
        ">
      <a href="/2023/0406/">
          Windows CNI tracing and deep dive
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0330/" title="Windows Containers and .NET apps" class="dd-item
        
        
        
        ">
      <a href="/2023/0330/">
          Windows Containers and .NET apps
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0322/" title="Multi AZ on Kubernetes and vSphere" class="dd-item
        
        
        
        ">
      <a href="/2023/0322/">
          Multi AZ on Kubernetes and vSphere
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2022/" title="2022" class="dd-item
        
        
        
        ">
      <a href="/2022/">
          2022
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/2022/0712/" title="Hybrid nodes with ClusterClass on Amazon Web Service" class="dd-item
        
        
        
        ">
      <a href="/2022/0712/">
          Hybrid nodes with ClusterClass on Amazon Web Service
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2022/0610/" title="Border Gateway Protocol (BGP) and Kubernetes" class="dd-item
        
        
        
        ">
      <a href="/2022/0610/">
          Border Gateway Protocol (BGP) and Kubernetes
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2022/0320/" title="Cluster API Provider for Azure" class="dd-item
        
        
        
        ">
      <a href="/2022/0320/">
          Cluster API Provider for Azure
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2022/0122/" title="Kube-Proxy Next Gen Windows Userspace" class="dd-item
        
        
        
        ">
      <a href="/2022/0122/">
          Kube-Proxy Next Gen Windows Userspace
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2021/" title="2021" class="dd-item
        
        
        
        ">
      <a href="/2021/">
          2021
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/2021/1218/" title="Kube-proxy Windows Kernelspace Mode" class="dd-item
        
        
        
        ">
      <a href="/2021/1218/">
          Kube-proxy Windows Kernelspace Mode
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2021/1127/" title="Kube-proxy Linux Userspace Mode" class="dd-item
        
        
        
        ">
      <a href="/2021/1127/">
          Kube-proxy Linux Userspace Mode
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2021/1017/" title="Kube-proxy Winuserspace Mode" class="dd-item
        
        
        
        ">
      <a href="/2021/1017/">
          Kube-proxy Winuserspace Mode
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2021/0903/" title="Windows and Calico overlay networking" class="dd-item
        
        
        
        ">
      <a href="/2021/0903/">
          Windows and Calico overlay networking
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2021/0828/" title="CNI plugins and kindnet" class="dd-item
        
        
        
        ">
      <a href="/2021/0828/">
          CNI plugins and kindnet
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2021/0614/" title="Kube-proxy ClusterIP" class="dd-item
        
        
        
        ">
      <a href="/2021/0614/">
          Kube-proxy ClusterIP
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2021/0228/" title="Kubernetes Windows Nodes" class="dd-item
        
        
        
        ">
      <a href="/2021/0228/">
          Kubernetes Windows Nodes
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2020/" title="2020" class="dd-item
        
        
        
        ">
      <a href="/2020/">
          2020
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/2020/1227/" title="Network Policy E2E test suite" class="dd-item ">
        <a href="/2020/1227/">
        Network Policy E2E test suite
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2020/2405/" title="Kubelet Dynamic Configuration" class="dd-item ">
        <a href="/2020/2405/">
        Kubelet Dynamic Configuration
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2020/1005/" title="Kubelet Debugging Session" class="dd-item ">
        <a href="/2020/1005/">
        Kubelet Debugging Session
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2019/" title="2019" class="dd-item
        
        
        
        ">
      <a href="/2019/">
          2019
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/2019/1228/" title="Kubernetes Networking 101" class="dd-item ">
        <a href="/2019/1228/">
        Kubernetes Networking 101
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2019/12282/" title="Kubernetes Deployment Workloads" class="dd-item ">
        <a href="/2019/12282/">
        Kubernetes Deployment Workloads
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2019/12283/" title="Kubernetes Container API" class="dd-item ">
        <a href="/2019/12283/">
        Kubernetes Container API
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2019/1227/" title="Pod specification" class="dd-item ">
        <a href="/2019/1227/">
        Pod specification
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2019/1226/" title="Kubectl Walkthrough" class="dd-item ">
        <a href="/2019/1226/">
        Kubectl Walkthrough
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2019/1225/" title="Kubernetes in Docker" class="dd-item ">
        <a href="/2019/1225/">
        Kubernetes in Docker
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2019/1215/" title="Sawtooth Cheatsheet" class="dd-item ">
        <a href="/2019/1215/">
        Sawtooth Cheatsheet
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2019/1208/" title="Sawtooth Permissioning" class="dd-item ">
        <a href="/2019/1208/">
        Sawtooth Permissioning
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2019/1127/" title="Kubernetes Audit Sink" class="dd-item ">
        <a href="/2019/1127/">
        Kubernetes Audit Sink
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2019/1123/" title="Kubernetes API client" class="dd-item ">
        <a href="/2019/1123/">
        Kubernetes API client
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2019/11161/dev-poet/" title="From Dev to PoET" class="dd-item ">
        <a href="/2019/11161/dev-poet/">
        From Dev to PoET
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2019/1116/" title="Sawtooth Network Monitoring" class="dd-item ">
        <a href="/2019/1116/">
        Sawtooth Network Monitoring
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2019/1111/" title="Gossip networks" class="dd-item ">
        <a href="/2019/1111/">
        Gossip networks
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2018/" title="2018" class="dd-item
        
        
        
        ">
      <a href="/2018/">
          2018
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/2018/08072/" title="Golang essays (part II)" class="dd-item ">
        <a href="/2018/08072/">
        Golang essays (part II)
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2018/0807/" title="Golang essays (part I)" class="dd-item ">
        <a href="/2018/0807/">
        Golang essays (part I)
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2018/0704/langs2/" title="Rust 101" class="dd-item ">
        <a href="/2018/0704/langs2/">
        Rust 101
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2018/0602/sawtooth/" title="Hyperledger Sawtooth" class="dd-item ">
        <a href="/2018/0602/sawtooth/">
        Hyperledger Sawtooth
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2018/0527/langs1/" title="Bootstraping languages" class="dd-item ">
        <a href="/2018/0527/langs1/">
        Bootstraping languages
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2018/0806/" title="Service Mesh" class="dd-item ">
        <a href="/2018/0806/">
        Service Mesh
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2018/0325/" title="Technical indicators" class="dd-item ">
        <a href="/2018/0325/">
        Technical indicators
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2017/" title="2017" class="dd-item
        
        
        
        ">
      <a href="/2017/">
          2017
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/2017/1012/" title="More statistics and Python" class="dd-item ">
        <a href="/2017/1012/">
        More statistics and Python
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2017/0701/" title="Probability" class="dd-item ">
        <a href="/2017/0701/">
        Probability
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2017/0625/" title="Statistics and Python" class="dd-item ">
        <a href="/2017/0625/">
        Statistics and Python
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2016/" title="2016" class="dd-item
        
        
        
        ">
      <a href="/2016/">
          2016
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/2016/1216/apk/" title="Android APK hacking" class="dd-item ">
        <a href="/2016/1216/apk/">
        Android APK hacking
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2016/1127/" title="Continuous Deployment and DEIS" class="dd-item ">
        <a href="/2016/1127/">
        Continuous Deployment and DEIS
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2016/0618/ecto/" title="Ecto vs. Django ORM" class="dd-item ">
        <a href="/2016/0618/ecto/">
        Ecto vs. Django ORM
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2016/0416/cpython/" title="CPython Debugging" class="dd-item ">
        <a href="/2016/0416/cpython/">
        CPython Debugging
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2016/0123/" title="Golang vs. Python" class="dd-item ">
        <a href="/2016/0123/">
        Golang vs. Python
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2016/0116/" title="Monitoring MySQL w/ Prometheus" class="dd-item ">
        <a href="/2016/0116/">
        Monitoring MySQL w/ Prometheus
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2015/" title="2015" class="dd-item
        
        
        
        ">
      <a href="/2015/">
          2015
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/2015/0309/consul/" title="Consul - Service Discovery" class="dd-item ">
        <a href="/2015/0309/consul/">
        Consul - Service Discovery
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2015/0908/finance/" title="General finance formulas" class="dd-item ">
        <a href="/2015/0908/finance/">
        General finance formulas
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/2015/2607/" title="Tsung Capacity Test" class="dd-item ">
        <a href="/2015/2607/">
        Tsung Capacity Test
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
        
    </ul>

    
    

    
    <section id="footer">
      <center>
  <p><b>Amim Knabben</b> - 2024</p>
    amim.knabben@gmail.com
  <br/>
  <a href="https://github.com/knabben"><i class="fab fa-github"></i></a>
  <a href="https://twitter.com/ak_ndb"><i class="fab fa-twitter"></i></a>
  <a href="https://linkedin.com/in/amim"><i class="fab fa-linkedin"></i></a>
  <br />
  <br />

  <a href="https://md.opssec.in">win32 API </i></a>

</center>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/'></a> > <a href='/2023/'>2023</a> > Istio CNI on Ambient Mesh
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a>
      <ul>
        <li><a href="#architecture">Architecture</a></li>
        <li><a href="#ztunnel">Ztunnel</a></li>
        <li><a href="#installing-istio-cni">Installing istio-cni</a></li>
        <li><a href="#istio-cni">istio-cni</a></li>
        <li><a href="#pods-in-other-nodes">Pods in other nodes</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Istio CNI on Ambient Mesh
            </h1>
          

        



	<h2 id="introduction">Introduction</h2>
<p>From <a href="https://www.solo.io/resources/ebook/istio-ambient-mesh-explained/">Istio Ambient Explained</a> - Istio CNI handles traffic redirection for sidecars.
Istio ambient extends this CNI plug-in for scenarios where there is no sidecar and the mTLS
running on the node needs to handle the traffic (both incoming and outgoing). In Istio
ambient, the Istio CNI plug-in installs redirection rules (based on iptables/ebpf are a WIP still)
that captures traffic for workloads considered part of the ambient mesh, and redirects to the
ztunnel running on the node.</p>
<p>For the version on Ambient the <code>istio-cni</code> installed on <code>/opt/cni/bin/</code> is installed on each node
and will setup the networking rules, instead of being injected as <code>initContainers</code> as in the old approach.
This is required for communication encryption and interception in the mesh.</p>
<h3 id="architecture">Architecture</h3>
<p>The following diagrams presents the sequence of events inside the <code>install-cni</code> container that comes up
when <code>istioctl</code> is used. As pods are added or removed the plug-in will dynamically update the
redirection rules.</p>

<div class="mermaid" align="center">
graph LR;

    NewServer-->setupHandlers
    setupHandlers-->Reconcile
    Reconcile-->ReconcileZtunnel
    
    NewServer-->UpdateConfig
    NewServer-->server
    server-->Start[Start]

    ReconcileZtunnel-->cleanupNode
    ReconcileZtunnel-->CreateRulesOnNode
    ReconcileZtunnel-->CreateRulesWithinNodeProxyNS


  classDef ctrl fill:#1568ca,color:white,stroke-width:1px,stroke:#dbffff
  classDef normal fill:#007cff,color:white,stroke-width:1px,stroke:#
  classDef cluster fill:#fff,stroke:#bbb,stroke-width:2px,color:#326ce5;
  classDef cluster fill:#fff,stroke:#bbb,stroke-width:2px,color:#326ce5;

  class NewServer,ReconcileZtunnel ctrl;
  class UpdateConfig,server,setupHandlers,cleanupNode,CreateRulesOnNode,CreateRulesWithinNodeProxyNS cluster; 
  class Reconcile,Start normal;
</div>

<p><code>NewServer</code> when ambient is enabled a new CNI ambient server is started. <code>setupHandlers</code>
will start the informers for pod and namespace where ambient is enabled, on this
case only <code>default</code> is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2023-06-28T00:00:12.005195Z	info	ambient	HostIP<span style="color:#f92672">=</span>10.244.1.1
</span></span><span style="display:flex;"><span>2023-06-28T00:00:12.005250Z	debug	ambient	Generating new ambient config file
</span></span><span style="display:flex;"><span>2023-06-28T00:00:12.005274Z	info	ambient	Writing ambient config: <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;ztunnelReady&#34;</span>:false,<span style="color:#e6db74">&#34;redirectMode&#34;</span>:<span style="color:#e6db74">&#34;iptables&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>2023-06-28T00:00:12.005433Z	debug	ambient	Done
</span></span><span style="display:flex;"><span>2023-06-28T00:00:12.005439Z	debug	ambient	CNI ambient server starting
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2023-06-28T00:00:12.006316Z	info	ambient	Namespace default is enabled in ambient mesh
</span></span><span style="display:flex;"><span>2023-06-28T00:00:12.006337Z	info	ambient	Namespace istio-system is disabled from ambient mesh
</span></span><span style="display:flex;"><span>2023-06-28T00:00:12.006341Z	info	ambient	Namespace kube-node-lease is disabled from ambient mesh
</span></span><span style="display:flex;"><span>2023-06-28T00:00:12.006344Z	info	ambient	Namespace kube-public is disabled from ambient mesh
</span></span><span style="display:flex;"><span>2023-06-28T00:00:12.006346Z	info	ambient	Namespace kube-system is disabled from ambient mesh
</span></span><span style="display:flex;"><span>2023-06-28T00:00:12.006348Z	info	ambient	Namespace local-path-storage is disabled from ambient mesh
</span></span><span style="display:flex;"><span>2023-06-28T00:00:12.006351Z	info	ambient	Namespace metallb-system is disabled from ambient mesh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2023-06-28T00:00:12.106387Z	info	controllers	starting	controller<span style="color:#f92672">=</span>ambient
</span></span><span style="display:flex;"><span>2023-06-28T00:00:12.106510Z	debug	controllers	handling update: istio-system/grafana-7d4f5589fb-6j9p6	controller<span style="color:#f92672">=</span>ambient
</span></span><span style="display:flex;"><span>2023-06-28T00:00:12.106414Z	info	repair	Start CNI race condition repair.
</span></span></code></pre></div><p>Event handlers for pod in the node will be enqueued on a new Ambient queue, and parsed by the <code>Reconcile</code>
method of the server.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span>	<span style="color:#75715e">// We only need to handle pods on our node
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">pods</span> = <span style="color:#a6e22e">kclient</span>.<span style="color:#a6e22e">NewFiltered</span>[<span style="color:#f92672">*</span><span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">Pod</span>](<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">kubeClient</span>, <span style="color:#a6e22e">kclient</span>.<span style="color:#a6e22e">Filter</span>{<span style="color:#a6e22e">FieldSelector</span>: <span style="color:#e6db74">&#34;spec.nodeName=&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">NodeName</span>})
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">pods</span>.<span style="color:#a6e22e">AddEventHandler</span>(<span style="color:#a6e22e">controllers</span>.<span style="color:#a6e22e">FromEventHandler</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">o</span> <span style="color:#a6e22e">controllers</span>.<span style="color:#a6e22e">Event</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Debug</span>(<span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">Event</span>.<span style="color:#a6e22e">String</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">o</span>)
</span></span><span style="display:flex;"><span>	}))
</span></span></code></pre></div><h3 id="ztunnel">Ztunnel</h3>
<ul>
<li><code>install-cni</code> daemoset in <code>ambient</code> mode.
<ul>
<li>copies <code>istio-cni</code> to <code>/opt/cni/bin</code>
<ul>
<li><code>istio-cni</code> when called via CmdAdd add himself to the <code>ipset</code> list</li>
<li>add routes to communicate with the ztunnel pod</li>
</ul>
</li>
<li>creates kubeconfig for the service account the pod runs under (ZZZ-istio-cni-kubeconfig)</li>
<li>injects the CNI plugin config to the CNI config file</li>
<li>creates iptables rules to forward traffic from the <code>ipset</code> to the ztunnel</li>
</ul>
</li>
</ul>
<p>Each pod in the node will generate an event and the Ztunnels one have a special treatment, the first
event will be an <code>type=add</code>, to collect debugging logs edit the daemonset of istio-cni-node and add
<code>--log_output_level=all:debug</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>2023-06-28T00:00:12.106559Z	debug	controllers	handling update: istio-system/istio-cni-node-972h9	controller<span style="color:#f92672">=</span>ambient
</span></span><span style="display:flex;"><span>2023-06-28T18:31:26.275442Z	debug	controllers	handling update: istio-system/grafana-7d4f5589fb-gfhcb	controller<span style="color:#f92672">=</span>ambient
</span></span><span style="display:flex;"><span>2023-06-28T18:31:26.275483Z	debug	controllers	handling update: istio-system/istio-cni-node-6nhs5	controller<span style="color:#f92672">=</span>ambient
</span></span><span style="display:flex;"><span>2023-06-28T18:31:26.275501Z	debug	controllers	handling update: istio-system/jaeger-58c79c85cd-9xwv6	controller<span style="color:#f92672">=</span>ambient
</span></span><span style="display:flex;"><span>2023-06-28T18:31:26.275519Z	debug	controllers	handling update: istio-system/kiali-749d76d7bb-bk4l5	controller<span style="color:#f92672">=</span>ambient
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2023-06-28T18:31:26.275555Z	debug	controllers	handling update: istio-system/ztunnel-bxc9w	controller<span style="color:#f92672">=</span>ambient  &lt;&lt;--
</span></span><span style="display:flex;"><span>2023-06-28T18:31:26.275572Z	debug	ambient	ztunnel pod set as active
</span></span><span style="display:flex;"><span>2023-06-28T18:31:26.275575Z	debug	ambient	Generating new ambient config file
</span></span><span style="display:flex;"><span>2023-06-28T18:31:26.275584Z	info	ambient	Writing ambient config: <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;ztunnelReady&#34;</span>:true,<span style="color:#e6db74">&#34;redirectMode&#34;</span>:<span style="color:#e6db74">&#34;iptables&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>2023-06-28T18:31:26.275717Z	debug	ambient	Done
</span></span><span style="display:flex;"><span>2023-06-28T18:31:26.275723Z	info	ambient	active ztunnel updated to ztunnel-bxc9w
</span></span><span style="display:flex;"><span>2023-06-28T18:31:26.275727Z	info	ambient	Node-level network rule cleanup started
</span></span><span style="display:flex;"><span>2023-06-28T18:31:26.275729Z	info	ambient	Detecting iptables command
</span></span><span style="display:flex;"><span>2023-06-28T18:31:26.289536Z	info	ambient	Using iptables command: iptables-nft
</span></span><span style="display:flex;"><span>2023-06-28T18:31:26.289583Z	debug	ambient	Running command: iptables-nft -t nat -F ztunnel-PREROUTING
</span></span><span style="display:flex;"><span>2023-06-28T18:31:26.291056Z	debug	ambient	Command error output: 
</span></span></code></pre></div><p>If the pod is ztunnel (has a label app=ztunnel), there will a path in the ReconcileZtunnel, different from the other pods.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ztunnelPod</span>(<span style="color:#a6e22e">pod</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">ReconcileZtunnel</span>()
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></div><p>If you check the rules created in the node with <code>iptables-save</code>, you will see something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>:ztunnel-FORWARD - <span style="color:#f92672">[</span>0:0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>:ztunnel-INPUT - <span style="color:#f92672">[</span>0:0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>:ztunnel-OUTPUT - <span style="color:#f92672">[</span>0:0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>:ztunnel-POSTROUTING - <span style="color:#f92672">[</span>0:0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>:ztunnel-PREROUTING - <span style="color:#f92672">[</span>0:0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>-A PREROUTING -j ztunnel-PREROUTING
</span></span><span style="display:flex;"><span>-A INPUT -j ztunnel-INPUT
</span></span><span style="display:flex;"><span>-A FORWARD -j ztunnel-FORWARD
</span></span><span style="display:flex;"><span>-A OUTPUT -j ztunnel-OUTPUT
</span></span><span style="display:flex;"><span>-A POSTROUTING -j ztunnel-POSTROUTING
</span></span><span style="display:flex;"><span>-A ztunnel-FORWARD -m mark --mark 0x220/0x220 -j CONNMARK --save-mark --nfmask 0x220 --ctmask 0x220
</span></span><span style="display:flex;"><span>-A ztunnel-FORWARD -m mark --mark 0x210/0x210 -j CONNMARK --save-mark --nfmask 0x210 --ctmask 0x210
</span></span><span style="display:flex;"><span>-A ztunnel-INPUT -m mark --mark 0x220/0x220 -j CONNMARK --save-mark --nfmask 0x220 --ctmask 0x220
</span></span><span style="display:flex;"><span>-A ztunnel-INPUT -m mark --mark 0x210/0x210 -j CONNMARK --save-mark --nfmask 0x210 --ctmask 0x210
</span></span><span style="display:flex;"><span>-A ztunnel-OUTPUT -s 10.244.2.1/32 -j MARK --set-xmark 0x220/0xffffffff
</span></span><span style="display:flex;"><span>-A ztunnel-PREROUTING -i istioin -j MARK --set-xmark 0x200/0x200
</span></span><span style="display:flex;"><span>-A ztunnel-PREROUTING -i istioin -j RETURN
</span></span><span style="display:flex;"><span>-A ztunnel-PREROUTING -i istioout -j MARK --set-xmark 0x200/0x200
</span></span><span style="display:flex;"><span>-A ztunnel-PREROUTING -i istioout -j RETURN
</span></span><span style="display:flex;"><span>-A ztunnel-PREROUTING -p udp -m udp --dport <span style="color:#ae81ff">6081</span> -j RETURN
</span></span><span style="display:flex;"><span>-A ztunnel-PREROUTING -m connmark --mark 0x220/0x220 -j MARK --set-xmark 0x200/0x200
</span></span><span style="display:flex;"><span>-A ztunnel-PREROUTING -m mark --mark 0x200/0x200 -j RETURN
</span></span><span style="display:flex;"><span>-A ztunnel-PREROUTING ! -i veth9f651c51 -m connmark --mark 0x210/0x210 -j MARK --set-xmark 0x40/0x40
</span></span><span style="display:flex;"><span>-A ztunnel-PREROUTING -m mark --mark 0x40/0x40 -j RETURN
</span></span><span style="display:flex;"><span>-A ztunnel-PREROUTING ! -s 10.244.2.3/32 -i veth9f651c51 -j MARK --set-xmark 0x210/0x210
</span></span><span style="display:flex;"><span>-A ztunnel-PREROUTING -m mark --mark 0x200/0x200 -j RETURN
</span></span><span style="display:flex;"><span>-A ztunnel-PREROUTING -i veth9f651c51 -j MARK --set-xmark 0x220/0x220
</span></span><span style="display:flex;"><span>-A ztunnel-PREROUTING -p udp -j MARK --set-xmark 0x220/0x220
</span></span><span style="display:flex;"><span>-A ztunnel-PREROUTING -m mark --mark 0x200/0x200 -j RETURN
</span></span><span style="display:flex;"><span>-A ztunnel-PREROUTING -p tcp -m set --match-set ztunnel-pods-ips src -j MARK --set-xmark 0x100/0x100
</span></span><span style="display:flex;"><span>:ztunnel-POSTROUTING - <span style="color:#f92672">[</span>0:0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>:ztunnel-PREROUTING - <span style="color:#f92672">[</span>0:0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>-A PREROUTING -j ztunnel-PREROUTING
</span></span><span style="display:flex;"><span>-A POSTROUTING -j ztunnel-POSTROUTING
</span></span><span style="display:flex;"><span>-A ztunnel-POSTROUTING -m mark --mark 0x100/0x100 -j ACCEPT
</span></span><span style="display:flex;"><span>-A ztunnel-PREROUTING -m mark --mark 0x100/0x100 -j ACCEPT
</span></span></code></pre></div><p>The first <code>cleanupNode</code> will fail because there will be no rules created, the commands can be seen bellow.
<code>CreateRulesOnNode</code> initializes the routing, firewall and ipset rules on the node, this ipset is used to
save a list of IPs of pods in the node and in the ambient mesh.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Try <span style="color:#e6db74">`</span>ipset help<span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#66d9ef">for</span> more information.
</span></span><span style="display:flex;"><span>root@ambient-worker2:/# ipset list
</span></span><span style="display:flex;"><span>Name: ztunnel-pods-ips
</span></span><span style="display:flex;"><span>Type: hash:ip
</span></span><span style="display:flex;"><span>Revision: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Header: family inet hashsize <span style="color:#ae81ff">1024</span> maxelem <span style="color:#ae81ff">65536</span>
</span></span><span style="display:flex;"><span>Size in memory: <span style="color:#ae81ff">280</span>
</span></span><span style="display:flex;"><span>References: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>Number of entries: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>Members:
</span></span><span style="display:flex;"><span>10.244.1.7
</span></span></code></pre></div><p>As stated in the list the match-set mark the packets as 0x100.
It creates a Geneve tunnel from the node to the the ztunnel pod, and the requiring table and routes.
The table 101 for example foward all the traffic to 192.168.127.2 (the geneve endpoint of the ztunnel)
and rules 101 do for all the packets marked as 0x100 (all the pods in the mesh).</p>
<p>This flow is well explained on <a href="https://www.youtube.com/watch?v=WOq4pxEHkwg">this</a> video series.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>2023-06-28T20:44:57.644303Z     debug   ambient CreateRulesOnNode: ztunnelVeth<span style="color:#f92672">=</span>veth87a7244e, ztunnelIP<span style="color:#f92672">=</span>10.244.1.5
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.679304Z     debug   ambient Building inbound tunnel: &amp;<span style="color:#f92672">{</span>LinkAttrs:<span style="color:#f92672">{</span>Index:0 MTU:0 TxQLen:0 Name:istioin HardwareAddr: Flags:0 RawFlags:0 ParentIndex:0 MasterIndex:0 Namespace:&lt;nil&gt; Alias: Statistics:&lt;nil&gt; Promisc:0 Allmulti:0 Multi:0 Xdp:&lt;nil&gt; EncapType: Protinfo:&lt;nil&gt; OperState:unknown PhysSwitchID:0 NetNsID:0 NumTxQueues:0 NumRxQueues:0 GSOMaxSize:0 GSOMaxSegs:0 Vfs:<span style="color:#f92672">[]</span> Group:0 Slave:&lt;nil&gt;<span style="color:#f92672">}</span> ID:1000 Remote:10.244.1.5 Ttl:0 Tos:0 Dport:0 UdpCsum:0 UdpZeroCsum6Tx:0 UdpZeroCsum6Rx:0 Link:0 FlowBased:false<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.679554Z     debug   ambient Building outbound tunnel: &amp;<span style="color:#f92672">{</span>LinkAttrs:<span style="color:#f92672">{</span>Index:0 MTU:0 TxQLen:0 Name:istioout HardwareAddr: Flags:0 RawFlags:0 ParentIndex:0 MasterIndex:0 Namespace:&lt;nil&gt; Alias: Statistics:&lt;nil&gt; Promisc:0 Allmulti:0 Multi:0 Xdp:&lt;nil&gt; EncapType: Protinfo:&lt;nil&gt; OperState:unknown PhysSwitchID:0 NetNsID:0 NumTxQueues:0 NumRxQueues:0 GSOMaxSize:0 GSOMaxSegs:0 Vfs:<span style="color:#f92672">[]</span> Group:0 Slave:&lt;nil&gt;<span style="color:#f92672">}</span> ID:1001 Remote:10.244.1.5 Ttl:0 Tos:0 Dport:0 UdpCsum:0 UdpZeroCsum6Tx:0 UdpZeroCsum6Rx:0 Link:0 FlowBased:false<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.679899Z     debug   ambient Running command: ip route add table <span style="color:#ae81ff">101</span> 10.244.1.5 dev veth87a7244e scope link
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.680975Z     debug   ambient Running command: ip route add table <span style="color:#ae81ff">101</span> 0.0.0.0/0 via 192.168.127.2 dev istioout
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.681943Z     debug   ambient Running command: ip route add table <span style="color:#ae81ff">102</span> 10.244.1.5 dev veth87a7244e scope link
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.682897Z     debug   ambient Running command: ip route add table <span style="color:#ae81ff">102</span> 0.0.0.0/0 via 10.244.1.5 dev veth87a7244e onlink
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.683857Z     debug   ambient Running command: ip route add table <span style="color:#ae81ff">100</span> 10.244.1.5 dev veth87a7244e scope link
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.684861Z     debug   ambient Running command: ip rule add priority <span style="color:#ae81ff">100</span> fwmark 0x200/0x200 goto <span style="color:#ae81ff">32766</span>
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.685766Z     debug   ambient Running command: ip rule add priority <span style="color:#ae81ff">101</span> fwmark 0x100/0x100 lookup <span style="color:#ae81ff">101</span>
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.686671Z     debug   ambient Running command: ip rule add priority <span style="color:#ae81ff">102</span> fwmark 0x040/0x040 lookup <span style="color:#ae81ff">102</span>
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.687604Z     debug   ambient Running command: ip rule add priority <span style="color:#ae81ff">103</span> table <span style="color:#ae81ff">100</span>
</span></span></code></pre></div><p>Check the Node ip address with <code>ip addr</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># ip addr</span>
</span></span><span style="display:flex;"><span>28: istioin: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">1450</span> qdisc noqueue state UNKNOWN group default 
</span></span><span style="display:flex;"><span>    link/ether 4a:f8:e3:99:10:76 brd ff:ff:ff:ff:ff:ff
</span></span><span style="display:flex;"><span>    inet 192.168.126.1/30 brd 192.168.126.3 scope global istioin
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>29: istioout: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">1450</span> qdisc noqueue state UNKNOWN group default 
</span></span><span style="display:flex;"><span>    link/ether 46:53:9d:d8:ec:be brd ff:ff:ff:ff:ff:ff
</span></span><span style="display:flex;"><span>    inet 192.168.127.1/30 brd 192.168.127.3 scope global istioout
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ip route</span>
</span></span><span style="display:flex;"><span>192.168.126.0/30 dev istioin proto kernel scope link src 192.168.126.1 
</span></span><span style="display:flex;"><span>192.168.127.0/30 dev istioout proto kernel scope link src 192.168.127.1
</span></span></code></pre></div><p>In the ztunnel pod check the <code>ip addr</code> command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>2: eth0@if27: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">1500</span> qdisc noqueue state UP group default 
</span></span><span style="display:flex;"><span>    inet 10.244.2.9/24 brd 10.244.2.255 scope global eth0
</span></span><span style="display:flex;"><span>7: pistioin: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">1450</span> qdisc noqueue state UNKNOWN group default 
</span></span><span style="display:flex;"><span>    inet 192.168.126.2/30 brd 192.168.126.3 scope global pistioin
</span></span><span style="display:flex;"><span>8: pistioout: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#ae81ff">1450</span> qdisc noqueue state UNKNOWN group default 
</span></span><span style="display:flex;"><span>    inet 192.168.127.2/30 brd 192.168.127.3 scope global pistioout
</span></span></code></pre></div><p>The last step is the <code>CreateRulesWithinNodeProxyNS</code> new rules are created in the network namespace of the
ztunnel Pod, this will close the Geneve connection back.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># crictl ps | grep ztu</span>
</span></span><span style="display:flex;"><span>a23f4efeea569       ded602048352a       <span style="color:#ae81ff">19</span> minutes ago      Running             istio-proxy         <span style="color:#ae81ff">0</span>                   20d7834faddc0       ztunnel-v5kj8
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  nsenter -t $(crictl inspect a23f4efeea569 | jq .info.pid) -n iptables-save</span>
</span></span><span style="display:flex;"><span>:PREROUTING ACCEPT <span style="color:#f92672">[</span>0:0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>:INPUT ACCEPT <span style="color:#f92672">[</span>0:0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>:FORWARD ACCEPT <span style="color:#f92672">[</span>0:0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>:OUTPUT ACCEPT <span style="color:#f92672">[</span>0:0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>:POSTROUTING ACCEPT <span style="color:#f92672">[</span>0:0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>-A PREROUTING -i pistioin -p tcp -m tcp --dport <span style="color:#ae81ff">15008</span> -j TPROXY --on-port <span style="color:#ae81ff">15008</span> --on-ip 127.0.0.1 --tproxy-mark 0x400/0xfff
</span></span><span style="display:flex;"><span>-A PREROUTING -i pistioout -p tcp -j TPROXY --on-port <span style="color:#ae81ff">15001</span> --on-ip 127.0.0.1 --tproxy-mark 0x400/0xfff
</span></span><span style="display:flex;"><span>-A PREROUTING -i pistioin -p tcp -j TPROXY --on-port <span style="color:#ae81ff">15006</span> --on-ip 127.0.0.1 --tproxy-mark 0x400/0xfff
</span></span><span style="display:flex;"><span>-A PREROUTING ! -d 10.244.1.5/32 -i eth0 -p tcp -j MARK --set-xmark 0x4d3/0xfff
</span></span></code></pre></div><p>Following the logs:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>2023-06-28T20:44:57.688640Z     debug   ambient CreateRulesWithinNodeProxyNS: proxyNsVethIdx<span style="color:#f92672">=</span>2, ztunnelIP<span style="color:#f92672">=</span>10.244.1.5, hostIP<span style="color:#f92672">=</span>10.244.1.1, from within netns<span style="color:#f92672">=</span>cni-6cbb4d97-20b6-1624-f7e7-22bb4d07e06f
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.788319Z     debug   ambient Building inbound tunnel: &amp;<span style="color:#f92672">{</span>LinkAttrs:<span style="color:#f92672">{</span>Index:0 MTU:0 TxQLen:0 Name:pistioin HardwareAddr: Flags:0 RawFlags:0 ParentIndex:0 MasterIndex:0 Namespace:&lt;nil&gt; Alias: Statistics:&lt;nil&gt; Promisc:0 Allmulti:0 Multi:0 Xdp:&lt;nil&gt; EncapType: Protinfo:&lt;nil&gt; OperState:unknown PhysSwitchID:0 NetNsID:0 NumTxQueues:0 NumRxQueues:0 GSOMaxSize:0 GSOMaxSegs:0 Vfs:<span style="color:#f92672">[]</span> Group:0 Slave:&lt;nil&gt;<span style="color:#f92672">}</span> ID:1000 Remote:10.244.1.1 Ttl:0 Tos:0 Dport:0 UdpCsum:0 UdpZeroCsum6Tx:0 UdpZeroCsum6Rx:0 Link:0 FlowBased:false<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.788580Z     debug   ambient Building outbound tunnel: &amp;<span style="color:#f92672">{</span>LinkAttrs:<span style="color:#f92672">{</span>Index:0 MTU:0 TxQLen:0 Name:pistioout HardwareAddr: Flags:0 RawFlags:0 ParentIndex:0 MasterIndex:0 Namespace:&lt;nil&gt; Alias: Statistics:&lt;nil&gt; Promisc:0 Allmulti:0 Multi:0 Xdp:&lt;nil&gt; EncapType: Protinfo:&lt;nil&gt; OperState:unknown PhysSwitchID:0 NetNsID:0 NumTxQueues:0 NumRxQueues:0 GSOMaxSize:0 GSOMaxSegs:0 Vfs:<span style="color:#f92672">[]</span> Group:0 Slave:&lt;nil&gt;<span style="color:#f92672">}</span> ID:1001 Remote:10.244.1.1 Ttl:0 Tos:0 Dport:0 UdpCsum:0 UdpZeroCsum6Tx:0 UdpZeroCsum6Rx:0 Link:0 FlowBased:false<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.788753Z     debug   ambient Bringing up inbound tunnel: &amp;<span style="color:#f92672">{</span>LinkAttrs:<span style="color:#f92672">{</span>Index:7 MTU:0 TxQLen:0 Name:pistioin HardwareAddr: Flags:0 RawFlags:0 ParentIndex:0 MasterIndex:0 Namespace:&lt;nil&gt; Alias: Statistics:&lt;nil&gt; Promisc:0 Allmulti:0 Multi:0 Xdp:&lt;nil&gt; EncapType: Protinfo:&lt;nil&gt; OperState:unknown PhysSwitchID:0 NetNsID:0 NumTxQueues:0 NumRxQueues:0 GSOMaxSize:0 GSOMaxSegs:0 Vfs:<span style="color:#f92672">[]</span> Group:0 Slave:&lt;nil&gt;<span style="color:#f92672">}</span> ID:1000 Remote:10.244.1.1 Ttl:0 Tos:0 Dport:0 UdpCsum:0 UdpZeroCsum6Tx:0 UdpZeroCsum6Rx:0 Link:0 FlowBased:false<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.788853Z     debug   ambient Bringing up outbound tunnel: &amp;<span style="color:#f92672">{</span>LinkAttrs:<span style="color:#f92672">{</span>Index:8 MTU:0 TxQLen:0 Name:pistioout HardwareAddr: Flags:0 RawFlags:0 ParentIndex:0 MasterIndex:0 Namespace:&lt;nil&gt; Alias: Statistics:&lt;nil&gt; Promisc:0 Allmulti:0 Multi:0 Xdp:&lt;nil&gt; EncapType: Protinfo:&lt;nil&gt; OperState:unknown PhysSwitchID:0 NetNsID:0 NumTxQueues:0 NumRxQueues:0 GSOMaxSize:0 GSOMaxSegs:0 Vfs:<span style="color:#f92672">[]</span> Group:0 Slave:&lt;nil&gt;<span style="color:#f92672">}</span> ID:1001 Remote:10.244.1.1 Ttl:0 Tos:0 Dport:0 UdpCsum:0 UdpZeroCsum6Tx:0 UdpZeroCsum6Rx:0 Link:0 FlowBased:false<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.789083Z     debug   ambient Adding netlink route : <span style="color:#f92672">{</span>Ifindex: <span style="color:#ae81ff">1</span> Dst: 0.0.0.0/0 Src: &lt;nil&gt; Gw: &lt;nil&gt; Flags: <span style="color:#f92672">[]</span> Table: <span style="color:#ae81ff">100</span> Realm: 0<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.789109Z     debug   ambient Adding netlink route : <span style="color:#f92672">{</span>Ifindex: <span style="color:#ae81ff">8</span> Dst: 0.0.0.0/0 Src: &lt;nil&gt; Gw: 192.168.127.1 Flags: <span style="color:#f92672">[]</span> Table: <span style="color:#ae81ff">101</span> Realm: 0<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.789131Z     debug   ambient Adding netlink route : <span style="color:#f92672">{</span>Ifindex: <span style="color:#ae81ff">7</span> Dst: 0.0.0.0/0 Src: &lt;nil&gt; Gw: 192.168.126.1 Flags: <span style="color:#f92672">[]</span> Table: <span style="color:#ae81ff">102</span> Realm: 0<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.789149Z     debug   ambient Finding link and parsing host IP
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.789186Z     debug   ambient Adding netlink HOST_IP routes : <span style="color:#f92672">{</span>Ifindex: <span style="color:#ae81ff">2</span> Dst: 10.244.1.1/32 Src: &lt;nil&gt; Gw: &lt;nil&gt; Flags: <span style="color:#f92672">[]</span> Table: <span style="color:#ae81ff">101</span> Realm: 0<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.789210Z     debug   ambient Adding netlink HOST_IP routes : <span style="color:#f92672">{</span>Ifindex: <span style="color:#ae81ff">2</span> Dst: 10.244.1.1/32 Src: &lt;nil&gt; Gw: &lt;nil&gt; Flags: <span style="color:#f92672">[]</span> Table: <span style="color:#ae81ff">102</span> Realm: 0<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.789228Z     debug   ambient Preparing to apply iptables rules
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.789232Z     debug   ambient Running command: iptables-nft -t mangle -F PREROUTING
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.790143Z     debug   ambient Running command: iptables-nft -t nat -F OUTPUT
</span></span><span style="display:flex;"><span>2023-06-28T20:44:57.790956Z     debug   ambient Adding iptables rules
</span></span></code></pre></div><p>When the ztunnel pod is delete all rules are cleaned up.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>2023-06-28T20:32:06.780693Z	debug	ambient	Running command: iptables-nft -t nat -F ztunnel-PREROUTING
</span></span><span style="display:flex;"><span>2023-06-28T20:32:06.781729Z	debug	ambient	Running command: iptables-nft -t nat -F ztunnel-POSTROUTING
</span></span><span style="display:flex;"><span>2023-06-28T20:32:06.852360Z	debug	ambient	Running command: iptables-nft -t mangle -F ztunnel-PREROUTING
</span></span><span style="display:flex;"><span>2023-06-28T20:32:06.932403Z	debug	ambient	Running command: iptables-nft -t mangle -F ztunnel-POSTROUTING
</span></span><span style="display:flex;"><span>2023-06-28T20:32:07.012423Z	debug	ambient	Running command: iptables-nft -t mangle -F ztunnel-OUTPUT
</span></span><span style="display:flex;"><span>2023-06-28T20:32:07.068415Z	debug	ambient	Running command: iptables-nft -t mangle -F ztunnel-INPUT
</span></span><span style="display:flex;"><span>2023-06-28T20:32:07.128401Z	debug	ambient	Running command: iptables-nft -t mangle -F ztunnel-FORWARD
</span></span><span style="display:flex;"><span>2023-06-28T20:32:07.272462Z	debug	ambient	Running command: iptables-nft -t nat -X ztunnel-PREROUTING
</span></span><span style="display:flex;"><span>2023-06-28T20:32:07.409026Z	debug	ambient	Running command: iptables-nft -t nat -X ztunnel-POSTROUTING
</span></span></code></pre></div><h3 id="installing-istio-cni">Installing istio-cni</h3>
<p>Each node will have a <code>/opt/cni/bin/istio-cni</code> plugin and on this case <code>/etc/cni/net.d/10-kindnet.conflist</code> is saved with
the CNI config, the <code>ZZZ-istio-cni-kubeconfig</code> contains access to the cluster.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>2023-06-28T19:20:26.487861Z	info	install	Detect changes to the CNI configuration and binaries, attempt reinstalling...
</span></span><span style="display:flex;"><span>2023-06-28T19:20:26.605883Z	info	install	Copied istio-cni to /host/opt/cni/bin.
</span></span><span style="display:flex;"><span>2023-06-28T19:20:26.605909Z	info	install	Directory /host/secondary-bin-dir is not writable, skipping.
</span></span><span style="display:flex;"><span>2023-06-28T19:20:26.605992Z	info	install	write kubeconfig file /host/etc/cni/net.d/ZZZ-istio-cni-kubeconfig with: 
</span></span><span style="display:flex;"><span>2023-06-28T19:20:26.606132Z	info	install	Using CNI config template from CNI_NETWORK_CONFIG environment variable.
</span></span><span style="display:flex;"><span>2023-06-28T19:20:26.606141Z	info	install	CNI config: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;cniVersion&#34;</span>: <span style="color:#e6db74">&#34;0.3.1&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;istio-cni&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;istio-cni&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;log_level&#34;</span>: <span style="color:#e6db74">&#34;debug&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;log_uds_address&#34;</span>: <span style="color:#e6db74">&#34;/var/run/istio-cni/log.sock&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;ambient_enabled&#34;</span>: true,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;kubernetes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;kubeconfig&#34;</span>: <span style="color:#e6db74">&#34;/etc/cni/net.d/ZZZ-istio-cni-kubeconfig&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;cni_bin_dir&#34;</span>: <span style="color:#e6db74">&#34;/opt/cni/bin&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;exclude_namespaces&#34;</span>: <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;kube-system&#34;</span> <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2023-06-28T19:20:26.606349Z	info	install	CNI config file /host/etc/cni/net.d/10-kindnet.conflist exists. Proceeding.
</span></span><span style="display:flex;"><span>2023-06-28T19:20:26.606682Z	info	install	Created CNI config /host/etc/cni/net.d/10-kindnet.conflist
</span></span></code></pre></div><h3 id="istio-cni">istio-cni</h3>
<p>The CNI plugin installed will be called on <code>CmdAdd</code> via containerd when a new pod is created, this will set routing and adding the pod ip to the ipset.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>2023-06-28T23:06:29.902002Z	debug	cni	istio-cni CmdAdd previous result: &amp;<span style="color:#f92672">{</span>CNIVersion:1.0.0 Interfaces:<span style="color:#f92672">[{</span>Name:vethd8146a12 Mac:4a:a4:fa:12:37:59 Sandbox:<span style="color:#f92672">}</span> <span style="color:#f92672">{</span>Name:eth0 Mac:42:ba:6a:f7:fb:43 Sandbox:/var/run/netns/cni-97d1463e-b8a8-ed68-0e53-5d739167b6a8<span style="color:#f92672">}]</span> IPs:<span style="color:#f92672">[{</span>Interface:0xc0004742b0 Address:<span style="color:#f92672">{</span>IP:10.244.2.19 Mask:ffffff00<span style="color:#f92672">}</span> Gateway:10.244.2.1<span style="color:#f92672">}]</span> Routes:<span style="color:#f92672">[{</span>Dst:<span style="color:#f92672">{</span>IP:0.0.0.0 Mask:00000000<span style="color:#f92672">}</span> GW:&lt;nil&gt;<span style="color:#f92672">}]</span> DNS:<span style="color:#f92672">{</span>Nameservers:<span style="color:#f92672">[]</span> Domain: Search:<span style="color:#f92672">[]</span> Options:<span style="color:#f92672">[]}}</span>
</span></span><span style="display:flex;"><span>2023-06-28T23:06:29.902003Z	debug	cni	ambientConf.ZTunnelReady: true
</span></span><span style="display:flex;"><span>2023-06-28T23:06:29.902007Z	info	cni	istio-cni cmdAdd podName: appb-7774fb945-qhq6l podIPs: <span style="color:#f92672">[{</span>IP:10.244.2.19 Mask:ffffff00<span style="color:#f92672">}]</span>
</span></span><span style="display:flex;"><span>2023-06-28T23:06:29.902008Z	debug	cni	istio-cni set up kubernetes client with kubeconfig /etc/cni/net.d/ZZZ-istio-cni-kubeconfig
</span></span><span style="display:flex;"><span>2023-06-28T23:06:29.902010Z	info	cni	Adding pod <span style="color:#e6db74">&#39;appb-7774fb945-qhq6l/default&#39;</span> <span style="color:#f92672">(</span>65a2dac9-acc4-41cf-a4a8-994a9294051f<span style="color:#f92672">)</span> to ipset
</span></span><span style="display:flex;"><span>2023-06-28T23:06:29.902011Z	info	cni	Adding route <span style="color:#66d9ef">for</span> appb-7774fb945-qhq6l/default: <span style="color:#f92672">[</span>table <span style="color:#ae81ff">100</span> 10.244.2.19/32 via 192.168.126.2 dev istioin src 10.244.2.1<span style="color:#f92672">]</span>
</span></span></code></pre></div><h3 id="pods-in-other-nodes">Pods in other nodes</h3>
<p>Geneve works by creating Layer 2 logical networks that are encapsulated in UDP packets. A Segment ID in every frame identifies the Geneve logical networks without the need for VLAN tags.
As a result, many isolated Layer 2 networks can coexist on a common Layer 3 infrastructure using the same VLAN ID.</p>
<p><img src="./images/geneve.png" alt="geneve" title="geneve"></p>
<p>On this example <code>appa</code> on 10.244.2.14 on ambient-worker is on <code>appb</code> 10.244.1.7 and ambient-worker2, in case of pods in different nodes
this tunnel is used, when passing through ztunnel. The 10.96.28.140 is the service IP.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@ambient-worker:/# tcpdump -i istioout -vvv 
</span></span><span style="display:flex;"><span>tcpdump: listening on istioout, link-type EN10MB <span style="color:#f92672">(</span>Ethernet<span style="color:#f92672">)</span>, snapshot length <span style="color:#ae81ff">262144</span> bytes
</span></span><span style="display:flex;"><span>23:30:07.961316 IP <span style="color:#f92672">(</span>tos 0x0, ttl 63, id 2453, offset 0, flags <span style="color:#f92672">[</span>DF<span style="color:#f92672">]</span>, proto TCP <span style="color:#f92672">(</span>6<span style="color:#f92672">)</span>, length 60<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    10.244.2.14.58068 &gt; 10.96.28.140.8000: Flags <span style="color:#f92672">[</span>S<span style="color:#f92672">]</span>, cksum 0x341c <span style="color:#f92672">(</span>incorrect -&gt; 0xba09<span style="color:#f92672">)</span>, seq 177519862, win 64240, options <span style="color:#f92672">[</span>mss 1460,sackOK,TS val <span style="color:#ae81ff">2001477164</span> ecr 0,nop,wscale 7<span style="color:#f92672">]</span>, length <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@ambient-worker2:/# tcpdump -i istioin -vvvne 
</span></span><span style="display:flex;"><span>tcpdump: listening on istioin, link-type EN10MB <span style="color:#f92672">(</span>Ethernet<span style="color:#f92672">)</span>, snapshot length <span style="color:#ae81ff">262144</span> bytes
</span></span><span style="display:flex;"><span>23:35:52.112834 a6:55:ae:89:6c:95 &gt; ce:5e:cf:f6:d3:cd, ethertype IPv4 <span style="color:#f92672">(</span>0x0800<span style="color:#f92672">)</span>, length 74: <span style="color:#f92672">(</span>tos 0x0, ttl 62, id 17266, offset 0, flags <span style="color:#f92672">[</span>DF<span style="color:#f92672">]</span>, proto TCP <span style="color:#f92672">(</span>6<span style="color:#f92672">)</span>, length 60<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    10.244.2.14.59385 &gt; 10.244.1.7.15008: Flags <span style="color:#f92672">[</span>S<span style="color:#f92672">]</span>, cksum 0x192b <span style="color:#f92672">(</span>incorrect -&gt; 0x7ab6<span style="color:#f92672">)</span>, seq 1258817029, win 64240, options <span style="color:#f92672">[</span>mss 1460,sackOK,TS val <span style="color:#ae81ff">190200415</span> ecr 0,nop,wscale 7<span style="color:#f92672">]</span>, length <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>Checking the ztunnel logs will confirm the traffic is passing through the pod and rules are working, at this point the VIP is already translated to the pod endpoint
and the HBONE connection setup on ztunnel.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e">#ambient-worker:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2023-06-28T23:43:39.125296Z  INFO outbound<span style="color:#f92672">{</span>id<span style="color:#f92672">=</span>d5d9157a8ffceb216bc7133392e9f073<span style="color:#f92672">}</span>: ztunnel::proxy::outbound: proxy to 10.244.1.7:80 using HBONE via 10.244.1.7:15008 type Direct
</span></span><span style="display:flex;"><span>2023-06-28T23:43:39.212939Z  INFO outbound<span style="color:#f92672">{</span>id<span style="color:#f92672">=</span>d5d9157a8ffceb216bc7133392e9f073<span style="color:#f92672">}</span>: ztunnel::proxy::outbound: complete dur<span style="color:#f92672">=</span>87.687768ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ambient-worker2:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2023-06-28T23:45:28.230973Z  INFO inbound<span style="color:#f92672">{</span>id<span style="color:#f92672">=</span>517d0619b98713c430f7b558bbfdace8 peer_ip<span style="color:#f92672">=</span>10.244.2.14 peer_id<span style="color:#f92672">=</span>spiffe://cluster.local/ns/default/sa/appa<span style="color:#f92672">}</span>: ztunnel::proxy::inbound: got CONNECT request to 10.244.1.7:80
</span></span></code></pre></div>




<footer class=" footline" >
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="/2023/0630/" title="Ztunnel on Ambient Mesh"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/2023/0622/" title="Istio Ambient Service Mesh Demo" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1755000526"></script>
    <script src="/js/perfect-scrollbar.min.js?1755000526"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1755000526"></script>
    <script src="/js/jquery.sticky.js?1755000526"></script>
    <script src="/js/featherlight.min.js?1755000526"></script>
    <script src="/js/highlight.pack.js?1755000526"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1755000526"></script>
    <script src="/js/learn.js?1755000526"></script>
    <script src="/js/hugo-learn.js?1755000526"></script>
    
        
            <script src="/mermaid/mermaid.js?1755000526"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>
