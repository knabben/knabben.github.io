<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.112.7">
    <meta name="description" content="Windows Kernelspace Mode for Services">


    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Kube-proxy Windows Kernelspace Mode :: compulsory thinking</title>

    
    <link href="/css/nucleus.css?1704047371" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1704047371" rel="stylesheet">
    <link href="/css/hybrid.css?1704047371" rel="stylesheet">
    <link href="/css/featherlight.min.css?1704047371" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1704047371" rel="stylesheet">
    <link href="/css/auto-complete.css?1704047371" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1704047371" rel="stylesheet">
    <link href="/css/theme.css?1704047371" rel="stylesheet">
    <link href="/css/tabs.css?1704047371" rel="stylesheet">
    <link href="/css/hugo-theme.css?1704047371" rel="stylesheet">
    
    <link href="/css/theme-blue.css?1704047371" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1704047371"></script>
      
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SXHZPRXGDZ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-SXHZPRXGDZ');
    </script>
    <script>
    if (location.host.indexOf("localhost") < 0 && location.protocol !== "https:") {
      location.protocol = "https:";
    }
    </script>
    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/2021/1218/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href='/'>
  <div id="header-logo"> OPS [SEC] </div>
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1704047371"></script>
<script type="text/javascript" src="/js/auto-complete.js?1704047371"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/opssec.in\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1704047371"></script>

    
  </div>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/2023/" title="2023" class="dd-item
        
        
        
        ">
      <a href="/2023/">
          2023
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/2023/1230/" title="Running Windows cluster locally" class="dd-item
        
        
        
        ">
      <a href="/2023/1230/">
          Running Windows cluster locally
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0801/" title="sigstore policy-controller validation" class="dd-item
        
        
        
        ">
      <a href="/2023/0801/">
          sigstore policy-controller validation
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0721/" title="Ztunnel SPIRE implementation" class="dd-item
        
        
        
        ">
      <a href="/2023/0721/">
          Ztunnel SPIRE implementation
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0702/" title="Waypoint Proxy for the app layer" class="dd-item
        
        
        
        ">
      <a href="/2023/0702/">
          Waypoint Proxy for the app layer
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0630/" title="Ztunnel on Ambient Mesh" class="dd-item
        
        
        
        ">
      <a href="/2023/0630/">
          Ztunnel on Ambient Mesh
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0628/" title="Istio CNI on Ambient Mesh" class="dd-item
        
        
        
        ">
      <a href="/2023/0628/">
          Istio CNI on Ambient Mesh
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0622/" title="Istio Ambient Service Mesh Demo" class="dd-item
        
        
        
        ">
      <a href="/2023/0622/">
          Istio Ambient Service Mesh Demo
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0611/" title="SPIFFE/SPIRE for gRPC authz" class="dd-item
        
        
        
        ">
      <a href="/2023/0611/">
          SPIFFE/SPIRE for gRPC authz
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0608/" title="Secure gRPC services with mTLS" class="dd-item
        
        
        
        ">
      <a href="/2023/0608/">
          Secure gRPC services with mTLS
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0406/" title="Windows CNI tracing and deep dive" class="dd-item
        
        
        
        ">
      <a href="/2023/0406/">
          Windows CNI tracing and deep dive
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0330/" title="Windows Containers and .NET apps" class="dd-item
        
        
        
        ">
      <a href="/2023/0330/">
          Windows Containers and .NET apps
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0322/" title="Multi AZ on Kubernetes and vSphere" class="dd-item
        
        
        
        ">
      <a href="/2023/0322/">
          Multi AZ on Kubernetes and vSphere
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2022/" title="2022" class="dd-item
        
        
        
        ">
      <a href="/2022/">
          2022
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/2022/0712/" title="Hybrid nodes with ClusterClass on Amazon Web Service" class="dd-item
        
        
        
        ">
      <a href="/2022/0712/">
          Hybrid nodes with ClusterClass on Amazon Web Service
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2022/0610/" title="Border Gateway Protocol (BGP) and Kubernetes" class="dd-item
        
        
        
        ">
      <a href="/2022/0610/">
          Border Gateway Protocol (BGP) and Kubernetes
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2022/0320/" title="Cluster API Provider for Azure" class="dd-item
        
        
        
        ">
      <a href="/2022/0320/">
          Cluster API Provider for Azure
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2022/0122/" title="Kube-Proxy Next Gen Windows Userspace" class="dd-item
        
        
        
        ">
      <a href="/2022/0122/">
          Kube-Proxy Next Gen Windows Userspace
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2021/" title="2021" class="dd-item
        parent
        
        
        ">
      <a href="/2021/">
          2021
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/2021/1218/" title="Kube-proxy Windows Kernelspace Mode" class="dd-item
        
        active
        
        ">
      <a href="/2021/1218/">
          Kube-proxy Windows Kernelspace Mode
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2021/1127/" title="Kube-proxy Linux Userspace Mode" class="dd-item
        
        
        
        ">
      <a href="/2021/1127/">
          Kube-proxy Linux Userspace Mode
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2021/1017/" title="Kube-proxy Winuserspace Mode" class="dd-item
        
        
        
        ">
      <a href="/2021/1017/">
          Kube-proxy Winuserspace Mode
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2021/0903/" title="Windows and Calico overlay networking" class="dd-item
        
        
        
        ">
      <a href="/2021/0903/">
          Windows and Calico overlay networking
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2021/0828/" title="CNI plugins and kindnet" class="dd-item
        
        
        
        ">
      <a href="/2021/0828/">
          CNI plugins and kindnet
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2021/0614/" title="Kube-proxy ClusterIP" class="dd-item
        
        
        
        ">
      <a href="/2021/0614/">
          Kube-proxy ClusterIP
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2021/0228/" title="Kubernetes Windows Nodes" class="dd-item
        
        
        
        ">
      <a href="/2021/0228/">
          Kubernetes Windows Nodes
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
        
    </ul>

    
    

    
    <section id="footer">
      <center>
  <p><b>Amim Knabben</b> - 2023</p>
    amim.knabben@gmail.com
  <br/>
  <a href="https://github.com/knabben"><i class="fab fa-github"></i></a>
  <a href="https://twitter.com/ak_ndb"><i class="fab fa-twitter"></i></a>
  <a href="https://linkedin.com/in/amim"><i class="fab fa-linkedin"></i></a>
</center>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/'></a> > <a href='/2021/'>2021</a> > Kube-proxy Windows Kernelspace Mode
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#host-compute-service--host-compute-network-previous-host-networking-service">Host Compute Service &amp; Host Compute Network (previous Host Networking Service)</a></li>
    <li><a href="#windows-kernel-mode">Windows kernel mode</a></li>
    <li><a href="#endpointslices">EndpointSlices</a>
      <ul>
        <li><a href="#calico-vxlan-and-source-vip">Calico VXLAN and Source VIP</a></li>
      </ul>
    </li>
    <li><a href="#syncproxyrules-deep-dive">syncProxyRules deep dive</a></li>
    <li><a href="#monitoring">Monitoring</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Kube-proxy Windows Kernelspace Mode
            </h1>
          

        



	<h2 id="introduction">Introduction</h2>
<p>Sorry not sorry, this is the fourth post about kube-proxy modes, don&rsquo;t worry the evil is in the details. This time these writings will cover
Windows kernelspace mode. This proxy mode is used in Calico and Flannel CNIs and the APIs and golang binding used here (HCN)
are shared on both technologies, so having a good understanding of how the public-facing interaction works and methods
signatures is a good step on enabling the coding on windows container kernel networking capabilities. I will NOT
dive much into the details of how Kube-proxy works AGAIN, the K8S APIs binding on services and endpoints is well covered
on the other posts. Check them out!</p>
<h2 id="host-compute-service--host-compute-network-previous-host-networking-service">Host Compute Service &amp; Host Compute Network (previous Host Networking Service)</h2>
<p>Your first stop should be [here]
(<a href="https://kubernetes.io/docs/setup/production-environment/windows/intro-windows-in-kubernetes/)">https://kubernetes.io/docs/setup/production-environment/windows/intro-windows-in-kubernetes/)</a>. From a brief excerpt:</p>
<p>The Windows HNS (Host Networking Service) and vSwitch implement namespacing and can create virtual NICs as needed for a pod or container.
However, <em>many configurations such as DNS, routes, and metrics are stored in the Windows registry database</em> rather than as files inside /etc,
which is how Linux stores those configurations. The Windows registry for the container is separate from that of the host, so concepts
like mapping /etc/resolv.conf from the host into a container don&rsquo;t have the same effect they would on Linux.
<em>These must be configured using Windows APIs run in the context of that container. Therefore CNI implementations need to call the HNS
instead of relying on file mappings to pass network details into the pod or container.</em></p>
<p><em>Overlay networking support in kube-proxy is a beta feature. In addition, it requires KB4482887 to be installed on Windows Server 2019</em></p>
<p><img src="./images/proxy-kernel.png?width=1024" alt="kernel" title="kernl"></p>
<p>From a brief introduction of HCN (HNS) use by CNI and the proxy, accordingly to [1]:</p>
<p>Windows container networking is set up similar to Hyper-V virtual machine networking, and in fact it shares many of the internal services,
especially Host Networking Service (HNS), which cooperates with Host Compute Service (HCS), which manages the containers&rsquo; life cycles.
When creating a new Docker container, the container receives its own network namespace (compartment) and a Virtual Network Interface Controller (vNIC or in the case of Hyper-V, isolated containers or vmNIC) located in this namespace. The vNIC is then connected to a Hyper-V Virtual Switch (vSwitch), which is also connected to the host default network namespace using the host vNIC.
You can loosely map this construct to the container bridge interface (CBR) in the Linux container world. The vSwitch utilizes Windows Firewall and the Virtual Filtering Platform (VFP) Hyper-V vSwitch extension in order to provide network security, traffic forwarding, VXLAN encapsulation, and load balancing.</p>
<p>This component is crucial for kube-proxy to provide Services&rsquo; functionalities, and you can think of VFP as iptables from the Linux container world.
The vSwitch can be internal (not connected to a network adapter on the container host) or external (connected to a network adapter on the container host); it depends on the container network driver.
In the case of Kubernetes, you will be always using network drivers (L2Bridge, Overlay, Transparent) that create an external vSwitch.</p>
<p>The second source of good information is [2], the video covers well how these mechanism works and a custom implementation using the API.</p>
<p>Let&rsquo;s start with a simple golang to print the supported features available in the server. Using the <code>github.com/Microsoft/hcsshim/hcn</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;+%v&#34;</span>, <span style="color:#a6e22e">hcn</span>.<span style="color:#a6e22e">GetSupportedFeatures</span>())
</span></span></code></pre></div><p>And the good ol` <a href="https://github.com/kubernetes-sigs/sig-windows-dev-tools/">dev tools</a> for these dangerous maneuvers.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ GOOS<span style="color:#f92672">=</span>windows go build scp winkernel.exe vagrant@10.20.30.11:/tmp; ssh vagrant@10.20.30.11 /tmp/winkernel.exe;
</span></span><span style="display:flex;"><span>msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;HCN feature check&#34;</span> supportedFeatures<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Acl: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        AclAddressLists:true 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        AclNoHostRulePriority:true 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        AclPortRanges:true 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        AclRuleId:true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    } 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Api:{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        V1:true 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        V2:true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    RemoteSubnet:true 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    HostRoute:true 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    DSR:false 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ...
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#34;</span>
</span></span></code></pre></div><p>In the environment above <code>SessionAfinity</code> will NOT work and one last interesting thing to note: overlay (VXLAN) networks on Windows won&rsquo;t
support dual-stack networking today. The following features should be AVAILABLE for a full experience of the functionalities in the kernel mode.</p>
<ul>
<li>IPv6DualStack - hcn.IPV6DualStackSupported()</li>
<li>SessionAffinity - proxier.supportedFeatures.SessionAffinity {</li>
<li>DSR (Direct Server Return)[3] - hcn.DSRSupported()</li>
<li>RemoteSubnet -hcn.RemoteSubnetSupported()</li>
</ul>
<p>If <code>Api.V2</code> is available it&rsquo;s used instead of <code>Api.V1</code>.</p>
<h2 id="windows-kernel-mode">Windows kernel mode</h2>
<p>Yet from the resource [1] and having another overview from kproxy winkernel:</p>
<p>Kube-proxy is observing Service and Endpoint (endpointslices) objects in order to create <strong>HNS policies</strong> on Windows nodes.
Which are used to implement a Virtual IP address with a value of ClusterIP specified in the Service specification.</p>
<p>Finally, when a client Pod sends a request to the Virtual IP, it is forwarded using the rules/policies (set up by kube-proxy) to one of the Pods in the Deployment.
As you can see, kube-proxy is the central component for implementing Services, and in fact it is used for all Service types, apart from ExternalName.</p>
<p>In the case of Kubernetes, CNI plugins are the only way to set up container networking (for Linux, it is possible not to use them).
They perform the actual communication with HNS and HCS in order to set up the selected networking mode. Kubernetes&rsquo; networking setup has one significant
difference when compared to the standard Docker networking setup: the container vNIC is attached to the pod infra container, and the network namespace is
shared between all containers in the Pod. This is the same concept as for Linux Pods.</p>
<h2 id="endpointslices">EndpointSlices</h2>
<p>From the official K8s documentation [3]. All network endpoints for a Service  were stored in a single Endpoints resource, those resources could get quite large.
That affected the performance of Kubernetes components (notably the master control plane) and resulted in significant amounts of network traffic
and processing when Endpoints changed. EndpointSlices help you mitigate those issues as well as provide an extensible
platform for additional features such as topological routing.
In Kubernetes, an EndpointSlice contains references to a set of network endpoints. The control plane automatically creates
EndpointSlices for any Kubernetes Service that has a selector specified. These EndpointSlices include references to all the Pods
that match the Service selector.
EndpointSlices group network endpoints together by unique combinations of protocol, port number, and Service name.</p>
<p><em>Windows kernel space uses listeners for endpointslices instead of endpoints.</em> The caching processing stays under <code>pkg/proxy/endpointslicecache.go</code>.</p>
<p>Getting the details of the endpointslice used on this post:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">discovery.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">EndpointSlice</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">whoami-windows-n2x5d</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">addressType</span>: <span style="color:#ae81ff">IPv4</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">endpoints</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">addresses</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">100.244.206.69</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">targetRef</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">whoami-windows-59cd7b4974-pjbq4</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">addresses</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">100.244.206.68</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">targetRef</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">whoami-windows-59cd7b4974-6hwph</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">addresses</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">100.244.206.70</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">targetRef</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">whoami-windows-59cd7b4974-gr6qg</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span></code></pre></div><h3 id="calico-vxlan-and-source-vip">Calico VXLAN and Source VIP</h3>
<p>Since Calico is being used and VXLAN overlay is required for Windows on this version, <strong>kube-proxy needs to know the source IP to use for SNAT operations.</strong>
This is set via Kube-proxy <em>&ndash;source-vip</em> and the Calico_ep IP address.
On <em>3.19.1</em> this configuration is <code>windows-packaging/CalicoWindows/kubernetes/kube-proxy-service.ps1</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>$network.Type -EQ <span style="color:#e6db74">&#34;Overlay&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Write-Host <span style="color:#e6db74">&#34;Detected VXLAN network, waiting for Calico host endpoint to be created...&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>-Not <span style="color:#f92672">(</span>Get-HnsEndpoint | ? Name -EQ <span style="color:#e6db74">&#34;Calico_ep&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Start-Sleep <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    Write-Host <span style="color:#e6db74">&#34;Host endpoint found.&#34;</span>
</span></span><span style="display:flex;"><span>    $sourceVip <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Get-HnsEndpoint | ? Name -EQ <span style="color:#e6db74">&#34;Calico_ep&#34;</span><span style="color:#f92672">)</span>.IpAddress  // 100.244.206.66
</span></span><span style="display:flex;"><span>    $argList +<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;--source-vip=</span>$sourceVip<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    $extraFeatures +<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;WinOverlay=true&#34;</span>    
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>It will be used later in the syncProxyRules.</p>
<h2 id="syncproxyrules-deep-dive">syncProxyRules deep dive</h2>
<p><img src="./images/sync-proxy.png?width=1024" alt="sync" title="sync"></p>
<p>Again this is the core sync proxy rules used by kproxy, it can be divided roughly in 3 parts, and it runs on a scheduled timed goroutine as well as when a
change occurs in OnServiceSynced and OnEndpointSliceSynced.</p>
<p>The first part represents the bootstrap and is responsible to:</p>
<ol>
<li>Check if the proxier is initialized.</li>
<li>Metrics for method latency measurement.</li>
<li>Check if the HNS network was changed or does not exist anymore (this network is created by the CNI). It cleans up ALL policies created.</li>
<li>Creates a list of stale UDP services merging endpoints services and service list.</li>
</ol>
<p>The middle core is responsible to add the corresponding policies for each service. The iteration on each service in the cluster occurs on a
list of <code>serviceInfo</code> cached objects:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#75715e">// ServiceInfo contains information and state for a particular proxied service
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">serviceInfo</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span><span style="color:#a6e22e">proxy</span>.<span style="color:#a6e22e">BaseServiceInfo</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">targetPort</span>             <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">externalIPs</span>            []<span style="color:#f92672">*</span><span style="color:#a6e22e">externalIPInfo</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">loadBalancerIngressIPs</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">loadBalancerIngressInfo</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">hnsID</span>                  <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">nodePorthnsID</span>          <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">policyApplied</span>          <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">remoteEndpoint</span>         <span style="color:#f92672">*</span><span style="color:#a6e22e">endpointsInfo</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">hns</span>                    <span style="color:#a6e22e">HostNetworkService</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">preserveDIP</span>            <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">localTrafficDSR</span>        <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The first step is to check if the policy is already applied for this service in the <code>policyApplied</code> boolean.
If the network is overlay a new REMOTE endpoint is created for the ClusterIP. HNS creates network namespaces
per container endpoints. <strong>A remote endpoint is created for services virtualIP as well on the sync function.</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#a6e22e">serviceVipEndpoint</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">hns</span>.<span style="color:#a6e22e">getEndpointByIpAddress</span>(<span style="color:#a6e22e">svcInfo</span>.<span style="color:#a6e22e">ClusterIP</span>().<span style="color:#a6e22e">String</span>(), <span style="color:#a6e22e">hnsNetworkName</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">serviceVipEndpoint</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">newHnsEndpoint</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">hns</span>.<span style="color:#a6e22e">createEndpoint</span>(<span style="color:#a6e22e">hnsEndpoint</span>, <span style="color:#a6e22e">hnsNetworkName</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">svcInfo</span>.<span style="color:#a6e22e">remoteEndpoint</span> = <span style="color:#a6e22e">newHNSEndpoint</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>You can check the existence of this endpoint via powershell utils.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ kubectl get svc -o wide
</span></span><span style="display:flex;"><span>NAME             TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>   AGE     SELECTOR
</span></span><span style="display:flex;"><span>whoami-windows   ClusterIP   10.99.234.145    &lt;none&gt;        80/TCP    3h27m   app<span style="color:#f92672">=</span>whoami-windows
</span></span></code></pre></div><p>Before applying the policy, a new remote endpoint is created for EVERY real endpoint, corresponding to the service.
Getting the existent endpoints for ClusterIP and the container&rsquo;s namespaces from the HNS API:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ Get-HNSEndpoint
</span></span><span style="display:flex;"><span>ID                  : 35F557C2-E194-4424-A021-113DBF8C5F2A
</span></span><span style="display:flex;"><span>IPAddress           : 10.99.234.145
</span></span><span style="display:flex;"><span>IsRemoteEndpoint    : True
</span></span><span style="display:flex;"><span>MacAddress          : 08:00:27:09:de:92
</span></span><span style="display:flex;"><span>Policies            : <span style="color:#f92672">{</span>@<span style="color:#f92672">{</span>PA<span style="color:#f92672">=</span>10.20.30.11; Type<span style="color:#f92672">=</span>PA<span style="color:#f92672">}}</span>
</span></span><span style="display:flex;"><span>Type                : Overlay
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ID                        : 028ABAED-7FF6-4FDC-992C-D3B004936BE0
</span></span><span style="display:flex;"><span>IPAddress                 : 100.244.206.68
</span></span><span style="display:flex;"><span>MacAddress                : 0E-2A-64-f4-ce-44
</span></span><span style="display:flex;"><span>Name                      : 39bd4d8edfb7aa8903b9c342121f17431755266470b98d30b36a5e7d7651d7c6_Calico
</span></span><span style="display:flex;"><span>Type                      : Overlay
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ID                        : E84BAD42-A6EE-40A8-8145-C9F084654774
</span></span><span style="display:flex;"><span>IPAddress                 : 100.244.206.69
</span></span><span style="display:flex;"><span>MacAddress                : 0E-2A-64-f4-ce-45
</span></span><span style="display:flex;"><span>Name                      : bc613b581d44343ec36170adac58050cea252667e9f1077cc41f8105213ad477_Calico
</span></span><span style="display:flex;"><span>Type                      : Overlay
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ID                        : 77C53BAC-A359-45CC-A663-541344EE505A
</span></span><span style="display:flex;"><span>IPAddress                 : 100.244.206.70
</span></span><span style="display:flex;"><span>MacAddress                : 0E-2A-64-f4-ce-46
</span></span><span style="display:flex;"><span>Name                      : 62d2b2d0f5678cd8e77c7ffcf30d0ccfb87cdd759d258084c418ac357a22f760_Calico
</span></span><span style="display:flex;"><span>Type                      : Overlay
</span></span></code></pre></div><p>Filtering out the logs in the Kube-proxy Load balancer Policy creation for the service we find out:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>I1219 08:24:31.456250    <span style="color:#ae81ff">3716</span> proxier.go:145<span style="color:#f92672">]</span> Hns loadbalancer policy resource, <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;ID&#34;</span>:<span style="color:#e6db74">&#34;a335d997-4160-44f9-9f72-1087a2cba45e&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;HostComputeEndpoints&#34;</span>:<span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;028abaed-7ff6-4fdc-992c-d3b004936be0&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;e84bad42-a6ee-40a8-8145-c9f084654774&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;77c53bac-a359-45cc-a663-541344ee505a&#34;</span><span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;SourceVIP&#34;</span>:<span style="color:#e6db74">&#34;100.244.206.66&#34;</span>, <span style="color:#e6db74">&#34;FrontendVIPs&#34;</span>:<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;10.99.234.145&#34;</span><span style="color:#f92672">]</span>, 
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;PortMappings&#34;</span>:<span style="color:#f92672">[{</span><span style="color:#e6db74">&#34;Protocol&#34;</span>:6,<span style="color:#e6db74">&#34;InternalPort&#34;</span>:8080,<span style="color:#e6db74">&#34;ExternalPort&#34;</span>:80<span style="color:#f92672">}]</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;SchemaVersion&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;Major&#34;</span>:2,<span style="color:#e6db74">&#34;Minor&#34;</span>:0<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>I1219 08:24:31.456250    <span style="color:#ae81ff">3716</span> proxier.go:1170<span style="color:#f92672">]</span> Hns LoadBalancer resource created <span style="color:#66d9ef">for</span> cluster ip resources 10.99.234.145, Id <span style="color:#f92672">[</span>a335d997-4160-44f9-9f72-1087a2cba45e<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>We can note the list of endpoints a SourceVIP from Calico Remote Endpoint (for SNAT) and FrontendVIPs to the actual Cluster IP.
Find out the HNS Policy list created, note the SourceVIP 100.244.206.66 from the Calico_ep:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>PS C:<span style="color:#ae81ff">\k</span>&gt; Get-HnsPolicyList -id A335D997-4160-44F9-9F72-1087A2CBA45E
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ActivityId       : FF1908A9-9B2C-4D07-AF3E-865688B344DD
</span></span><span style="display:flex;"><span>AdditionalParams :
</span></span><span style="display:flex;"><span>Health           : @<span style="color:#f92672">{</span>LastErrorCode<span style="color:#f92672">=</span>0; LastUpdateTime<span style="color:#f92672">=</span>132844046714528311<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>ID               : A335D997-4160-44F9-9F72-1087A2CBA45E
</span></span><span style="display:flex;"><span>IsApplied        : False
</span></span><span style="display:flex;"><span>Policies         : <span style="color:#f92672">{</span>@<span style="color:#f92672">{</span>ExternalPort<span style="color:#f92672">=</span>80; InternalPort<span style="color:#f92672">=</span>8080; Protocol<span style="color:#f92672">=</span>6; SourceVIP<span style="color:#f92672">=</span>100.244.206.66; Type<span style="color:#f92672">=</span>ELB; VIPs<span style="color:#f92672">=</span>System.Object<span style="color:#f92672">[]}}</span>        
</span></span><span style="display:flex;"><span>References       : <span style="color:#f92672">{</span>/endpoints/028abaed-7ff6-4fdc-992c-d3b004936be0, /endpoints/e84bad42-a6ee-40a8-8145-c9f084654774,
</span></span><span style="display:flex;"><span>                   /endpoints/77c53bac-a359-45cc-a663-541344ee505a<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>Resources        : @<span style="color:#f92672">{</span>AdditionalParams<span style="color:#f92672">=</span>; AllocationOrder<span style="color:#f92672">=</span>1; Allocators<span style="color:#f92672">=</span>System.Object<span style="color:#f92672">[]</span>; Health<span style="color:#f92672">=</span>;
</span></span><span style="display:flex;"><span>                   ID<span style="color:#f92672">=</span>FF1908A9-9B2C-4D07-AF3E-865688B344DD; PortOperationTime<span style="color:#f92672">=</span>0; State<span style="color:#f92672">=</span>1; SwitchOperationTime<span style="color:#f92672">=</span>0; VfpOperationTime<span style="color:#f92672">=</span>0<span style="color:#f92672">}</span>    
</span></span><span style="display:flex;"><span>State            : <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>Version          : <span style="color:#ae81ff">38654705666</span>
</span></span></code></pre></div><p>A few other Load balancer policies are created depending of the Service type.</p>
<ul>
<li>If nodePort is specified, user should be able to use nodeIP:nodePort to reach the backend endpoints</li>
<li>Create a Load Balancer Policy for each external IP</li>
<li>Create a Load Balancer Policy for each loadbalancer ingress</li>
</ul>
<p>The logic for choosing the SourceVIP in Overlay networks is based on the backend endpoints:</p>
<p>a) Endpoints are any IP&rsquo;s outside the cluster ==&gt; Choose NodeIP as the SourceVIP</p>
<p>b) Endpoints are IP addresses of a remote node =&gt; Choose NodeIP as the SourceVIP</p>
<p>c) Everything else (Local POD&rsquo;s, Remote POD&rsquo;s, Node IP of current node) ==&gt; Choose the configured SourceVIP</p>
<p>Finally the last part:</p>
<ol>
<li>Closes the measurement of the function latency.</li>
<li>Update services health checks</li>
<li>Finish housekeeping - TODO: check if is required to clean up stale services.</li>
<li>Remove stale endpoint reference counts</li>
</ol>
<h2 id="monitoring">Monitoring</h2>
<p>On Kubernetes 1.24 all endpoints and services metrics are available for windows kernel mode.</p>
<p><img src="./images/grafana.png?width=1024" alt="grafana" title="grafana"></p>
<h2 id="conclusion">Conclusion</h2>
<p>Definitely the mode is currently the state of art on Windows nodes both for CNIs and Proxies, it&rsquo;s a powerful way to manage
container networks and have been used for a long term. A few other interesting options are happening like eBPF for Windows [4]
or OVS based proxies like Antrea Proxy in the data plane.</p>
<p>Check the next proxy generation in the newest KPNG project at <a href="https://github.com/kubernetes-sigs/kpng">https://github.com/kubernetes-sigs/kpng</a></p>
<h2 id="references">References</h2>
<p>[1] <a href="https://www.packtpub.com/product/hands-on-kubernetes-on-windows/9781838821562">https://www.packtpub.com/product/hands-on-kubernetes-on-windows/9781838821562</a></p>
<p>[2] <a href="https://www.youtube.com/watch?v=tTZFoiLObX4">https://www.youtube.com/watch?v=tTZFoiLObX4</a></p>
<p>[3] <a href="https://techcommunity.microsoft.com/t5/networking-blog/direct-server-return-dsr-in-a-nutshell/ba-p/693710">https://techcommunity.microsoft.com/t5/networking-blog/direct-server-return-dsr-in-a-nutshell/ba-p/693710</a></p>
<p>[4] <a href="https://github.com/microsoft/ebpf-for-windows">https://github.com/microsoft/ebpf-for-windows</a></p>
<p>[5] <a href="https://kubernetes.io/docs/concepts/services-networking/endpoint-slices/">https://kubernetes.io/docs/concepts/services-networking/endpoint-slices/</a></p>





<footer class=" footline" >
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="/2021/" title="2021"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/2021/1127/" title="Kube-proxy Linux Userspace Mode" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1704047371"></script>
    <script src="/js/perfect-scrollbar.min.js?1704047371"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1704047371"></script>
    <script src="/js/jquery.sticky.js?1704047371"></script>
    <script src="/js/featherlight.min.js?1704047371"></script>
    <script src="/js/highlight.pack.js?1704047371"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1704047371"></script>
    <script src="/js/learn.js?1704047371"></script>
    <script src="/js/hugo-learn.js?1704047371"></script>
    
        
            <script src="/mermaid/mermaid.js?1704047371"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>
