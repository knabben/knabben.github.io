<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.112.7">
    <meta name="description" content="Automatic routing with BIRD">


    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Border Gateway Protocol (BGP) and Kubernetes :: compulsory thinking</title>

    
    <link href="/css/nucleus.css?1690294677" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1690294677" rel="stylesheet">
    <link href="/css/hybrid.css?1690294677" rel="stylesheet">
    <link href="/css/featherlight.min.css?1690294677" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1690294677" rel="stylesheet">
    <link href="/css/auto-complete.css?1690294677" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1690294677" rel="stylesheet">
    <link href="/css/theme.css?1690294677" rel="stylesheet">
    <link href="/css/tabs.css?1690294677" rel="stylesheet">
    <link href="/css/hugo-theme.css?1690294677" rel="stylesheet">
    
    <link href="/css/theme-blue.css?1690294677" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1690294677"></script>
      
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SXHZPRXGDZ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-SXHZPRXGDZ');
    </script>
    <script>
    if (location.host.indexOf("localhost") < 0 && location.protocol !== "https:") {
      location.protocol = "https:";
    }
    </script>
    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/2022/0610/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href='/'>
  <div id="header-logo"> OPS [SEC] </div>
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1690294677"></script>
<script type="text/javascript" src="/js/auto-complete.js?1690294677"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/opssec.in\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1690294677"></script>

    
  </div>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/2023/" title="2023" class="dd-item
        
        
        
        ">
      <a href="/2023/">
          2023
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/2023/0721/" title="Ztunnel SPIRE implementation" class="dd-item
        
        
        
        ">
      <a href="/2023/0721/">
          Ztunnel SPIRE implementation
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0702/" title="Waypoint Proxy for the app layer" class="dd-item
        
        
        
        ">
      <a href="/2023/0702/">
          Waypoint Proxy for the app layer
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0630/" title="Ztunnel on Ambient Mesh" class="dd-item
        
        
        
        ">
      <a href="/2023/0630/">
          Ztunnel on Ambient Mesh
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0628/" title="Istio CNI on Ambient Mesh" class="dd-item
        
        
        
        ">
      <a href="/2023/0628/">
          Istio CNI on Ambient Mesh
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0622/" title="Istio Ambient Service Mesh Demo" class="dd-item
        
        
        
        ">
      <a href="/2023/0622/">
          Istio Ambient Service Mesh Demo
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0611/" title="SPIFFE/SPIRE for gRPC authz" class="dd-item
        
        
        
        ">
      <a href="/2023/0611/">
          SPIFFE/SPIRE for gRPC authz
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0608/" title="Secure gRPC services with mTLS" class="dd-item
        
        
        
        ">
      <a href="/2023/0608/">
          Secure gRPC services with mTLS
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0406/" title="Windows CNI tracing and deep dive" class="dd-item
        
        
        
        ">
      <a href="/2023/0406/">
          Windows CNI tracing and deep dive
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0330/" title="Windows Containers and .NET apps" class="dd-item
        
        
        
        ">
      <a href="/2023/0330/">
          Windows Containers and .NET apps
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2023/0322/" title="Multi AZ on Kubernetes and vSphere" class="dd-item
        
        
        
        ">
      <a href="/2023/0322/">
          Multi AZ on Kubernetes and vSphere
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2022/" title="2022" class="dd-item
        parent
        
        
        ">
      <a href="/2022/">
          2022
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/2022/0712/" title="Hybrid nodes with ClusterClass on Amazon Web Service" class="dd-item
        
        
        
        ">
      <a href="/2022/0712/">
          Hybrid nodes with ClusterClass on Amazon Web Service
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2022/0610/" title="Border Gateway Protocol (BGP) and Kubernetes" class="dd-item
        
        active
        
        ">
      <a href="/2022/0610/">
          Border Gateway Protocol (BGP) and Kubernetes
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2022/0320/" title="Cluster API Provider for Azure" class="dd-item
        
        
        
        ">
      <a href="/2022/0320/">
          Cluster API Provider for Azure
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2022/0122/" title="Kube-Proxy Next Gen Windows Userspace" class="dd-item
        
        
        
        ">
      <a href="/2022/0122/">
          Kube-Proxy Next Gen Windows Userspace
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2021/" title="2021" class="dd-item
        
        
        
        ">
      <a href="/2021/">
          2021
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/2021/1218/" title="Kube-proxy Windows Kernelspace Mode" class="dd-item
        
        
        
        ">
      <a href="/2021/1218/">
          Kube-proxy Windows Kernelspace Mode
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2021/1127/" title="Kube-proxy Linux Userspace Mode" class="dd-item
        
        
        
        ">
      <a href="/2021/1127/">
          Kube-proxy Linux Userspace Mode
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2021/1017/" title="Kube-proxy Winuserspace Mode" class="dd-item
        
        
        
        ">
      <a href="/2021/1017/">
          Kube-proxy Winuserspace Mode
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2021/0903/" title="Windows and Calico overlay networking" class="dd-item
        
        
        
        ">
      <a href="/2021/0903/">
          Windows and Calico overlay networking
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2021/0828/" title="CNI plugins and kindnet" class="dd-item
        
        
        
        ">
      <a href="/2021/0828/">
          CNI plugins and kindnet
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2021/0614/" title="Kube-proxy ClusterIP" class="dd-item
        
        
        
        ">
      <a href="/2021/0614/">
          Kube-proxy ClusterIP
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2021/0228/" title="Kubernetes Windows Nodes" class="dd-item
        
        
        
        ">
      <a href="/2021/0228/">
          Kubernetes Windows Nodes
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
        
    </ul>

    
    

    
    <section id="footer">
      <center>
  <p><b>Amim Knabben</b> - 2023</p>
    amim.knabben@gmail.com
  <br/>
  <a href="https://github.com/knabben"><i class="fab fa-github"></i></a>
  <a href="https://twitter.com/ak_ndb"><i class="fab fa-twitter"></i></a>
  <a href="https://linkedin.com/in/amim"><i class="fab fa-linkedin"></i></a>
</center>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/'></a> > <a href='/2022/'>2022</a> > Border Gateway Protocol (BGP) and Kubernetes
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#bgp-protocol">BGP protocol</a></li>
    <li><a href="#openbgp-and-openbsd">OpenBGP and OpenBSD</a></li>
    <li><a href="#calico-cni-and-bgp-mode">Calico CNI and BGP mode</a>
      <ul>
        <li><a href="#debugging-routes">Debugging routes</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Border Gateway Protocol (BGP) and Kubernetes
            </h1>
          

        



	<h2 id="introduction">Introduction</h2>
<p>On this post I want to write a bit about Border Gateway Protocol, Calico and Kubernetes, in the examples
we are going to see an use case  with OpenBSD/openbgp and after Project Calico with BGP mode to illustrate
how this protocol can be used in the CNI to provide automatic routing across nodes.</p>
<p>After reading leave comments in the end and share the post. Nuff said.</p>
<h2 id="bgp-protocol">BGP protocol</h2>
<p>The <a href="https://www.rfc-editor.org/rfc/rfc4271">RFC</a> of BGP-4 is pretty clear in the abstract about the primary function of BGP being
is to exchange network reachability information with other BGP systems.  This network reachability
information includes information on the list of Autonomous Systems (ASes) that reachability information traverses.</p>
<p>This information is sufficient for constructing a graph of AS connectivity for this reachability from which routing
loops may be pruned, and, at the AS level, some policy decisions may be enforced.</p>
<p>BGP-4 provides a set of mechanisms for supporting Classless Inter-Domain Routing (CIDR).  These mechanisms include
support for advertising a set of destinations as an IP prefix, and eliminating the concept of network &ldquo;class&rdquo; within BGP.
BGP-4 also introduces mechanisms that allow aggregation of routes, including aggregation of AS paths.</p>
<p>Meaning we can create automated routing across routers that can communicate with each other.</p>
<p>From the Wikipedia: An autonomous system (AS) is a collection of connected Internet Protocol routing prefixes under the control
of one or more network operators on behalf of a single administrative entity or domain, that presents a common and
clearly defined routing policy to the Internet.</p>
<p>The reason for this separation is the lack of scalability and routing policies if one entity only was created, for
this reason routers inside an AS can have their own protocol specifications. IGP route between routes, EGP route between
AS and BGP route among/between AS. ASN (numbers) are unique identifiers with 1-64511 being public ones.</p>
<p>There is no requirement for networks running BGP to have an IGP as well. Simple multihomed networks with two routers
run just fine without an IGP: a few static routes are all that’s needed, because all traffic goes to a
directly connected network, to the rest of the world, or to the other router. For larger networks, IGPs
are a fact of life. Your only choice for an EGP is BGP-4, but IGPs let you use any interior routing protocol
you desire. On a Cisco router, you have the following choices: RIP, IGRP, EIGRP, OSPF, and IS-IS.</p>
<p>About the procotol and accordingly with <a href="https://www.amazon.com/BGP-Iljitsch-Van-Beijnum/dp/0596002548">this book</a> BGP uses TCP on port 179 for communication between neighbors. This is unusual:
all other routing protocols either run directly on top of IP or use UDP.</p>
<p>This makes it possible to send broadcasts or multicasts to discover neighboring routers. When BGP neighbors establish
a TCP session, they start exchanging BGP information in the form of &ldquo;messages.&rdquo;</p>
<p>These messages can have a few formats, that we will analyze better later:</p>
<ul>
<li>Open - After a TCP connection is established, the first message sent by each side is an OPEN message, if the Open message is acceptable, a KEEPALICE message confirming the OPEn is sent back.</li>
<li>Update -  Are used to transfer routing information between BGP peers.  The information in the UPDATE message can be used to construct a graph that describes the relationships of the various Autonomous Systems.</li>
<li>Keepalive -  BGP does not use any TCP-based, keep-alive mechanism to determine if peers are reachable.  Instead, KEEPALIVE messages are exchanged between peers often enough not to cause the Hold Timer to expire.</li>
<li>Notification - A message is sent when an error condition is detected. The BGP connection is closed immediately after it is sent.</li>
</ul>
<p>Besides that BGP has Finite State Machine with Idle, Connect, Active, OpenSent, OpenConfirm, Established.</p>
<h2 id="openbgp-and-openbsd">OpenBGP and OpenBSD</h2>
<p>Enough theory, bootup your <code>install71.iso</code>, for this lab you will need 2 machines that can at least ping each other.</p>
<p><img src="./images/diagram1.jpg?width=800px" alt="BGP" title="BGP"></p>
<table>
<thead>
<tr>
<th>Machine</th>
<th>IP address</th>
<th>ASN</th>
</tr>
</thead>
<tbody>
<tr>
<td>r1</td>
<td>10.191.254.108/16</td>
<td>65001</td>
</tr>
<tr>
<td>r2</td>
<td>10.191.254.203/16</td>
<td>65002</td>
</tr>
</tbody>
</table>
<p>The following <code>/etc/bgpd.conf</code> files from both OpenBSD routers</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># r1</span>
</span></span><span style="display:flex;"><span>ASN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;65001&#34;</span>
</span></span><span style="display:flex;"><span>AS $ASN
</span></span><span style="display:flex;"><span>router-id 10.191.245.108
</span></span><span style="display:flex;"><span>prefix-set networks <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        172.15.0.0/16
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>include <span style="color:#e6db74">&#34;/var/db/rpki-client/openbgpd&#34;</span>
</span></span><span style="display:flex;"><span>network prefix-set networks set large-community $ASN:1:1
</span></span><span style="display:flex;"><span>group <span style="color:#e6db74">&#34;upstreams&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        neighbor 10.191.254.203 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                remote-as <span style="color:#ae81ff">65002</span>
</span></span><span style="display:flex;"><span>                descr <span style="color:#e6db74">&#34;r2&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># r2</span>
</span></span><span style="display:flex;"><span>ASN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;65002&#34;</span>
</span></span><span style="display:flex;"><span>AS $ASN
</span></span><span style="display:flex;"><span>router-id 10.191.254.203
</span></span><span style="display:flex;"><span>prefix-set networks <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>prefix-set network <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    172.16.0.0/16
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>network prefix-set network set large-community $ASN:1:1
</span></span><span style="display:flex;"><span>group <span style="color:#e6db74">&#34;upstreams&#34;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        neighbor 10.191.245.108 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                remote-as <span style="color:#ae81ff">65001</span>
</span></span><span style="display:flex;"><span>                descr <span style="color:#e6db74">&#34;r1&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Respectively we have as outside networks from the AS, 172.15.0.0/16 connected on R1 and 172.16.0.0/16 on R2,
as you can see there&rsquo;s the need to create groups and add neighbors, the protocol won&rsquo;t multicast to find the peers.</p>
<p>Start the services <code>/etc/rc.d/bgpd start</code> and check the routes added, you need to add the route to the outside network
on each end. 10.191.249.1 and 10.191.249.2 are the gateways for each network.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>r1&gt; route add -inet 172.15.0.0/16 10.191.249.1
</span></span><span style="display:flex;"><span>add net 172.15.0.0/16: gateway 10.191.249.1
</span></span><span style="display:flex;"><span>r1&gt; route -n show
</span></span><span style="display:flex;"><span>Routing tables
</span></span><span style="display:flex;"><span>Internet:
</span></span><span style="display:flex;"><span>Destination        Gateway            Flags   Refs      Use   Mtu  Prio Iface
</span></span><span style="display:flex;"><span>default            10.191.255.254     UGS        <span style="color:#ae81ff">6</span>    <span style="color:#ae81ff">18731</span>     -     <span style="color:#ae81ff">8</span> em0
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>172.16/16          10.191.254.203     UG         <span style="color:#ae81ff">0</span>        <span style="color:#ae81ff">0</span>     -    <span style="color:#ae81ff">48</span> em0
</span></span><span style="display:flex;"><span>172.15/16          10.191.249.1       UG         <span style="color:#ae81ff">0</span>        <span style="color:#ae81ff">0</span>     -    <span style="color:#ae81ff">48</span> em0
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>r2&gt; route add -inet 172.16.0.0/16 10.191.249.2
</span></span><span style="display:flex;"><span>add net 172.16.0.0/16: gateway 10.191.249.2
</span></span><span style="display:flex;"><span>r2&gt; route -n show
</span></span><span style="display:flex;"><span>Routing tables
</span></span><span style="display:flex;"><span>Destination        Gateway            Flags   Refs      Use   Mtu  Prio Iface
</span></span><span style="display:flex;"><span>default            10.191.255.254     UGS        <span style="color:#ae81ff">5</span>   <span style="color:#ae81ff">125326</span>     -     <span style="color:#ae81ff">8</span> em0
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>172.15/16          10.191.245.108     UG         <span style="color:#ae81ff">0</span>        <span style="color:#ae81ff">0</span>     -    <span style="color:#ae81ff">48</span> em0
</span></span><span style="display:flex;"><span>172.16/16          10.191.249.2      UGS        <span style="color:#ae81ff">0</span>        <span style="color:#ae81ff">0</span>     -     <span style="color:#ae81ff">8</span> em0
</span></span><span style="display:flex;"><span>r2&gt; bgpctl show rib neighbor <span style="color:#e6db74">&#34;r1&#34;</span> in
</span></span><span style="display:flex;"><span>flags: * <span style="color:#f92672">=</span> Valid, &gt; <span style="color:#f92672">=</span> Selected, I <span style="color:#f92672">=</span> via IBGP, A <span style="color:#f92672">=</span> Announced,
</span></span><span style="display:flex;"><span>       S <span style="color:#f92672">=</span> Stale, E <span style="color:#f92672">=</span> Error
</span></span><span style="display:flex;"><span>origin validation state: N <span style="color:#f92672">=</span> not-found, V <span style="color:#f92672">=</span> valid, ! <span style="color:#f92672">=</span> invalid
</span></span><span style="display:flex;"><span>origin: i <span style="color:#f92672">=</span> IGP, e <span style="color:#f92672">=</span> EGP, ? <span style="color:#f92672">=</span> Incomplete
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flags ovs destination          gateway          lpref   med aspath origin
</span></span><span style="display:flex;"><span>*       N 172.15.0.0/16        10.191.245.108    <span style="color:#ae81ff">100</span>     <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">65001</span> i
</span></span></code></pre></div><p>That&rsquo;s great both hosts added the routes, and you can see the messages been exchanged from this wireshark diagram, basically
r2 started a connection and the daemon on r1 wasn&rsquo;t running (that&rsquo;s why it receive a RST/ACK), a few seconds later r1
started the daemon after fixing the configuration file, the first PSH is an Open message from r1, the message is
acked and a keep alive was received.</p>
<p><img src="./images/wireshark1.png" alt="Wireshark" title="Wireshark"></p>
<p>The UPDATES are for route exchange, you can see the second UPDATE decoded here, r2 exchange with AS_PATH attribute 65002,
NEXT_HOP being it&rsquo;s IP. The RFC has more details of these properties:</p>
<p><img src="./images/wireshark2.png" alt="Wireshark" title=".Wireshark"></p>
<h2 id="calico-cni-and-bgp-mode">Calico CNI and BGP mode</h2>
<p>What about Kubernetes? Where does BGP is used? Well, it&rsquo;s possible to configure BGP (Border Gateway Protocol) between
Calico nodes or peering with network infrastructure to distribute routing information. When BGP is enabled, Calico’s
default behavior is to create a full-mesh of internal BGP (iBGP) connections where each node peers with each other.</p>
<p>This allows Calico to operate over any L2 network, whether public cloud or private cloud, or, if IPIP is configured,
to operate as an overlay over any network that does not block IPIP traffic. Calico does not use BGP for <a href="https://projectcalico.docs.tigera.io/networking/bgp">VXLAN overlays</a> And for this propose no encapsulation will be used.</p>
<p>Too much? not yet&hellip; Josh <a href="https://www.youtube.com/watch?v=MpbIZ1SmEkU">explains</a> on this video the modes and encapsulation of Calico. Some other good resources
<a href="https://www.youtube.com/watch?v=vOo__3GqyxM">includes</a>, the entire series <code>Understanding Kubernetes Networking</code> is worth. More than 4 hours of free content in the
Internet move your lazy ass!</p>
<p>How the routing normally works for non BGP CNIs? Nodes have a podCIDR and the CNI can use <code>github.com/vishvananda/netlink</code>
libraries like this to manage the routing based on these CRDs fields. What is normally achieved in an agent running on
a daemonset.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Node</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podCIDR</span>: <span style="color:#ae81ff">100.10.1.0</span><span style="color:#ae81ff">/24</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podCIDRs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">100.10.1.0</span><span style="color:#ae81ff">/24</span>
</span></span></code></pre></div><p>A lot of other projects allow you to do these connections including FRRouting and BIRD, being the second used
by Calico in the agent. Make sure you are configuring bgp and BIRD connection, in the example we are using IP in IP
as an encapsulation.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#e6db74">`</span>curl https://projectcalico.docs.tigera.io/manifests/calico.yaml -O<span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Use Kubernetes API as the backing datastore.</span>
</span></span><span style="display:flex;"><span>- name: DATASTORE_TYPE
</span></span><span style="display:flex;"><span>  value: <span style="color:#e6db74">&#34;kubernetes&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Choose the backend to use.</span>
</span></span><span style="display:flex;"><span>- name: CALICO_NETWORKING_BACKEND
</span></span><span style="display:flex;"><span>  value: <span style="color:#e6db74">&#34;bird&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Cluster type to identify the deployment type</span>
</span></span><span style="display:flex;"><span>- name: CLUSTER_TYPE
</span></span><span style="display:flex;"><span>  value: <span style="color:#e6db74">&#34;k8s,bgp&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Enable IPIP</span>
</span></span><span style="display:flex;"><span>- name: CALICO_IPV4POOL_IPIP
</span></span><span style="display:flex;"><span>  value: <span style="color:#e6db74">&#34;Always&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Enable or Disable VXLAN on the default IP pool.</span>
</span></span><span style="display:flex;"><span>- name: CALICO_IPV4POOL_VXLAN
</span></span><span style="display:flex;"><span>  value: <span style="color:#e6db74">&#34;Never&#34;</span>
</span></span></code></pre></div><h3 id="debugging-routes">Debugging routes</h3>
<p>On this new scenario we have 3 nodes, in the IPPool range of 10.244.0.0/16 split as follow:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>❯ calicoctl ipam check
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Found <span style="color:#ae81ff">4</span> IPAM blocks.
</span></span><span style="display:flex;"><span> IPAM block 10.244.110.128/26 affinity<span style="color:#f92672">=</span>host:kind-worker2:
</span></span><span style="display:flex;"><span> IPAM block 10.244.162.128/26 affinity<span style="color:#f92672">=</span>host:kind-worker:
</span></span><span style="display:flex;"><span> IPAM block 10.244.195.192/26 affinity<span style="color:#f92672">=</span>host:kind-worker3:
</span></span><span style="display:flex;"><span> IPAM block 10.244.82.0/26 affinity<span style="color:#f92672">=</span>host:kind-control-plane:
</span></span><span style="display:flex;"><span>IPAM blocks record <span style="color:#ae81ff">8</span> allocations.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Loading all IPAM pools...
</span></span><span style="display:flex;"><span>  10.244.0.0/16
</span></span><span style="display:flex;"><span>Found <span style="color:#ae81ff">1</span> active IP pools.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>❯ calicoctl ipam show
</span></span><span style="display:flex;"><span>+----------+---------------+-----------+------------+--------------+
</span></span><span style="display:flex;"><span>| GROUPING |     CIDR      | IPS TOTAL | IPS IN USE |   IPS FREE   |
</span></span><span style="display:flex;"><span>+----------+---------------+-----------+------------+--------------+
</span></span><span style="display:flex;"><span>| IP Pool  | 10.244.0.0/16 |     <span style="color:#ae81ff">65536</span> | <span style="color:#ae81ff">8</span> <span style="color:#f92672">(</span>0%<span style="color:#f92672">)</span>     | <span style="color:#ae81ff">65528</span> <span style="color:#f92672">(</span>100%<span style="color:#f92672">)</span> |
</span></span><span style="display:flex;"><span>+----------+---------------+-----------+------------+--------------+
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>❯ kubectl get nodes -o wide
</span></span><span style="display:flex;"><span>NAME                 STATUS   ROLES           AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE       KERNEL-VERSION                       CONTAINER-RUNTIME
</span></span><span style="display:flex;"><span>kind-control-plane   Ready    control-plane   8m15s   v1.24.0   172.18.0.5    &lt;none&gt;        Ubuntu 21.10   5.10.102.1-microsoft-standard-WSL2   containerd://1.6.4
</span></span><span style="display:flex;"><span>kind-worker          Ready    &lt;none&gt;          7m41s   v1.24.0   172.18.0.3    &lt;none&gt;        Ubuntu 21.10   5.10.102.1-microsoft-standard-WSL2   containerd://1.6.4
</span></span><span style="display:flex;"><span>kind-worker2         Ready    &lt;none&gt;          7m41s   v1.24.0   172.18.0.2    &lt;none&gt;        Ubuntu 21.10   5.10.102.1-microsoft-standard-WSL2   containerd://1.6.4
</span></span><span style="display:flex;"><span>kind-worker3         Ready    &lt;none&gt;          7m41s   v1.24.0   172.18.0.4    &lt;none&gt;        Ubuntu 21.10   5.10.102.1-microsoft-standard-WSL2   containerd://1.6.4
</span></span></code></pre></div><p>If we get the status of the node <code>kind-worker</code> 172.18.0.3, we can see the neighbors, listing the routes
we can get 10.244.82.0/16 via 172.18.0.5, that&rsquo;s the controlplane host as we see the tunl0 interface is used
meaning the traffic is being encapsulated, when l2bridge is active it would go via eth0 in the physical
interface. The same is true for the other ranges.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@kind-worker:/# calicoctl node status
</span></span><span style="display:flex;"><span>Calico process is running.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>IPv4 BGP status
</span></span><span style="display:flex;"><span>+--------------+-------------------+-------+----------+-------------+
</span></span><span style="display:flex;"><span>| PEER ADDRESS |     PEER TYPE     | STATE |  SINCE   |    INFO     |
</span></span><span style="display:flex;"><span>+--------------+-------------------+-------+----------+-------------+
</span></span><span style="display:flex;"><span>| 172.18.0.5   | node-to-node mesh | up    | 23:52:12 | Established |
</span></span><span style="display:flex;"><span>| 172.18.0.2   | node-to-node mesh | up    | 23:52:12 | Established |
</span></span><span style="display:flex;"><span>| 172.18.0.4   | node-to-node mesh | up    | 23:52:11 | Established |
</span></span><span style="display:flex;"><span>+--------------+-------------------+-------+----------+-------------+
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>IPv6 BGP status
</span></span><span style="display:flex;"><span>No IPv6 peers found.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@kind-worker:/# ip route
</span></span><span style="display:flex;"><span>default via 172.18.0.1 dev eth0
</span></span><span style="display:flex;"><span>10.244.82.0/26 via 172.18.0.5 dev tunl0 proto bird onlink
</span></span><span style="display:flex;"><span>10.244.110.128/26 via 172.18.0.2 dev tunl0 proto bird onlink
</span></span><span style="display:flex;"><span>blackhole 10.244.162.128/26 proto bird
</span></span><span style="display:flex;"><span>10.244.195.192/26 via 172.18.0.4 dev tunl0 proto bird onlink
</span></span><span style="display:flex;"><span>172.18.0.0/16 dev eth0 proto kernel scope link src 172.18.0.3
</span></span></code></pre></div><p>Running a pod on <code>kind-worker3</code> on 10.244.195.194, what is in (195.192) range and is given by the IPAM plugin,
will redirect the traffic to the node as the next hop, remember this is a container running in the node
(on another IP in the network namespace), as soon the node receives the packet it forward to the Pod
via <code>caliba2160f804b</code> interface.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt; kubectl get pods -o wide
</span></span><span style="display:flex;"><span>default              nginx3                                       1/1     Running   <span style="color:#ae81ff">0</span>          11s   10.244.195.194   kind-worker3         &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@kind-worker3:/# ip route
</span></span><span style="display:flex;"><span>10.244.82.0/26 via 172.18.0.5 dev tunl0 proto bird onlink
</span></span><span style="display:flex;"><span>10.244.110.128/26 via 172.18.0.2 dev tunl0 proto bird onlink
</span></span><span style="display:flex;"><span>10.244.162.128/26 via 172.18.0.3 dev tunl0 proto bird onlink
</span></span><span style="display:flex;"><span>10.244.195.194 dev <span style="color:#e6db74">`</span>caliba2160f804b<span style="color:#e6db74">`</span> scope link
</span></span></code></pre></div><p>If we check the agent BIRDipv4 configuration on <code>cat /etc/calico/confd/config/bird.cfg</code>, we can find the peers</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>router id 172.18.0.3;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># For peer /host/kind-control-plane/ip_addr_v4</span>
</span></span><span style="display:flex;"><span>protocol bgp Mesh_172_18_0_5 from bgp_template <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  neighbor 172.18.0.5 as 64512;
</span></span><span style="display:flex;"><span>  source address 172.18.0.3;  <span style="color:#75715e"># The local address we use for the TCP connection</span>
</span></span><span style="display:flex;"><span>  passive on; <span style="color:#75715e"># Mesh is unidirectional, peer will connect to us.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># For peer /host/kind-worker/ip_addr_v4</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Skipping ourselves (172.18.0.3)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># For peer /host/kind-worker2/ip_addr_v4</span>
</span></span><span style="display:flex;"><span>protocol bgp Mesh_172_18_0_2 from bgp_template <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  neighbor 172.18.0.2 as 64512;
</span></span><span style="display:flex;"><span>  source address 172.18.0.3;  <span style="color:#75715e"># The local address we use for the TCP connection</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># For peer /host/kind-worker3/ip_addr_v4</span>
</span></span><span style="display:flex;"><span>protocol bgp Mesh_172_18_0_4 from bgp_template <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  neighbor 172.18.0.4 as 64512;
</span></span><span style="display:flex;"><span>  source address 172.18.0.3;  <span style="color:#75715e"># The local address we use for the TCP connection</span>
</span></span><span style="display:flex;"><span>  passive on; <span style="color:#75715e"># Mesh is unidirectional, peer will connect to us.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>One last try, listening tshark from the <code>kind-worker3</code> we will delete the calico-node agent in the control-plane
node 172.18.0.5. A connection is kept across all nodes with the bird daemon on this port, and as soon the connection is closed
a new retry happens with the protocol OPEN and UPDATE messages.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@kind-worker3:/# lsof -i :179
</span></span><span style="display:flex;"><span>COMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
</span></span><span style="display:flex;"><span>bird    <span style="color:#ae81ff">12294</span> root    7u  IPv4 <span style="color:#ae81ff">351376</span>      0t0  TCP *:bgp <span style="color:#f92672">(</span>LISTEN<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>bird    <span style="color:#ae81ff">12294</span> root    8u  IPv4 <span style="color:#ae81ff">366653</span>      0t0  TCP kind-worker3:bgp-&gt;kind-control-plane.kind:58325 <span style="color:#f92672">(</span>ESTABLISHED<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>bird    <span style="color:#ae81ff">12294</span> root    9u  IPv4 <span style="color:#ae81ff">351408</span>      0t0  TCP kind-worker3:52953-&gt;kind-worker.kind:bgp <span style="color:#f92672">(</span>ESTABLISHED<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>bird    <span style="color:#ae81ff">12294</span> root   10u  IPv4 <span style="color:#ae81ff">351409</span>      0t0  TCP kind-worker3:35655-&gt;kind-worker2.kind:bgp <span style="color:#f92672">(</span>ESTABLISHED<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@kind-worker3:/# tshark -i any <span style="color:#e6db74">&#34;port 179&#34;</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">1</span> 0.000000000   172.18.0.5 ? 172.18.0.4   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">58325</span> ? <span style="color:#ae81ff">179</span> <span style="color:#f92672">[</span>FIN, ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">502</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">820590145</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">888352057</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">2</span> 0.000126600   172.18.0.4 ? 172.18.0.5   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">179</span> ? <span style="color:#ae81ff">58325</span> <span style="color:#f92672">[</span>FIN, ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">510</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">888379111</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">820590145</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">3</span> 0.000155500   172.18.0.5 ? 172.18.0.4   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">58325</span> ? <span style="color:#ae81ff">179</span> <span style="color:#f92672">[</span>ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">502</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">820590145</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">888379111</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">4</span> 7.368669600   172.18.0.5 ? 172.18.0.4   TCP <span style="color:#ae81ff">76</span> <span style="color:#ae81ff">48333</span> ? <span style="color:#ae81ff">179</span> <span style="color:#f92672">[</span>SYN<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">64240</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> MSS<span style="color:#f92672">=</span><span style="color:#ae81ff">1460</span> SACK_PERM<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">820597513</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> WS<span style="color:#f92672">=</span><span style="color:#ae81ff">128</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">5</span> 7.368690500   172.18.0.4 ? 172.18.0.5   TCP <span style="color:#ae81ff">76</span> <span style="color:#ae81ff">179</span> ? <span style="color:#ae81ff">48333</span> <span style="color:#f92672">[</span>SYN, ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">65160</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> MSS<span style="color:#f92672">=</span><span style="color:#ae81ff">1460</span> SACK_PERM<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">888386479</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">820597513</span> WS<span style="color:#f92672">=</span><span style="color:#ae81ff">128</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">6</span> 7.368718300   172.18.0.5 ? 172.18.0.4   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">48333</span> ? <span style="color:#ae81ff">179</span> <span style="color:#f92672">[</span>ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">64256</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">820597513</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">888386479</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">7</span> 7.368810900   172.18.0.4 ? 172.18.0.5   BGP <span style="color:#ae81ff">131</span> OPEN Message
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">8</span> 7.368830600   172.18.0.5 ? 172.18.0.4   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">48333</span> ? <span style="color:#ae81ff">179</span> <span style="color:#f92672">[</span>ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">64256</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">820597513</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">888386479</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">9</span> 7.368979900   172.18.0.5 ? 172.18.0.4   BGP <span style="color:#ae81ff">131</span> OPEN Message
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">10</span> 7.368987300   172.18.0.4 ? 172.18.0.5   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">179</span> ? <span style="color:#ae81ff">48333</span> <span style="color:#f92672">[</span>ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">65280</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">888386480</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">820597514</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">11</span> 7.369079500   172.18.0.4 ? 172.18.0.5   BGP <span style="color:#ae81ff">87</span> KEEPALIVE Message
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">12</span> 7.369096000   172.18.0.5 ? 172.18.0.4   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">48333</span> ? <span style="color:#ae81ff">179</span> <span style="color:#f92672">[</span>ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">83</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">64256</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">820597514</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">888386480</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">13</span> 7.369186800   172.18.0.5 ? 172.18.0.4   BGP <span style="color:#ae81ff">87</span> KEEPALIVE Message
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">14</span> 7.369193000   172.18.0.4 ? 172.18.0.5   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">179</span> ? <span style="color:#ae81ff">48333</span> <span style="color:#f92672">[</span>ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">83</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">83</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">65280</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">888386480</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">820597514</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">15</span> 7.369343300   172.18.0.4 ? 172.18.0.5   BGP <span style="color:#ae81ff">121</span> UPDATE Message
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">16</span> 7.369366400   172.18.0.5 ? 172.18.0.4   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">48333</span> ? <span style="color:#ae81ff">179</span> <span style="color:#f92672">[</span>ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">83</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">136</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">64256</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">820597514</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">888386480</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">17</span> 7.369381600   172.18.0.4 ? 172.18.0.5   BGP <span style="color:#ae81ff">91</span> UPDATE Message
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">18</span> 7.369393900   172.18.0.5 ? 172.18.0.4   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">48333</span> ? <span style="color:#ae81ff">179</span> <span style="color:#f92672">[</span>ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">83</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">159</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">64256</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">820597514</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">888386480</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">19</span> 8.370730900   172.18.0.5 ? 172.18.0.4   BGP <span style="color:#ae81ff">121</span> UPDATE Message
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">20</span> 8.370766100   172.18.0.4 ? 172.18.0.5   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">179</span> ? <span style="color:#ae81ff">48333</span> <span style="color:#f92672">[</span>ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">159</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">136</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">65280</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">888387481</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">820598515</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">21</span> 8.370781900   172.18.0.5 ? 172.18.0.4   BGP <span style="color:#ae81ff">91</span> UPDATE Message
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">22</span> 8.370785500   172.18.0.4 ? 172.18.0.5   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">179</span> ? <span style="color:#ae81ff">48333</span> <span style="color:#f92672">[</span>ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">159</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">159</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">65280</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">888387481</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">820598515</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">23</span> 30.522048400   172.18.0.2 ? 172.18.0.4   BGP <span style="color:#ae81ff">87</span> KEEPALIVE Message
</span></span><span style="display:flex;"><span>   <span style="color:#ae81ff">24</span> 30.522091300   172.18.0.4 ? 172.18.0.2   TCP <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">35655</span> ? <span style="color:#ae81ff">179</span> <span style="color:#f92672">[</span>ACK<span style="color:#f92672">]</span> Seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> Ack<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span> Win<span style="color:#f92672">=</span><span style="color:#ae81ff">502</span> Len<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> TSval<span style="color:#f92672">=</span><span style="color:#ae81ff">2977307332</span> TSecr<span style="color:#f92672">=</span><span style="color:#ae81ff">3831078776</span>
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>And why should I care? Routing is fun and the next time another <a href="https://blog.cloudflare.com/october-2021-facebook-outage/">social media</a> site is shutdown by route
withdraws you can at least understand the post-mortem. Go get it!</p>





<footer class=" footline" >
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="/2022/0712/" title="Hybrid nodes with ClusterClass on Amazon Web Service"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/2022/0320/" title="Cluster API Provider for Azure" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1690294677"></script>
    <script src="/js/perfect-scrollbar.min.js?1690294677"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1690294677"></script>
    <script src="/js/jquery.sticky.js?1690294677"></script>
    <script src="/js/featherlight.min.js?1690294677"></script>
    <script src="/js/highlight.pack.js?1690294677"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1690294677"></script>
    <script src="/js/learn.js?1690294677"></script>
    <script src="/js/hugo-learn.js?1690294677"></script>
    
        
            <script src="/mermaid/mermaid.js?1690294677"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>
